<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CRM 2N ‚Äì Proyectos</title>

    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
    <!-- NAV SUPERIOR -->
    <div class="topnav">
        <div class="logo">CRM 2N</div>

        <div class="nav-tabs">
            <div class="nav-item" onclick="location.href='index.html'">Dashboard</div>
            <div class="nav-item active" onclick="location.href='proyectos.html'">Proyectos</div>
            <div class="nav-item" onclick="location.href='buscar.html'">Buscar</div>
            <div class="nav-item" onclick="location.href='pipeline.html'">Pipeline</div>
            <div class="nav-item" onclick="location.href='clientes.html'">Clientes</div>
            <div class="nav-item" onclick="location.href='tareas.html'">Tareas</div>
            <div class="nav-item" onclick="location.href='reportes.html'">Reportes</div>
        </div>

        <input type="text" class="search-box" placeholder="Buscar..." />
    </div>

    <main class="content">
        <h2 style="margin-top:0; margin-bottom:4px; color:#16325C;">Proyectos</h2>
        <div style="font-size:12px;color:#5A6872;margin-bottom:14px;">
            Vista general en tabla ¬∑ Filtra, selecciona, edita, borra o importa proyectos desde Excel (Prompt / Construdata)
        </div>

        <!-- FILTROS -->
        <div class="filters-row">
            <select id="fCiudad" class="select-input">
                <option value="Todas">Ciudad: todas</option>
            </select>
            <select id="fEstado" class="select-input">
                <option value="Todos">Estado: todos</option>
            </select>
            <select id="fTipo" class="select-input">
                <option value="Todos">Tipo: todos</option>
            </select>
            <select id="fPrioridad" class="select-input">
                <option value="Todas">Prioridad: todas</option>
            </select>
            <select id="fEncaje2N" class="select-input">
                <option value="Todos">Encaje 2N: todos</option>
                <option value="ALTO">Encaje 2N: ALTO</option>
                <option value="MEDIO">Encaje 2N: MEDIO</option>
                <option value="BAJO">Encaje 2N: BAJO</option>
                <option value="SIN">Encaje 2N: sin dato</option>
            </select>
            <input id="fTexto" class="search-input" placeholder="Buscar texto libre..." />
        </div>

        <!-- KPIs -->
        <div class="kpi-row">
            <div class="kpi-card"><div class="kpi-label">Total</div><div id="kpiTotal" class="kpi-value">‚Äì</div></div>
            <div class="kpi-card"><div class="kpi-label">Seguimiento</div><div id="kpiSeguimiento" class="kpi-value">‚Äì</div></div>
            <div class="kpi-card"><div class="kpi-label">Ganados</div><div id="kpiGanados" class="kpi-value">‚Äì</div></div>
        </div>

        <!-- TOOLBAR -->
        <div class="toolbar-table">
            <button class="btn-primary" onclick="openNewProject()">+ Nuevo proyecto</button>
            <button class="btn-icon" onclick="onEditSelected()" title="Editar proyecto seleccionado">‚úèÔ∏è</button>
            <button class="btn-icon" onclick="onDeleteSelected()" title="Borrar proyectos seleccionados">üóëÔ∏è</button>
            <button class="btn-icon" onclick="openImport()" title="Importar proyectos desde Excel">‚¨ÜÔ∏è</button>
            <input type="file" id="fileImport" accept=".xlsx,.xls,.csv" style="display:none" />
        </div>

        <!-- TABLA -->
        <div id="tablaWrapper"></div>
        <div id="emptyState" class="empty-state" style="display:none;">
            No hay proyectos que coincidan con los filtros seleccionados.
        </div>
    </main>

    <!-- MODAL PROYECTO -->
    <dialog id="projectDialog">
        <div class="modal-header" id="dialogTitle">Proyecto</div>
        <form id="projectForm" method="dialog">
            <input type="hidden" id="projId" />
            <input type="hidden" id="fuente" />

            <div class="form-grid">
                <div class="form-group">
                    <label for="nombre_obra">Nombre de la obra</label>
                    <input id="nombre_obra" required />
                </div>
                <div class="form-group">
                    <label for="cliente_principal">Cliente principal</label>
                    <input id="cliente_principal" />
                </div>
                <div class="form-group">
                    <label for="ciudad">Ciudad</label>
                    <input id="ciudad" />
                </div>
                <div class="form-group">
                    <label for="provincia">Provincia</label>
                    <input id="provincia" />
                </div>
                <div class="form-group">
                    <label for="estado">Estado</label>
                    <select id="estado">
                        <option>Detectado</option>
                        <option>En Prescripci√≥n</option>
                        <option>Oferta Enviada</option>
                        <option>Negociaci√≥n</option>
                        <option>Ganado</option>
                        <option>Perdido</option>
                        <option>Paralizado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="prioridad">Prioridad</label>
                    <select id="prioridad">
                        <option>Alta</option>
                        <option selected>Media</option>
                        <option>Baja</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tipo">Tipo de proyecto</label>
                    <select id="tipo">
                        <option>Residencial</option>
                        <option>Terciario</option>
                        <option>Mixto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="potencial_eur">Potencial (‚Ç¨)</label>
                    <input id="potencial_eur" type="number" min="0" step="10000" />
                </div>

                <div class="form-group">
                    <label for="url_obra">URL de la obra</label>
                    <input id="url_obra" placeholder="https://..." />
                </div>

                <div class="form-group">
                    <label for="seguimiento_fecha">Fecha seguimiento</label>
                    <input id="seguimiento_fecha" type="date" />
                </div>
                <div class="form-group">
                    <label for="seguimiento_comentario">Comentario seguimiento</label>
                    <textarea id="seguimiento_comentario"></textarea>
                </div>
                <div class="form-group">
                    <label for="tarea_fecha">Fecha tarea</label>
                    <input id="tarea_fecha" type="date" />
                </div>
                <div class="form-group">
                    <label for="tarea_comentario">Descripci√≥n tarea</label>
                    <textarea id="tarea_comentario"></textarea>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeDialog()">Cancelar</button>
                <button type="submit" class="btn-primary">Guardar</button>
            </div>
        </form>
    </dialog>

    <!-- MODAL BORRADO -->
    <dialog id="deleteDialog">
        <div class="modal-header">Confirmar borrado</div>
        <p id="deleteText"></p>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="closeDeleteDialog()">Cancelar</button>
            <button type="button" class="btn-primary" onclick="confirmDelete()">Borrar</button>
        </div>
    </dialog>

    <script type="module">
        import { db } from "./firebase.js";
        import {
            collection,
            getDocs,
            addDoc,
            updateDoc,
            deleteDoc,
            doc
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const fCiudad = document.getElementById("fCiudad");
        const fEstado = document.getElementById("fEstado");
        const fTipo = document.getElementById("fTipo");
        const fPrioridad = document.getElementById("fPrioridad");
        const fEncaje2N = document.getElementById("fEncaje2N");
        const fTexto = document.getElementById("fTexto");

        const kpiTotal = document.getElementById("kpiTotal");
        const kpiSeguimiento = document.getElementById("kpiSeguimiento");
        const kpiGanados = document.getElementById("kpiGanados");

        const tablaWrapper = document.getElementById("tablaWrapper");
        const emptyState = document.getElementById("emptyState");

        const projectDialog = document.getElementById("projectDialog");
        const deleteDialog = document.getElementById("deleteDialog");
        const deleteText = document.getElementById("deleteText");
        const projectForm = document.getElementById("projectForm");
        const fileInput = document.getElementById("fileImport");

        let proyectos = [];
        let proyectosFiltrados = [];
        let selectedIds = [];
        let pendingDeleteIds = [];

        async function cargarProyectos() {
            try {
                const ref = collection(db, "proyectos");
                const snap = await getDocs(ref);
                proyectos = [];
                snap.forEach(d => proyectos.push({ id: d.id, ...d.data() }));
                inicializarFiltros();
                aplicarFiltros();
            } catch (err) {
                console.error("‚ùå Error Firestore:", err);
                tablaWrapper.innerHTML =
                    "<div style='padding:12px;color:#c92a2a;font-size:14px;'>Error cargando Firestore. Mira consola.</div>";
            }
        }

        function inicializarFiltros() {
            const ciudades = [...new Set(proyectos.map(p => p.ciudad).filter(Boolean))].sort();
            const estados = [...new Set(proyectos.map(p => p.estado).filter(Boolean))];
            const tipos = [...new Set(proyectos.map(p => p.tipo).filter(Boolean))];
            const prioridades = [...new Set(proyectos.map(p => p.prioridad).filter(Boolean))];

            fCiudad.innerHTML =
                '<option value="Todas">Ciudad: todas</option>' +
                ciudades.map(c => `<option value="${c}">${c}</option>`).join("");

            fEstado.innerHTML =
                '<option value="Todos">Estado: todos</option>' +
                estados.map(e => `<option value="${e}">${e}</option>`).join("");

            fTipo.innerHTML =
                '<option value="Todos">Tipo: todos</option>' +
                tipos.map(t => `<option value="${t}">${t}</option>`).join("");

            fPrioridad.innerHTML =
                '<option value="Todas">Prioridad: todas</option>' +
                prioridades.map(pr => `<option value="${pr}">${pr}</option>`).join("");
        }

        function aplicarFiltros() {
            const ciudad = fCiudad.value;
            const estado = fEstado.value;
            const tipo = fTipo.value;
            const prioridad = fPrioridad.value;
            const encajeFiltro = fEncaje2N.value;
            const texto = (fTexto.value || "").toLowerCase();

            proyectosFiltrados = proyectos.filter(p => {
                let ok = true;
                if (ciudad !== "Todas") ok = ok && p.ciudad === ciudad;
                if (estado !== "Todos") ok = ok && p.estado === estado;
                if (tipo !== "Todos") ok = ok && p.tipo === tipo;
                if (prioridad !== "Todas") ok = ok && p.prioridad === prioridad;

                const enc = (p.encaje_2n || "").toString().toUpperCase().trim();
                if (encajeFiltro !== "Todos") {
                    if (encajeFiltro === "SIN") ok = ok && !enc;
                    else ok = ok && enc === encajeFiltro;
                }

                if (texto) {
                    const blob = [
                        p.nombre_obra,
                        p.cliente_principal,
                        p.ciudad,
                        p.provincia
                    ].join(" ").toLowerCase();
                    ok = ok && blob.includes(texto);
                }
                return ok;
            });

            kpiTotal.textContent = proyectosFiltrados.length;
            kpiSeguimiento.textContent =
                proyectosFiltrados.filter(p => p.estado && p.estado !== "Detectado").length;
            kpiGanados.textContent =
                proyectosFiltrados.filter(p => p.estado === "Ganado").length;

            pintarTabla();
        }

        function badgeClass(estado) {
            if (!estado) return "badge detectado";
            const e = estado.toLowerCase();
            if (e === "detectado") return "badge detectado";
            if (e.includes("prescripci√≥n") || e.includes("prescripcion")) return "badge prescripcion";
            if (e.includes("oferta")) return "badge oferta";
            if (e.includes("negociaci√≥n") || e.includes("negociacion")) return "badge negociacion";
            if (e === "ganado") return "badge ganado";
            if (e === "perdido") return "badge perdido";
            if (e === "paralizado") return "badge paralizado";
            return "badge detectado";
        }

        function fuenteBadge(fuente) {
            const f = (fuente || "").toLowerCase();
            if (f === "construdata") return '<span class="badge oferta">Construdata</span>';
            if (f === "prompt") return '<span class="badge prescripcion">AI / Prompt</span>';
            return '<span class="badge detectado">Manual</span>';
        }

        function renderUrl(url) {
            const u = (url || "").toString().trim();
            if (!u) return "";
            const safe = u.startsWith("http") ? u : "https://" + u;
            return `<a href="${safe}" target="_blank" rel="noopener noreferrer">üîó</a>`;
        }

        function pintarTabla() {
            selectedIds = [];

            if (!proyectosFiltrados.length) {
                tablaWrapper.innerHTML = "";
                emptyState.style.display = "block";
                return;
            }
            emptyState.style.display = "none";

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll" /></th>
                            <th>Proyecto</th>
                            <th>Cliente</th>
                            <th>Ciudad</th>
                            <th>Provincia</th>
                            <th>Estado</th>
                            <th>Prioridad</th>
                            <th>Tipo</th>
                            <th>Potencial (‚Ç¨)</th>
                            <th>Fuente</th>
                            <th>Enlace</th>
                            <th>Encaje 2N</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            proyectosFiltrados.forEach(p => {
                const pot = p.potencial_eur
                    ? Number(p.potencial_eur).toLocaleString("es-ES")
                    : "‚Äì";
                const encaje = (p.encaje_2n || "").toString().toUpperCase();

                html += `
                    <tr data-id="${p.id}">
                        <td><input type="checkbox" class="rowCheck" /></td>
                        <td>${p.nombre_obra || ""}</td>
                        <td>${p.cliente_principal || ""}</td>
                        <td>${p.ciudad || ""}</td>
                        <td>${p.provincia || ""}</td>
                        <td><span class="${badgeClass(p.estado)}">${p.estado || ""}</span></td>
                        <td>${p.prioridad || ""}</td>
                        <td>${p.tipo || ""}</td>
                        <td>${pot}</td>
                        <td>${fuenteBadge(p.fuente)}</td>
                        <td>${renderUrl(p.url_obra)}</td>
                        <td>${encaje || ""}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            tablaWrapper.innerHTML = html;

            const selectAll = document.getElementById("selectAll");
            const rowChecks = [...document.querySelectorAll(".rowCheck")];

            selectAll.addEventListener("change", () => {
                selectedIds = [];
                rowChecks.forEach((chk, i) => {
                    chk.checked = selectAll.checked;
                    if (chk.checked) selectedIds.push(proyectosFiltrados[i].id);
                });
            });

            rowChecks.forEach((chk, i) => {
                chk.addEventListener("change", () => {
                    const id = proyectosFiltrados[i].id;
                    if (chk.checked) {
                        if (!selectedIds.includes(id)) selectedIds.push(id);
                    } else {
                        selectedIds = selectedIds.filter(x => x !== id);
                        selectAll.checked = false;
                    }
                });
            });
        }

        function fillForm(p) {
            document.getElementById("projId").value = p?.id || "";
            document.getElementById("nombre_obra").value = p?.nombre_obra || "";
            document.getElementById("cliente_principal").value = p?.cliente_principal || "";
            document.getElementById("ciudad").value = p?.ciudad || "";
            document.getElementById("provincia").value = p?.provincia || "";
            document.getElementById("estado").value = p?.estado || "Detectado";
            document.getElementById("prioridad").value = p?.prioridad || "Media";
            document.getElementById("tipo").value = p?.tipo || "Residencial";
            document.getElementById("potencial_eur").value = p?.potencial_eur || "";
            document.getElementById("url_obra").value = p?.url_obra || "";
            document.getElementById("seguimiento_fecha").value = p?.seguimiento_fecha || "";
            document.getElementById("seguimiento_comentario").value = p?.seguimiento_comentario || "";
            document.getElementById("tarea_fecha").value = p?.tarea_fecha || "";
            document.getElementById("tarea_comentario").value = p?.tarea_comentario || "";
            document.getElementById("fuente").value = p?.fuente || "manual";
        }

        window.openNewProject = function () {
            document.getElementById("dialogTitle").textContent = "Alta de proyecto";
            fillForm(null);
            projectDialog.showModal();
        };

        window.onEditSelected = function () {
            if (selectedIds.length === 0) {
                alert("Selecciona una √∫nica obra para editar.");
                return;
            }
            if (selectedIds.length > 1) {
                alert("Solo puedes editar una obra a la vez.");
                return;
            }
            const id = selectedIds[0];
            const p = proyectos.find(x => x.id === id);
            if (!p) return;
            document.getElementById("dialogTitle").textContent = "Edici√≥n de proyecto";
            fillForm(p);
            projectDialog.showModal();
        };

        window.closeDialog = function () {
            projectDialog.close();
        };

        projectForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            const id = document.getElementById("projId").value;
            const payload = {
                nombre_obra: document.getElementById("nombre_obra").value.trim(),
                cliente_principal: document.getElementById("cliente_principal").value.trim(),
                ciudad: document.getElementById("ciudad").value.trim(),
                provincia: document.getElementById("provincia").value.trim(),
                estado: document.getElementById("estado").value,
                prioridad: document.getElementById("prioridad").value,
                tipo: document.getElementById("tipo").value,
                potencial_eur: Number(document.getElementById("potencial_eur").value || 0),
                url_obra: document.getElementById("url_obra").value.trim(),
                seguimiento_fecha: document.getElementById("seguimiento_fecha").value || null,
                seguimiento_comentario: document.getElementById("seguimiento_comentario").value.trim(),
                tarea_fecha: document.getElementById("tarea_fecha").value || null,
                tarea_comentario: document.getElementById("tarea_comentario").value.trim(),
                fuente: document.getElementById("fuente").value || "manual"
            };

            try {
                if (id) await updateDoc(doc(db, "proyectos", id), payload);
                else await addDoc(collection(db, "proyectos"), payload);

                projectDialog.close();
                cargarProyectos();
            } catch (err) {
                console.error("‚ùå Error guardando:", err);
                alert("Error guardando el proyecto.");
            }
        });

        window.onDeleteSelected = function () {
            if (!selectedIds.length) {
                alert("Selecciona una obra para borrar.");
                return;
            }
            pendingDeleteIds = [...selectedIds];
            deleteText.textContent =
                `Se van a borrar ${pendingDeleteIds.length} proyecto(s).`;
            deleteDialog.showModal();
        };

        window.closeDeleteDialog = function () {
            deleteDialog.close();
        };

        window.confirmDelete = async function () {
            try {
                for (const id of pendingDeleteIds) {
                    await deleteDoc(doc(db, "proyectos", id));
                }
                deleteDialog.close();
                cargarProyectos();
            } catch (err) {
                console.error(err);
                alert("Error borrando");
            }
        };

        window.openImport = function () {
            fileInput.value = "";
            fileInput.click();
        };

        fileInput.addEventListener("change", handleFileImport);

        async function handleFileImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (!window.XLSX) {
                alert("No se ha podido cargar la librer√≠a de Excel (XLSX).");
                return;
            }

            try {
                const rows = await readExcelFile(file);
                if (!rows.length) {
                    alert("No se han encontrado filas en el Excel.");
                    return;
                }

                const mapped = rows
                    .map(row => {
                        const p = mapRowToProyecto(row);
                        if (!p.nombre_obra || !p.nombre_obra.trim()) return null;
                        p.fuente = detectSource(row);
                        return p;
                    })
                    .filter(Boolean);

                if (!mapped.length) {
                    alert("No se ha podido mapear ning√∫n proyecto (revisa los encabezados).");
                    return;
                }

                const existingKeys = new Set(proyectos.map(p => makeKey(p)));

                const batchKeys = new Set();
                const toImport = [];
                const duplicates = [];

                for (const p of mapped) {
                    const key = makeKey(p);
                    if (existingKeys.has(key) || batchKeys.has(key)) {
                        duplicates.push(p);
                        continue;
                    }
                    batchKeys.add(key);
                    toImport.push(p);
                }

                if (!toImport.length) {
                    alert(
                        `No se ha importado ning√∫n proyecto nuevo.\n` +
                        `Todas las filas detectadas estaban ya en el CRM o duplicadas en el propio fichero.`
                    );
                    return;
                }

                const ref = collection(db, "proyectos");
                for (const p of toImport) {
                    await addDoc(ref, p);
                }

                const namesDup = duplicates.map(p => p.nombre_obra).filter(Boolean);
                const summaryNames = namesDup.slice(0, 10).join(", ");
                const extra = namesDup.length > 10
                    ? `, y ${namesDup.length - 10} m√°s...`
                    : "";

                alert(
                    `Importaci√≥n completada.\n\n` +
                    `Filas le√≠das del fichero: ${rows.length}\n` +
                    `Proyectos mapeados v√°lidos (con nombre): ${mapped.length}\n` +
                    `Proyectos NUEVOS creados: ${toImport.length}\n` +
                    `Proyectos detectados como duplicados y omitidos: ${duplicates.length}` +
                    (duplicates.length
                        ? `\n\nDuplicados (ejemplos): ${summaryNames}${extra}`
                        : "")
                );

                cargarProyectos();
            } catch (err) {
                console.error("‚ùå Error importando Excel:", err);
                alert("Error importando el fichero. Revisa la consola.");
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: "array" });
                        const firstSheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[firstSheetName];
                        const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
                        resolve(json);
                    } catch (e) {
                        reject(e);
                    }
                };
                reader.onerror = (err) => reject(err);
                reader.readAsArrayBuffer(file);
            });
        }

        function makeKey(p) {
            const nombre = (p.nombre_obra || "").toString().toLowerCase().trim();
            const ciudad = (p.ciudad || "").toString().toLowerCase().trim();
            const cliente = (p.cliente_principal || p.promotora || "").toString().toLowerCase().trim();
            return [nombre, ciudad, cliente].join("|");
        }

        function detectSource(row) {
            const normKeys = Object.keys(row).map(k => normalizeHeaderKey(k));
            const isConstrudata =
                normKeys.includes(normalizeHeaderKey("Obra:Nombre")) ||
                normKeys.includes(normalizeHeaderKey("Promotor1:Empresa")) ||
                normKeys.includes(normalizeHeaderKey("Obra:Url (Enlace Obra)"));
            return isConstrudata ? "construdata" : "prompt";
        }

        const HEADER_MAP = {
            nombre_obra: [
                "nombre_obra", "Nombre_obra", "Nombre de la obra", "Nombre obra",
                "Obra", "Proyecto", "Obra/Proyecto", "Titulo obra", "T√≠tulo obra",
                "Obra:Nombre"
            ],
            cliente_principal: [
                "cliente_principal", "Cliente_principal", "Cliente principal",
                "Cliente", "Cliente/Propiedad", "Propietario", "Propiedad",
                "Promotor", "Promotor1:Empresa"
            ],
            ciudad: [
                "ciudad", "Ciudad", "Localidad", "Poblaci√≥n", "Poblacion", "Municipio",
                "Obra:Localidad"
            ],
            provincia: [
                "provincia", "Provincia"
            ],
            estado: [
                "estado", "Estado", "Estado proyecto", "Situaci√≥n", "Situacion", "Fase",
                "Obra:Hito"
            ],
            prioridad: [
                "prioridad", "Prioridad"
            ],
            tipo: [
                "tipo", "Tipo", "Tipo de proyecto", "Tipo de obra", "Tipologia", "Tipolog√≠a",
                "Obra:Tipo de obra", "Obra (Extras):Tipo de trabajo"
            ],
            potencial_eur: [
                "potencial_eur", "Potencial (‚Ç¨)", "Potencial", "Presupuesto",
                "Presupuesto (EUR)", "Presupuesto (‚Ç¨)", "Importe obra", "Presupuesto obra",
                "Obra:Presupuesto"
            ],
            url_obra: [
                "url_obra", "Url obra", "URL obra", "Enlace obra",
                "Obra:Url (Enlace Obra)", "Obra:Url", "Obra:URL"
            ],
            seguimiento_fecha: [
                "seguimiento_fecha", "Seguimiento_fecha", "Fecha seguimiento",
                "Pr√≥ximo seguimiento", "Proximo seguimiento",
                "Obra:Fecha hito actual"
            ],
            seguimiento_comentario: [
                "seguimiento_comentario", "Comentario seguimiento",
                "Notas seguimiento", "Notas seguimiento comercial",
                "Obra:Descripcion Hito", "Obra:Descripci√≥n Hito", "Obra:Descripcion hito"
            ],
            tarea_fecha: [
                "tarea_fecha", "Fecha tarea", "Fecha pr√≥xima tarea", "Fecha proxima tarea"
            ],
            tarea_comentario: [
                "tarea_comentario", "Descripci√≥n tarea", "Descripcion tarea",
                "Tarea", "Acci√≥n comercial", "Accion comercial",
                "Gestiones:Eventos agendados"
            ],
            promotora: [
                "promotora", "Promotora", "Promotor", "Promotora / Cliente", "Propiedad",
                "Promotor1:Empresa"
            ],
            constructora: [
                "constructora", "Constructora", "Constructor",
                "Contratista1:Empresa"
            ],
            arquitectura: [
                "arquitectura", "Arquitectura", "Arquitecto", "Estudio arquitectura",
                "Estudio de arquitectura", "Arquitecto/Estudio",
                "Arquitecto1:Empresa"
            ],
            ingenieria: [
                "ingenieria", "Ingenieria", "Ingenier√≠a", "Ingenier√≠a/Instalaciones",
                "Ingenieria/Instalaciones",
                "Ingenier√≠a 1:Empresa"
            ],
            contacto_cliente: [
                "contacto_cliente", "Contacto cliente", "Responsable cliente",
                "Persona contacto cliente"
            ],
            telefono_cliente: [
                "telefono_cliente", "Tel√©fono cliente", "Telefono cliente",
                "Tlf cliente", "Tel√©fono contacto", "Telefono contacto",
                "Promotor1:Telefonos"
            ],
            email_cliente: [
                "email_cliente", "Email cliente", "Correo cliente", "Mail cliente",
                "Promotor1:Email"
            ],
            contacto_arquitectura: [
                "contacto_arquitectura", "Contacto arquitecto", "Contacto arquitectura",
                "Responsable arquitectura"
            ],
            telefono_arquitectura: [
                "telefono_arquitectura", "Tel√©fono arquitecto", "Telefono arquitecto",
                "Tlf arquitecto",
                "Arquitecto1:Telefonos"
            ],
            email_arquitectura: [
                "email_arquitectura", "Email arquitecto", "Correo arquitecto", "Mail arquitecto",
                "Arquitecto1:Email"
            ],
            notas: [
                "notas", "Notas", "Observaciones", "Comentarios",
                "Gestiones:Comentarios"
            ],
            encaje_2n: [
                "encaje_2n", "Encaje soluciones 2N", "Encaje 2N",
                "Encaje soluciones 2n", "Encaje potencial 2N"
            ],
            motivo_encaje_2n: [
                "motivo_encaje_2n", "Motivo del encaje 2N", "Motivo encaje 2N",
                "Motivo 2N", "Notas encaje 2N"
            ]
        };

        function normalizeHeaderKey(key) {
            return key
                .toString()
                .toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-z0-9]/g, "");
        }

        const HEADER_NORMALIZED = {};
        for (const [field, variants] of Object.entries(HEADER_MAP)) {
            HEADER_NORMALIZED[field] = variants.map(v => normalizeHeaderKey(v));
        }

        function getCell(row, variants, fieldName) {
            for (const v of variants) {
                if (Object.prototype.hasOwnProperty.call(row, v) && row[v] !== "") return row[v];
            }
            const targetNorms = HEADER_NORMALIZED[fieldName];
            for (const key of Object.keys(row)) {
                const nk = normalizeHeaderKey(key);
                if (targetNorms.includes(nk) && row[key] !== "") return row[key];
            }
            return "";
        }

        function normalizeDate(value) {
            if (!value) return "";
            if (typeof value === "string") {
                if (/^\d{4}-\d{2}-\d{2}$/.test(value.trim())) return value.trim();
                const m = value.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
                if (m) {
                    const d = m[1].padStart(2, "0");
                    const mo = m[2].padStart(2, "0");
                    return `${m[3]}-${mo}-${d}`;
                }
                return "";
            }
            if (typeof value === "number" && window.XLSX && XLSX.SSF) {
                try {
                    const date = XLSX.SSF.parse_date_code(value);
                    if (date) {
                        const y = date.y;
                        const m = String(date.m).padStart(2, "0");
                        const d = String(date.d).padStart(2, "0");
                        return `${y}-${m}-${d}`;
                    }
                } catch {}
            }
            return "";
        }

        function mapRowToProyecto(row) {
            return {
                nombre_obra: getCell(row, HEADER_MAP.nombre_obra, "nombre_obra").toString().trim(),
                cliente_principal: getCell(row, HEADER_MAP.cliente_principal, "cliente_principal").toString().trim(),
                ciudad: getCell(row, HEADER_MAP.ciudad, "ciudad").toString().trim(),
                provincia: getCell(row, HEADER_MAP.provincia, "provincia").toString().trim(),
                estado: (getCell(row, HEADER_MAP.estado, "estado") || "Detectado").toString().trim(),
                prioridad: (getCell(row, HEADER_MAP.prioridad, "prioridad") || "Media").toString().trim(),
                tipo: (getCell(row, HEADER_MAP.tipo, "tipo") || "Residencial").toString().trim(),
                potencial_eur: Number(getCell(row, HEADER_MAP.potencial_eur, "potencial_eur") || 0),
                url_obra: getCell(row, HEADER_MAP.url_obra, "url_obra").toString().trim(),
                seguimiento_fecha: normalizeDate(getCell(row, HEADER_MAP.seguimiento_fecha, "seguimiento_fecha")),
                seguimiento_comentario: getCell(row, HEADER_MAP.seguimiento_comentario, "seguimiento_comentario").toString().trim(),
                tarea_fecha: normalizeDate(getCell(row, HEADER_MAP.tarea_fecha, "tarea_fecha")),
                tarea_comentario: getCell(row, HEADER_MAP.tarea_comentario, "tarea_comentario").toString().trim(),
                promotora: getCell(row, HEADER_MAP.promotora, "promotora").toString().trim(),
                constructora: getCell(row, HEADER_MAP.constructora, "constructora").toString().trim(),
                arquitectura: getCell(row, HEADER_MAP.arquitectura, "arquitectura").toString().trim(),
                ingenieria: getCell(row, HEADER_MAP.ingenieria, "ingenieria").toString().trim(),
                contacto_cliente: getCell(row, HEADER_MAP.contacto_cliente, "contacto_cliente").toString().trim(),
                telefono_cliente: getCell(row, HEADER_MAP.telefono_cliente, "telefono_cliente").toString().trim(),
                email_cliente: getCell(row, HEADER_MAP.email_cliente, "email_cliente").toString().trim(),
                contacto_arquitectura: getCell(row, HEADER_MAP.contacto_arquitectura, "contacto_arquitectura").toString().trim(),
                telefono_arquitectura: getCell(row, HEADER_MAP.telefono_arquitectura, "telefono_arquitectura").toString().trim(),
                email_arquitectura: getCell(row, HEADER_MAP.email_arquitectura, "email_arquitectura").toString().trim(),
                notas: getCell(row, HEADER_MAP.notas, "notas").toString().trim(),
                encaje_2n: getCell(row, HEADER_MAP.encaje_2n, "encaje_2n").toString().trim(),
                motivo_encaje_2n: getCell(row, HEADER_MAP.motivo_encaje_2n, "motivo_encaje_2n").toString().trim()
            };
        }

        [fCiudad, fEstado, fTipo, fPrioridad, fEncaje2N].forEach(el =>
            el.addEventListener("change", aplicarFiltros)
        );
        fTexto.addEventListener("input", aplicarFiltros);

        cargarProyectos();
    </script>
</body>
</html>
