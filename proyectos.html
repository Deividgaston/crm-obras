<!--
CRM 2N ‚Äì Modo Desarrollador Eficiente
P√°gina de Proyectos ¬∑ Lista + filtros + alta/edici√≥n
Estilo Salesforce Moderno + Firebase optimizado
-->

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CRM 2N ‚Äì Proyectos</title>

    <link rel="stylesheet" href="style.css" />
</head>

<body>

    <!-- NAV SUPERIOR -->
    <div class="topnav">
        <div class="logo">CRM 2N</div>

        <div class="nav-tabs">
            <div class="nav-item" onclick="location.href='index.html'">Dashboard</div>
            <div class="nav-item active" onclick="location.href='proyectos.html'">Proyectos</div>
            <div class="nav-item" onclick="location.href='pipeline.html'">Pipeline</div>
            <div class="nav-item" onclick="location.href='clientes.html'">Clientes</div>
            <div class="nav-item" onclick="location.href='tareas.html'">Tareas</div>
            <div class="nav-item" onclick="location.href='reportes.html'">Reportes</div>
        </div>

        <input type="text" class="search-box" placeholder="Buscar..." />
    </div>

    <main class="content">
        <h2 style="margin-top:0; margin-bottom:4px; color:#16325C;">Proyectos</h2>
        <div style="font-size:12px;color:#5A6872;margin-bottom:14px;">
            Vista general en tabla ¬∑ Filtra, selecciona, edita o borra
        </div>

        <!-- FILTROS SUPERIORES -->
        <div class="filters-row">
            <select id="fCiudad" class="select-input">
                <option value="Todas">Ciudad: todas</option>
            </select>

            <select id="fEstado" class="select-input">
                <option value="Todos">Estado: todos</option>
            </select>

            <select id="fTipo" class="select-input">
                <option value="Todos">Tipo: todos</option>
            </select>

            <select id="fPrioridad" class="select-input">
                <option value="Todas">Prioridad: todas</option>
            </select>

            <input id="fTexto" class="search-input" placeholder="Buscar texto libre..." />
        </div>

        <!-- KPIs -->
        <div class="kpi-row">
            <div class="kpi-card">
                <div class="kpi-label">Total</div>
                <div id="kpiTotal" class="kpi-value">‚Äì</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Seguimiento</div>
                <div id="kpiSeguimiento" class="kpi-value">‚Äì</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Ganados</div>
                <div id="kpiGanados" class="kpi-value">‚Äì</div>
            </div>
        </div>

        <!-- TOOLBAR TABLA -->
        <div class="toolbar-table">
            <button class="btn-primary" onclick="openNewProject()">+ Nuevo proyecto</button>
            <button class="btn-icon" onclick="onEditSelected()">‚úèÔ∏è</button>
            <button class="btn-icon" onclick="onDeleteSelected()">üóëÔ∏è</button>
        </div>

        <!-- TABLA -->
        <div id="tablaWrapper"></div>
        <div id="emptyState" class="empty-state" style="display:none;">
            No hay proyectos que coincidan con los filtros seleccionados.
        </div>
    </main>

    <!-- MODAL EDICI√ìN / ALTA -->
    <dialog id="projectDialog">
        <div class="modal-header" id="dialogTitle">Proyecto</div>
        <form id="projectForm" method="dialog">
            <input type="hidden" id="projId" />

            <div class="form-grid">
                <div class="form-group">
                    <label for="nombre_obra">Nombre de la obra</label>
                    <input id="nombre_obra" required />
                </div>

                <div class="form-group">
                    <label for="cliente_principal">Cliente principal</label>
                    <input id="cliente_principal" />
                </div>

                <div class="form-group">
                    <label for="ciudad">Ciudad</label>
                    <input id="ciudad" />
                </div>

                <div class="form-group">
                    <label for="provincia">Provincia</label>
                    <input id="provincia" />
                </div>

                <div class="form-group">
                    <label for="estado">Estado</label>
                    <select id="estado">
                        <option>Detectado</option>
                        <option>En Prescripci√≥n</option>
                        <option>Oferta Enviada</option>
                        <option>Negociaci√≥n</option>
                        <option>Ganado</option>
                        <option>Perdido</option>
                        <option>Paralizado</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="prioridad">Prioridad</label>
                    <select id="prioridad">
                        <option>Alta</option>
                        <option selected>Media</option>
                        <option>Baja</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tipo">Tipo de proyecto</label>
                    <select id="tipo">
                        <option>Residencial</option>
                        <option>Terciario</option>
                        <option>Mixto</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="potencial_eur">Potencial (‚Ç¨)</label>
                    <input id="potencial_eur" type="number" min="0" step="10000" />
                </div>

                <div class="form-group">
                    <label for="seguimiento_fecha">Fecha seguimiento</label>
                    <input id="seguimiento_fecha" type="date" />
                </div>

                <div class="form-group">
                    <label for="seguimiento_comentario">Comentario seguimiento</label>
                    <textarea id="seguimiento_comentario"></textarea>
                </div>

                <div class="form-group">
                    <label for="tarea_fecha">Fecha tarea</label>
                    <input id="tarea_fecha" type="date" />
                </div>

                <div class="form-group">
                    <label for="tarea_comentario">Descripci√≥n tarea</label>
                    <textarea id="tarea_comentario"></textarea>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeDialog()">Cancelar</button>
                <button type="submit" class="btn-primary">Guardar</button>
            </div>
        </form>
    </dialog>

    <!-- DIALOG BORRADO -->
    <dialog id="deleteDialog">
        <div class="modal-header">Confirmar borrado</div>
        <p id="deleteText"></p>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="closeDeleteDialog()">Cancelar</button>
            <button type="button" class="btn-primary" onclick="confirmDelete()">Borrar</button>
        </div>
    </dialog>

    <!-- ========================== -->
    <!--         SCRIPT JS          -->
    <!-- ========================== -->

    <script type="module">

        /* ------------------------------
           IMPORTS FIREBASE (correctos)
           ------------------------------ */
        import { db } from "./firebase.js";
        import {
            collection,
            getDocs,
            addDoc,
            updateDoc,
            deleteDoc,
            doc
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        console.log("CRM 2N ‚Äì Proyectos cargado");

        /* ------------------------------
           VARIABLES
           ------------------------------ */

        const ESTADOS_PIPELINE = [
            "Detectado","En Prescripci√≥n","Oferta Enviada",
            "Negociaci√≥n","Ganado","Perdido","Paralizado"
        ];

        const fCiudad = document.getElementById("fCiudad");
        const fEstado = document.getElementById("fEstado");
        const fTipo = document.getElementById("fTipo");
        const fPrioridad = document.getElementById("fPrioridad");
        const fTexto = document.getElementById("fTexto");

        const kpiTotal = document.getElementById("kpiTotal");
        const kpiSeguimiento = document.getElementById("kpiSeguimiento");
        const kpiGanados = document.getElementById("kpiGanados");

        const tablaWrapper = document.getElementById("tablaWrapper");
        const emptyState = document.getElementById("emptyState");

        const projectDialog = document.getElementById("projectDialog");
        const deleteDialog = document.getElementById("deleteDialog");
        const deleteText = document.getElementById("deleteText");
        const projectForm = document.getElementById("projectForm");

        let proyectos = [];
        let proyectosFiltrados = [];
        let selectedIds = [];
        let pendingDeleteIds = [];

        /* ------------------------------
           CARGA INICIAL PROYECTOS
           ------------------------------ */

        async function cargarProyectos() {
            console.log("Cargando documentos desde Firestore‚Ä¶");

            try {
                const ref = collection(db, "proyectos");  // üëà CAMBIA AQU√ç si tu colecci√≥n tiene otro nombre
                const snap = await getDocs(ref);

                console.log("Docs encontrados:", snap.size);

                proyectos = [];
                snap.forEach(doc => {
                    proyectos.push({ id: doc.id, ...doc.data() });
                });

                inicializarFiltros();
                aplicarFiltros();

            } catch (err) {
                console.error("‚ùå ERROR Firestore:", err);
                tablaWrapper.innerHTML =
                    "<div style='padding:12px;color:#c92a2a;font-size:14px;'>Error cargando Firestore. Mira consola.</div>";
            }
        }

        /* ------------------------------
           FILTROS
           ------------------------------ */

        function inicializarFiltros() {
            const ciudades = Array.from(new Set(
                proyectos.map(p => p.ciudad).filter(Boolean)
            )).sort();

            fCiudad.innerHTML =
                '<option value="Todas">Ciudad: todas</option>' +
                ciudades.map(c => `<option value="${c}">${c}</option>`).join("");

            const estados = Array.from(new Set(
                proyectos.map(p => p.estado).filter(Boolean)
            ));
            fEstado.innerHTML =
                '<option value="Todos">Estado: todos</option>' +
                estados.map(e => `<option value="${e}">${e}</option>`).join("");

            const tipos = Array.from(new Set(
                proyectos.map(p => p.tipo).filter(Boolean)
            ));
            fTipo.innerHTML =
                '<option value="Todos">Tipo: todos</option>' +
                tipos.map(t => `<option value="${t}">${t}</option>`).join("");

            const prioridades = Array.from(new Set(
                proyectos.map(p => p.prioridad).filter(Boolean)
            ));
            fPrioridad.innerHTML =
                '<option value="Todas">Prioridad: todas</option>' +
                prioridades.map(pr => `<option value="${pr}">${pr}</option>`).join("");
        }

        function aplicarFiltros() {
            const ciudad = fCiudad.value;
            const estado = fEstado.value;
            const tipo = fTipo.value;
            const prioridad = fPrioridad.value;
            const texto = fTexto.value.toLowerCase();

            proyectosFiltrados = proyectos.filter(p => {
                let ok = true;

                if (ciudad !== "Todas") ok &= p.ciudad === ciudad;
                if (estado !== "Todos") ok &= p.estado === estado;
                if (tipo !== "Todos") ok &= p.tipo === tipo;
                if (prioridad !== "Todas") ok &= p.prioridad === prioridad;

                if (texto) {
                    const blob = [
                        p.nombre_obra, p.cliente_principal,
                        p.ciudad, p.provincia
                    ].join(" ").toLowerCase();

                    ok &= blob.includes(texto);
                }

                return ok;
            });

            pintarKPIs();
            pintarTabla();
        }

        /* ------------------------------
           KPI
           ------------------------------ */

        function pintarKPIs() {
            kpiTotal.textContent = proyectosFiltrados.length;
            kpiSeguimiento.textContent =
                proyectosFiltrados.filter(p => p.estado && p.estado !== "Detectado").length;
            kpiGanados.textContent =
                proyectosFiltrados.filter(p => p.estado === "Ganado").length;
        }

        /* ------------------------------
           TABLA
           ------------------------------ */

        function badgeClass(estado) {
            if (!estado) return "badge detectado";
            const e = estado.toLowerCase();
            if (e === "detectado") return "badge detectado";
            if (e.includes("prescripci√≥n")) return "badge prescripcion";
            if (e.includes("oferta")) return "badge oferta";
            if (e.includes("negociaci√≥n")) return "badge negociacion";
            if (e === "ganado") return "badge ganado";
            if (e === "perdido") return "badge perdido";
            if (e === "paralizado") return "badge paralizado";
            return "badge detectado";
        }

        function pintarTabla() {
            selectedIds = [];

            if (!proyectosFiltrados.length) {
                tablaWrapper.innerHTML = "";
                emptyState.style.display = "block";
                return;
            }

            emptyState.style.display = "none";

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll" /></th>
                            <th>Proyecto</th>
                            <th>Cliente</th>
                            <th>Ciudad</th>
                            <th>Provincia</th>
                            <th>Estado</th>
                            <th>Prioridad</th>
                            <th>Tipo</th>
                            <th>Potencial (‚Ç¨)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            proyectosFiltrados.forEach(p => {
                const pot = p.potencial_eur
                    ? Number(p.potencial_eur).toLocaleString("es-ES")
                    : "‚Äì";

                html += `
                    <tr data-id="${p.id}">
                        <td><input type="checkbox" class="rowCheck" /></td>
                        <td>${p.nombre_obra || ""}</td>
                        <td>${p.cliente_principal || ""}</td>
                        <td>${p.ciudad || ""}</td>
                        <td>${p.provincia || ""}</td>
                        <td><span class="${badgeClass(p.estado)}">${p.estado || ""}</span></td>
                        <td>${p.prioridad || ""}</td>
                        <td>${p.tipo || ""}</td>
                        <td>${pot}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            tablaWrapper.innerHTML = html;

            const selectAll = document.getElementById("selectAll");
            const rowChecks = [...document.querySelectorAll(".rowCheck")];

            selectAll.addEventListener("change", () => {
                selectedIds = [];
                rowChecks.forEach((chk, i) => {
                    chk.checked = selectAll.checked;
                    if (chk.checked) selectedIds.push(proyectosFiltrados[i].id);
                });
            });

            rowChecks.forEach((chk, i) => {
                chk.addEventListener("change", () => {
                    const id = proyectosFiltrados[i].id;
                    if (chk.checked) {
                        if (!selectedIds.includes(id)) selectedIds.push(id);
                    } else {
                        selectedIds = selectedIds.filter(x => x !== id);
                        selectAll.checked = false;
                    }
                });
            });
        }

        /* ------------------------------
           MODAL ALTA/EDICI√ìN
           ------------------------------ */

        function fillForm(p) {
            document.getElementById("projId").value = p?.id || "";
            document.getElementById("nombre_obra").value = p?.nombre_obra || "";
            document.getElementById("cliente_principal").value = p?.cliente_principal || "";
            document.getElementById("ciudad").value = p?.ciudad || "";
            document.getElementById("provincia").value = p?.provincia || "";
            document.getElementById("estado").value = p?.estado || "Detectado";
            document.getElementById("prioridad").value = p?.prioridad || "Media";
            document.getElementById("tipo").value = p?.tipo || "Residencial";
            document.getElementById("potencial_eur").value = p?.potencial_eur || "";

            document.getElementById("seguimiento_fecha").value = p?.seguimiento_fecha || "";
            document.getElementById("seguimiento_comentario").value = p?.seguimiento_comentario || "";
            document.getElementById("tarea_fecha").value = p?.tarea_fecha || "";
            document.getElementById("tarea_comentario").value = p?.tarea_comentario || "";
        }

        window.openNewProject = function () {
            document.getElementById("dialogTitle").textContent = "Alta de proyecto";
            fillForm(null);
            projectDialog.showModal();
        };

        window.onEditSelected = function () {
            if (selectedIds.length === 0) {
                alert("Selecciona una √∫nica obra para editar.");
                return;
            }
            if (selectedIds.length > 1) {
                alert("Solo puedes editar una obra a la vez.");
                return;
            }
            const id = selectedIds[0];
            const p = proyectos.find(x => x.id === id);
            if (!p) return;
            document.getElementById("dialogTitle").textContent = "Edici√≥n de proyecto";
            fillForm(p);
            projectDialog.showModal();
        };

        window.closeDialog = function () {
            projectDialog.close();
        };

        projectForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            const id = document.getElementById("projId").value;
            const payload = {
                nombre_obra: document.getElementById("nombre_obra").value.trim(),
                cliente_principal: document.getElementById("cliente_principal").value.trim(),
                ciudad: document.getElementById("ciudad").value.trim(),
                provincia: document.getElementById("provincia").value.trim(),
                estado: document.getElementById("estado").value,
                prioridad: document.getElementById("prioridad").value,
                tipo: document.getElementById("tipo").value,
                potencial_eur: Number(document.getElementById("potencial_eur").value || 0),
                seguimiento_fecha: document.getElementById("seguimiento_fecha").value || null,
                seguimiento_comentario: document.getElementById("seguimiento_comentario").value.trim(),
                tarea_fecha: document.getElementById("tarea_fecha").value || null,
                tarea_comentario: document.getElementById("tarea_comentario").value.trim()
            };

            try {
                if (id) {
                    await updateDoc(doc(db, "proyectos", id), payload);
                } else {
                    await addDoc(collection(db, "proyectos"), payload);
                }
                projectDialog.close();
                cargarProyectos();
            } catch (err) {
                console.error("‚ùå Error guardando:", err);
                alert("Error guardando el proyecto.");
            }
        });

        /* ------------------------------
           BORRADO
           ------------------------------ */

        window.onDeleteSelected = function () {
            if (!selectedIds.length) {
                alert("Selecciona una obra para borrar.");
                return;
            }
            pendingDeleteIds = [...selectedIds];
            deleteText.textContent =
                `Se van a borrar ${pendingDeleteIds.length} proyecto(s).`;
            deleteDialog.showModal();
        };

        window.closeDeleteDialog = function () {
            deleteDialog.close();
        };

        window.confirmDelete = async function () {
            try {
                for (const id of pendingDeleteIds) {
                    await deleteDoc(doc(db, "proyectos", id));
                }
                deleteDialog.close();
                cargarProyectos();
            } catch (err) {
                console.error(err);
                alert("Error borrando");
            }
        };

        /* ------------------------------
           LISTENERS FILTROS
           ------------------------------ */

        [fCiudad, fEstado, fTipo, fPrioridad].forEach(el =>
            el.addEventListener("change", aplicarFiltros)
        );
        fTexto.addEventListener("input", aplicarFiltros);

        /* ------------------------------
           INIT
           ------------------------------ */
        cargarProyectos();

    </script>

</body>
</html>
