<script type="module">
    console.log("CRM 2N ¬∑ Proyectos ‚Äì script cargado");

    import { db } from "./firebase.js";
    import {
        collection,
        getDocs,
        addDoc,
        updateDoc,
        deleteDoc,
        doc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const ESTADOS_PIPELINE = [
        "Detectado",
        "En Prescripci√≥n",
        "Oferta Enviada",
        "Negociaci√≥n",
        "Ganado",
        "Perdido",
        "Paralizado"
    ];

    const fCiudad = document.getElementById("fCiudad");
    const fEstado = document.getElementById("fEstado");
    const fTipo = document.getElementById("fTipo");
    const fPrioridad = document.getElementById("fPrioridad");
    const fTexto = document.getElementById("fTexto");

    const kpiTotal = document.getElementById("kpiTotal");
    const kpiSeguimiento = document.getElementById("kpiSeguimiento");
    const kpiGanados = document.getElementById("kpiGanados");

    const tablaWrapper = document.getElementById("tablaWrapper");
    const emptyState = document.getElementById("emptyState");

    const projectDialog = document.getElementById("projectDialog");
    const deleteDialog = document.getElementById("deleteDialog");
    const deleteText = document.getElementById("deleteText");
    const projectForm = document.getElementById("projectForm");

    let proyectos = [];
    let proyectosFiltrados = [];
    let selectedIds = [];
    let pendingDeleteIds = [];

    // === CARGA INICIAL CON TRY/CATCH Y LOGS ===
    async function cargarProyectos() {
        console.log("Cargando proyectos desde Firestore‚Ä¶");

        try {
            const ref = collection(db, "proyectos"); // üëà nombre colecci√≥n
            const snap = await getDocs(ref);
            console.log("Documentos recibidos:", snap.size);

            proyectos = [];
            snap.forEach(d => {
                proyectos.push({
                    id: d.id,
                    ...d.data()
                });
            });
            console.log("Array proyectos:", proyectos);

            inicializarFiltros();
            aplicarFiltros();
        } catch (err) {
            console.error("‚ùå Error cargando proyectos:", err);
            tablaWrapper.innerHTML =
                "<div style='padding:12px;color:#c92a2a;font-size:14px;'>Error cargando proyectos desde Firestore. Mira la consola (F12 ‚Üí Console).</div>";
        }
    }

    function inicializarFiltros() {
        const ciudades = Array.from(new Set(
            proyectos.map(p => p.ciudad).filter(x => x && x.trim() !== "")
        )).sort();

        fCiudad.innerHTML =
            '<option value="Todas">Ciudad: todas</option>' +
            ciudades.map(c => `<option value="${c}">${c}</option>`).join("");

        const estados = Array.from(new Set(
            proyectos.map(p => p.estado).filter(x => x && x.trim() !== "")
        ));
        fEstado.innerHTML =
            '<option value="Todos">Estado: todos</option>' +
            estados.map(e => `<option value="${e}">${e}</option>`).join("");

        const tipos = Array.from(new Set(
            proyectos.map(p => p.tipo).filter(x => x && x.trim() !== "")
        ));
        fTipo.innerHTML =
            '<option value="Todos">Tipo: todos</option>' +
            tipos.map(t => `<option value="${t}">${t}</option>`).join("");

        const prioridades = Array.from(new Set(
            proyectos.map(p => p.prioridad).filter(x => x && x.trim() !== "")
        ));
        fPrioridad.innerHTML =
            '<option value="Todas">Prioridad: todas</option>' +
            prioridades.map(pr => `<option value="${pr}">${pr}</option>`).join("");
    }

    function aplicarFiltros() {
        const ciudad = fCiudad.value;
        const estado = fEstado.value;
        const tipo = fTipo.value;
        const prioridad = fPrioridad.value;
        const texto = (fTexto.value || "").toLowerCase();

        proyectosFiltrados = proyectos.filter(p => {
            let ok = true;

            if (ciudad !== "Todas") ok = ok && p.ciudad === ciudad;
            if (estado !== "Todos") ok = ok && p.estado === estado;
            if (tipo !== "Todos") ok = ok && p.tipo === tipo;
            if (prioridad !== "Todas") ok = ok && p.prioridad === prioridad;

            if (texto) {
                const blob = [
                    p.nombre_obra,
                    p.cliente_principal,
                    p.ciudad,
                    p.provincia
                ].join(" ").toLowerCase();
                ok = ok && blob.includes(texto);
            }

            return ok;
        });

        pintarKPIs();
        pintarTabla();
    }

    function pintarKPIs() {
        const total = proyectosFiltrados.length;
        const seguimiento = proyectosFiltrados.filter(
            p => p.estado && p.estado !== "Detectado"
        ).length;
        const ganados = proyectosFiltrados.filter(
            p => p.estado === "Ganado"
        ).length;

        kpiTotal.textContent = total;
        kpiSeguimiento.textContent = seguimiento;
        kpiGanados.textContent = ganados;
    }

    function badgeClass(estado) {
        if (!estado) return "badge detectado";
        const e = estado.toLowerCase();
        if (e === "detectado") return "badge detectado";
        if (e.includes("prescripci√≥n")) return "badge prescripcion";
        if (e.includes("oferta")) return "badge oferta";
        if (e.includes("negociaci√≥n")) return "badge negociacion";
        if (e === "ganado") return "badge ganado";
        if (e === "perdido") return "badge perdido";
        if (e === "paralizado") return "badge paralizado";
        return "badge detectado";
    }

    function pintarTabla() {
        selectedIds = [];

        if (!proyectosFiltrados.length) {
            tablaWrapper.innerHTML = "";
            emptyState.style.display = "block";
            return;
        }
        emptyState.style.display = "none";

        let html = `
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll"/></th>
                        <th>Proyecto</th>
                        <th>Cliente</th>
                        <th>Ciudad</th>
                        <th>Provincia</th>
                        <th>Estado</th>
                        <th>Prioridad</th>
                        <th>Tipo</th>
                        <th>Potencial (‚Ç¨)</th>
                    </tr>
                </thead>
                <tbody>
        `;

        proyectosFiltrados.forEach(p => {
            const pot = p.potencial_eur
                ? Number(p.potencial_eur).toLocaleString("es-ES")
                : "‚Äì";

            html += `
                <tr data-id="${p.id}">
                    <td><input type="checkbox" class="rowCheck"/></td>
                    <td>${p.nombre_obra || ""}</td>
                    <td>${p.cliente_principal || ""}</td>
                    <td>${p.ciudad || ""}</td>
                    <td>${p.provincia || ""}</td>
                    <td><span class="${badgeClass(p.estado)}">${p.estado || ""}</span></td>
                    <td>${p.prioridad || ""}</td>
                    <td>${p.tipo || ""}</td>
                    <td>${pot}</td>
                </tr>
            `;
        });

        html += `</tbody></table>`;
        tablaWrapper.innerHTML = html;

        const selectAll = document.getElementById("selectAll");
        const rowChecks = Array.from(document.querySelectorAll(".rowCheck"));

        selectAll.addEventListener("change", () => {
            selectedIds = [];
            rowChecks.forEach((chk, idx) => {
                chk.checked = selectAll.checked;
                if (chk.checked) selectedIds.push(proyectosFiltrados[idx].id);
            });
        });

        rowChecks.forEach((chk, idx) => {
            chk.addEventListener("change", () => {
                const id = proyectosFiltrados[idx].id;
                if (chk.checked) {
                    if (!selectedIds.includes(id)) selectedIds.push(id);
                } else {
                    selectedIds = selectedIds.filter(x => x !== id);
                    selectAll.checked = false;
                }
            });
        });
    }

    function fillForm(p) {
        document.getElementById("projId").value = p?.id || "";
        document.getElementById("nombre_obra").value = p?.nombre_obra || "";
        document.getElementById("cliente_principal").value = p?.cliente_principal || "";
        document.getElementById("ciudad").value = p?.ciudad || "";
        document.getElementById("provincia").value = p?.provincia || "";
        document.getElementById("estado").value =
            ESTADOS_PIPELINE.includes(p?.estado) ? p.estado : "Detectado";
        document.getElementById("prioridad").value = p?.prioridad || "Media";
        document.getElementById("tipo").value = p?.tipo || "Residencial";
        document.getElementById("potencial_eur").value = p?.potencial_eur || "";

        document.getElementById("seguimiento_fecha").value =
            p?.seguimiento_fecha || "";
        document.getElementById("seguimiento_comentario").value =
            p?.seguimiento_comentario || "";
        document.getElementById("tarea_fecha").value = p?.tarea_fecha || "";
        document.getElementById("tarea_comentario").value =
            p?.tarea_comentario || "";
    }

    // === BOTONES GLOBALES ===
    window.openNewProject = function () {
        document.getElementById("dialogTitle").textContent = "Alta de proyecto";
        fillForm(null);
        projectDialog.showModal();
    };

    window.onEditSelected = function () {
        if (selectedIds.length === 0) {
            alert("Selecciona una √∫nica obra para editar.");
            return;
        }
        if (selectedIds.length > 1) {
            alert("Solo puedes editar una obra a la vez.");
            return;
        }
        const id = selectedIds[0];
        const p = proyectos.find(x => x.id === id);
        if (!p) return;
        document.getElementById("dialogTitle").textContent = "Edici√≥n de proyecto";
        fillForm(p);
        projectDialog.showModal();
    };

    window.closeDialog = function () {
        projectDialog.close();
    };

    projectForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const id = document.getElementById("projId").value || null;
        const payload = {
            nombre_obra: document.getElementById("nombre_obra").value.trim(),
            cliente_principal: document.getElementById("cliente_principal").value.trim(),
            ciudad: document.getElementById("ciudad").value.trim(),
            provincia: document.getElementById("provincia").value.trim(),
            estado: document.getElementById("estado").value,
            prioridad: document.getElementById("prioridad").value,
            tipo: document.getElementById("tipo").value,
            potencial_eur: Number(
                document.getElementById("potencial_eur").value || 0
            ),
            seguimiento_fecha: document.getElementById("seguimiento_fecha").value || null,
            seguimiento_comentario: document
                .getElementById("seguimiento_comentario")
                .value.trim(),
            tarea_fecha: document.getElementById("tarea_fecha").value || null,
            tarea_comentario: document
                .getElementById("tarea_comentario")
                .value.trim()
        };

        if (!payload.nombre_obra) {
            alert("El nombre de la obra es obligatorio.");
            return;
        }

        try {
            if (id) {
                const ref = doc(db, "proyectos", id);
                await updateDoc(ref, payload);
                console.log("Proyecto actualizado:", id);
            } else {
                const newDoc = await addDoc(collection(db, "proyectos"), payload);
                console.log("Proyecto creado:", newDoc.id);
            }
            projectDialog.close();
            await cargarProyectos();
        } catch (err) {
            console.error("‚ùå Error guardando proyecto:", err);
            alert("No se pudo guardar el proyecto (mira la consola para m√°s detalle).");
        }
    });

    window.onDeleteSelected = function () {
        if (!selectedIds.length) {
            alert("Selecciona al menos una obra para borrar.");
            return;
        }
        pendingDeleteIds = [...selectedIds];
        deleteText.textContent =
            `Vas a borrar ${pendingDeleteIds.length} proyecto(s). Esta acci√≥n no se puede deshacer.`;
        deleteDialog.showModal();
    };

    window.closeDeleteDialog = function () {
        deleteDialog.close();
    };

    window.confirmDelete = async function () {
        try {
            for (const id of pendingDeleteIds) {
                const ref = doc(db, "proyectos", id);
                await deleteDoc(ref);
                console.log("Proyecto borrado:", id);
            }
            deleteDialog.close();
            await cargarProyectos();
        } catch (err) {
            console.error("‚ùå Error borrando proyectos:", err);
            alert("No se pudo borrar alguno de los proyectos (mira la consola).");
        }
    };

    [fCiudad, fEstado, fTipo, fPrioridad].forEach(el => {
        el.addEventListener("change", aplicarFiltros);
    });
    fTexto.addEventListener("input", aplicarFiltros);

    cargarProyectos();
</script>
