<!--
CRM 2N – Modo Desarrollador Eficiente
Estilo Salesforce Moderno + Apple Clean UI
Firebase optimizado (mínimas lecturas, funciones reutilizables, sin llamadas duplicadas)
-->

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM 2N – Proyectos</title>

    <link rel="stylesheet" href="styles.css">

    <style>
        body {
            margin: 0;
            font-family: Inter, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: #F5F7FA;
            color: #1A1A1A;
        }

        /* NAV SUPERIOR */
        .topnav {
            height: 56px;
            background: #FFFFFF;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            gap: 20px;
        }

        .logo {
            font-size: 18px;
            font-weight: 700;
            color: #4C6EF5;
            margin-right: 12px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            flex: 1;
        }

        .nav-item {
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            color: #333;
            transition: 0.15s;
        }

        .nav-item:hover {
            background: #F1F3F5;
        }

        .nav-item.active {
            color: #4C6EF5;
            font-weight: 600;
            border-bottom: 3px solid #4C6EF5;
            padding-bottom: 5px;
        }

        .search-box {
            background: #F1F3F5;
            border-radius: 6px;
            padding: 6px 12px;
            width: 220px;
            border: 1px solid #E1E3E5;
            outline: none;
            font-size: 13px;
        }

        .content {
            padding: 24px;
        }

        /* PROYECTOS */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
            align-items: center;
        }

        .search-input {
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid #D1D5DB;
            font-size: 13px;
            min-width: 220px;
            outline: none;
        }

        .search-input:focus { border-color: #4C6EF5; }

        .select-input {
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid #D1D5DB;
            font-size: 13px;
            outline: none;
        }

        .btn-primary {
            background: #4C6EF5;
            color: #FFFFFF;
            border: none;
            border-radius: 999px;
            padding: 9px 14px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary:hover { background: #3B5BDB; }

        .project-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .project-card {
            background: white;
            border-radius: 14px;
            padding: 16px 18px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: 0.15s;
        }

        .project-card:hover { transform: translateY(-1px); }

        .project-main {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .project-name {
            font-size: 16px;
            font-weight: 600;
        }

        .project-meta {
            font-size: 13px;
            opacity: 0.8;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            display: inline-block;
        }

        .badge.pipeline { background: #4C6EF5; }
        .badge.prescripcion { background: #FD7E14; }
        .badge.ganado { background: #2F9E44; }
        .badge.perdido { background: #E03131; }

        .project-right {
            text-align: right;
            font-size: 13px;
        }

        .project-importe {
            font-weight: 600;
        }

        .empty-state {
            margin-top: 30px;
            font-size: 14px;
            opacity: 0.7;
        }
    </style>
</head>

<body>

    <!-- NAV SUPERIOR -->
    <div class="topnav">
        <div class="logo">CRM 2N</div>

        <div class="nav-tabs">
            <div class="nav-item" onclick="go('index.html')">Dashboard</div>
            <div class="nav-item active" onclick="go('proyectos.html')">Proyectos</div>
            <div class="nav-item" onclick="go('pipeline.html')">Pipeline</div>
            <div class="nav-item" onclick="go('clientes.html')">Clientes</div>
            <div class="nav-item" onclick="go('tareas.html')">Tareas</div>
            <div class="nav-item" onclick="go('reportes.html')">Reportes</div>
        </div>

        <input type="text" class="search-box" placeholder="Buscar..." />
    </div>

    <main class="content">
        <h2 style="margin-top:0; margin-bottom:12px;">Proyectos</h2>

        <div class="toolbar">
            <input
                id="searchInput"
                class="search-input"
                type="text"
                placeholder="Buscar por nombre, cliente, ciudad..."
            />

            <select id="estadoFilter" class="select-input">
                <option value="todos">Todos los estados</option>
                <option value="Pipeline">Pipeline</option>
                <option value="Prescripción">Prescripción</option>
                <option value="Ganado">Ganado</option>
                <option value="Perdido">Perdido</option>
            </select>

            <button class="btn-primary" onclick="nuevoProyecto()">
                + Nuevo proyecto
            </button>
        </div>

        <div id="projectList" class="project-list"></div>
        <div id="emptyState" class="empty-state" style="display:none;">
            No hay proyectos con estos filtros.
        </div>
    </main>

<script type="module">
    import { db } from "./firebaseConfig.js";
    import {
        collection,
        getDocs
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const projectListEl = document.getElementById("projectList");
    const emptyStateEl = document.getElementById("emptyState");
    const searchInput = document.getElementById("searchInput");
    const estadoFilter = document.getElementById("estadoFilter");

    let proyectos = [];
    let proyectosFiltrados = [];

    async function cargarProyectos() {
        const ref = collection(db, "proyectos");
        const snap = await getDocs(ref);

        proyectos = [];
        snap.forEach(doc => {
            proyectos.push({
                id: doc.id,
                ...doc.data()
            });
        });

        aplicarFiltros();
    }

    function aplicarFiltros() {
        const texto = (searchInput.value || "").toLowerCase();
        const estado = estadoFilter.value;

        proyectosFiltrados = proyectos.filter(p => {
            const matchTexto =
                !texto ||
                (p.nombre && p.nombre.toLowerCase().includes(texto)) ||
                (p.cliente && p.cliente.toLowerCase().includes(texto)) ||
                (p.ciudad && p.ciudad.toLowerCase().includes(texto));

            const matchEstado =
                estado === "todos" ||
                (p.estado && p.estado === estado);

            return matchTexto && matchEstado;
        });

        pintarLista();
    }

    function pintarLista() {
        projectListEl.innerHTML = "";

        if (!proyectosFiltrados.length) {
            emptyStateEl.style.display = "block";
            return;
        } else {
            emptyStateEl.style.display = "none";
        }

        proyectosFiltrados.forEach(p => {
            const estado = p.estado || "Pipeline";
            const estadoClass =
                estado === "Pipeline" ? "pipeline" :
                estado === "Prescripción" ? "prescripcion" :
                estado === "Ganado" ? "ganado" :
                estado === "Perdido" ? "perdido" :
                "pipeline";

            const importe = p.importe ? `${p.importe.toLocaleString("es-ES")} €` : "–";

            const card = document.createElement("div");
            card.className = "project-card";
            card.onclick = () => verProyecto(p.id);

            card.innerHTML = `
                <div class="project-main">
                    <div class="project-name">${p.nombre || "Sin nombre"}</div>
                    <div class="project-meta">
                        <b>Cliente:</b> ${p.cliente || "-"} ·
                        <b>Ciudad:</b> ${p.ciudad || "-"} ·
                        <b>Fecha:</b> ${p.fecha || "-"}
                    </div>
                </div>
                <div class="project-right">
                    <div class="badge ${estadoClass}">${estado}</div>
                    <div class="project-importe">${importe}</div>
                    <div>${p.tipo || ""}</div>
                </div>
            `;

            projectListEl.appendChild(card);
        });
    }

    window.nuevoProyecto = function() {
        window.location.href = "proyecto_nuevo.html";
    };

    window.verProyecto = function(id) {
        window.location.href = `proyecto_detalle.html?id=${id}`;
    };

    searchInput.addEventListener("input", aplicarFiltros);
    estadoFilter.addEventListener("change", aplicarFiltros);

    cargarProyectos();

    window.go = function(ruta) {
        window.location.href = ruta;
    };
</script>

</body>
</html>
