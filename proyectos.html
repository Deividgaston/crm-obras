<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CRM 2N ‚Äì Proyectos</title>

    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
   
  <script>
    const esMovil = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    if (esMovil) {
      window.location.href = "mobile-proyectos.html";
    }
  </script>
  

    <!-- NAV SUPERIOR -->
    <div class="topnav">
        <div class="logo">CRM 2N</div>

        <div class="nav-tabs">
            <div class="nav-item" onclick="location.href='index.html'">Dashboard</div>
            <div class="nav-item active" onclick="location.href='proyectos.html'">Proyectos</div>
            <div class="nav-item" onclick="location.href='buscar.html'">Buscar</div>
            <div class="nav-item" onclick="location.href='pipeline.html'">Pipeline</div>
            <div class="nav-item" onclick="location.href='clientes.html'">Clientes</div>
            <div class="nav-item" onclick="location.href='tareas.html'">Tareas</div>
            <div class="nav-item" onclick="location.href='reportes.html'">Reportes</div>
        </div>

        <div style="display:flex;align-items:center;gap:8px;">
            <input type="text" class="search-box" placeholder="Buscar..." />
            <button
                id="btnLogout"
                type="button"
                style="
                    font-size:11px;
                    padding:6px 10px;
                    border-radius:999px;
                    border:1px solid #E5E7EB;
                    background:#FFFFFF;
                    color:#111827;
                    cursor:pointer;
                    white-space:nowrap;
                "
            >
                Cerrar sesi√≥n
            </button>
        </div>
    </div>

    <main class="content">
        <h2 style="margin-top:0; margin-bottom:4px; color:#16325C;">Proyectos</h2>
        <div style="font-size:12px;color:#5A6872;margin-bottom:14px;">
            Vista general ¬∑ Edita, borra o importa proyectos desde Excel (Prompt / Construdata)
        </div>

        <!-- FILTROS -->
        <div class="filters-row">
            <select id="fCiudad" class="select-input">
                <option value="Todas">Ciudad: todas</option>
            </select>
            <select id="fEstado" class="select-input">
                <option value="Todos">Estado: todos</option>
            </select>
            <select id="fTipo" class="select-input">
                <option value="Todos">Tipo: todos</option>
            </select>
            <select id="fPrioridad" class="select-input">
                <option value="Todas">Prioridad: todas</option>
            </select>
            <select id="fEncaje2N" class="select-input">
                <option value="Todos">Encaje 2N: todos</option>
                <option value="ALTO">Encaje 2N: ALTO</option>
                <option value="MEDIO">Encaje 2N: MEDIO</option>
                <option value="BAJO">Encaje 2N: BAJO</option>
                <option value="SIN">Encaje 2N: sin dato</option>
            </select>
            <input id="fTexto" class="search-input" placeholder="Buscar texto..." />
        </div>

        <!-- KPIs -->
        <div class="kpi-row">
            <div class="kpi-card">
                <div class="kpi-label">Total</div>
                <div id="kpiTotal" class="kpi-value">‚Äì</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Seguimiento</div>
                <div id="kpiSeguimiento" class="kpi-value">‚Äì</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Ganados</div>
                <div id="kpiGanados" class="kpi-value">‚Äì</div>
            </div>
        </div>

        <!-- TOOLBAR -->
        <div class="toolbar-table">
            <button class="btn-primary" onclick="openNewProject()">+ Nuevo proyecto</button>
            <button class="btn-icon" onclick="onEditSelected()" title="Editar proyecto">‚úèÔ∏è</button>
            <button class="btn-icon" onclick="onDeleteSelected()" title="Borrar proyectos">üóëÔ∏è</button>
            <button class="btn-icon" onclick="openImport()" title="Importar Excel">‚¨ÜÔ∏è</button>
            <input type="file" id="fileImport" accept=".xlsx,.xls,.csv" style="display:none" />
        </div>

        <!-- TABLA -->
        <div id="tablaWrapper"></div>
        <div id="emptyState" class="empty-state" style="display:none;">
            No hay proyectos con los filtros seleccionados.
        </div>
    </main>

    <!-- MODAL PROYECTO -->
    <dialog id="projectDialog">
        <div class="modal-header" id="dialogTitle">Proyecto</div>
        <form id="projectForm" method="dialog">

            <input type="hidden" id="projId" />
            <input type="hidden" id="fuente" />

            <div class="form-grid">

                <div class="form-group">
                    <label for="nombre_obra">Nombre de la obra</label>
                    <input id="nombre_obra" required />
                </div>

                <div class="form-group">
                    <label for="cliente_principal">Cliente principal</label>
                    <input id="cliente_principal" />
                </div>

                <div class="form-group">
                    <label for="ciudad">Ciudad</label>
                    <input id="ciudad" />
                </div>

                <div class="form-group">
                    <label for="provincia">Provincia</label>
                    <input id="provincia" />
                </div>

                <div class="form-group">
                    <label for="estado">Estado</label>
                    <select id="estado">
                        <option>Detectado</option>
                        <option>En Prescripci√≥n</option>
                        <option>Oferta Enviada</option>
                        <option>Negociaci√≥n</option>
                        <option>Ganado</option>
                        <option>Perdido</option>
                        <option>Paralizado</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="prioridad">Prioridad</label>
                    <select id="prioridad">
                        <option>Alta</option>
                        <option selected>Media</option>
                        <option>Baja</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tipo">Tipo</label>
                    <select id="tipo">
                        <option>Residencial</option>
                        <option>Terciario</option>
                        <option>Mixto</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="potencial_eur">Potencial (‚Ç¨)</label>
                    <input id="potencial_eur" type="number" min="0" />
                </div>

                <div class="form-group">
                    <label for="url_obra">URL obra</label>
                    <input id="url_obra" placeholder="https://..." />
                </div>

                <div class="form-group">
                    <label for="seguimiento_fecha">Fecha seguimiento</label>
                    <input id="seguimiento_fecha" type="date" />
                </div>

                <div class="form-group">
                    <label for="seguimiento_comentario">Comentario seguimiento</label>
                    <textarea id="seguimiento_comentario"></textarea>
                </div>

                <div class="form-group">
                    <label for="tarea_fecha">Fecha tarea</label>
                    <input id="tarea_fecha" type="date" />
                </div>

                <div class="form-group">
                    <label for="tarea_comentario">Comentario tarea</label>
                    <textarea id="tarea_comentario"></textarea>
                </div>

            </div>

            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeDialog()">Cancelar</button>
                <button type="submit" class="btn-primary">Guardar</button>
            </div>

        </form>
    </dialog>

    <!-- MODAL BORRADO -->
    <dialog id="deleteDialog">
        <div class="modal-header">Confirmar borrado</div>
        <p id="deleteText"></p>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="closeDeleteDialog()">Cancelar</button>
            <button type="button" class="btn-primary" onclick="confirmDelete()">Borrar</button>
        </div>
    </dialog>

    <script type="module">

        import { db, auth } from "./firebase.js";
        import {
            collection,
            getDocs,
            addDoc,
            updateDoc,
            deleteDoc,
            doc
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const fCiudad = document.getElementById("fCiudad");
        const fEstado = document.getElementById("fEstado");
        const fTipo = document.getElementById("fTipo");
        const fPrioridad = document.getElementById("fPrioridad");
        const fEncaje2N = document.getElementById("fEncaje2N");
        const fTexto = document.getElementById("fTexto");

        const kpiTotal = document.getElementById("kpiTotal");
        const kpiSeguimiento = document.getElementById("kpiSeguimiento");
        const kpiGanados = document.getElementById("kpiGanados");

        const tablaWrapper = document.getElementById("tablaWrapper");
        const emptyState = document.getElementById("emptyState");

        const projectDialog = document.getElementById("projectDialog");
        const projectForm = document.getElementById("projectForm");

        const deleteDialog = document.getElementById("deleteDialog");
        const deleteText = document.getElementById("deleteText");

        const fileInput = document.getElementById("fileImport");

        let proyectos = [];
        let proyectosFiltrados = [];
        let selectedIds = [];
        let pendingDeleteIds = [];

        async function cargarProyectos() {
            try {
                const ref = collection(db, "proyectos");
                const snap = await getDocs(ref);

                proyectos = [];
                snap.forEach(d => proyectos.push({ id: d.id, ...d.data() }));

                inicializarFiltros();
                aplicarFiltros();

            } catch (err) {
                console.error("‚ùå Error Firestore:", err);
                tablaWrapper.innerHTML = "<div>Error cargando Firestore.</div>";
            }
        }

        function inicializarFiltros() {
            const ciudades = [...new Set(proyectos.map(p => p.ciudad).filter(Boolean))].sort();
            const estados = [...new Set(proyectos.map(p => p.estado).filter(Boolean))];
            const tipos = [...new Set(proyectos.map(p => p.tipo).filter(Boolean))];
            const prioridades = [...new Set(proyectos.map(p => p.prioridad).filter(Boolean))];

            fCiudad.innerHTML =
                '<option value="Todas">Ciudad: todas</option>' +
                ciudades.map(c => `<option value="${c}">${c}</option>`).join("");

            fEstado.innerHTML =
                '<option value="Todos">Estado: todos</option>' +
                estados.map(e => `<option value="${e}">${e}</option>`).join("");

            fTipo.innerHTML =
                '<option value="Todos">Tipo: todos</option>' +
                tipos.map(t => `<option value="${t}">${t}</option>`).join("");

            fPrioridad.innerHTML =
                '<option value="Todas">Prioridad: todas</option>' +
                prioridades.map(pr => `<option value="${pr}">${pr}</option>`).join("");
        }

        function aplicarFiltros() {
            const ciudad = fCiudad.value;
            const estado = fEstado.value;
            const tipo = fTipo.value;
            const prioridad = fPrioridad.value;
            const texto = (fTexto.value || "").toLowerCase();
            const encajeFiltro = fEncaje2N.value;

            proyectosFiltrados = proyectos.filter(p => {
                let ok = true;

                if (ciudad !== "Todas") ok = ok && p.ciudad === ciudad;
                if (estado !== "Todos") ok = ok && p.estado === estado;
                if (tipo !== "Todos") ok = ok && p.tipo === tipo;
                if (prioridad !== "Todas") ok = ok && p.prioridad === prioridad;

                const enc = (p.encaje_2n || "").toUpperCase().trim();
                if (encajeFiltro !== "Todos") {
                    if (encajeFiltro === "SIN") ok = ok && !enc;
                    else ok = ok && enc === encajeFiltro;
                }

                if (texto) {
                    const blob = [
                        p.nombre_obra,
                        p.cliente_principal,
                        p.ciudad,
                        p.provincia
                    ].join(" ").toLowerCase();
                    ok = ok && blob.includes(texto);
                }

                return ok;
            });

            kpiTotal.textContent = proyectosFiltrados.length;
            kpiSeguimiento.textContent =
                proyectosFiltrados.filter(p => p.seguimiento_fecha).length;
            kpiGanados.textContent =
                proyectosFiltrados.filter(p => p.estado === "Ganado").length;

            pintarTabla();
        }

        function badgeClass(estado) {
            if (!estado) return "badge detectado";
            const e = estado.toLowerCase();
            if (e === "detectado") return "badge detectado";
            if (e.includes("prescripci√≥n") || e.includes("prescripcion")) return "badge prescripcion";
            if (e.includes("oferta")) return "badge oferta";
            if (e.includes("negociaci√≥n") || e.includes("negociacion")) return "badge negociacion";
            if (e === "ganado") return "badge ganado";
            if (e === "perdido") return "badge perdido";
            if (e === "paralizado") return "badge paralizado";
            return "badge detectado";
        }

        function fuenteBadge(fuente) {
            const f = (fuente || "").toLowerCase();
            if (f === "construdata") return '<span class="badge oferta">Construdata</span>';
            if (f === "prompt") return '<span class="badge prescripcion">AI / Prompt</span>';
            return '<span class="badge detectado">Manual</span>';
        }

        function renderUrl(url) {
            if (!url) return "";
            const href = url.startsWith("http") ? url : "https://" + url;
            return `<a href="${href}" target="_blank">üîó</a>`;
        }

        function pintarTabla() {
            selectedIds = [];

            if (!proyectosFiltrados.length) {
                tablaWrapper.innerHTML = "";
                emptyState.style.display = "block";
                return;
            }

            emptyState.style.display = "none";

            let html = `
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" /></th>
                        <th>Proyecto</th>
                        <th>Cliente</th>
                        <th>Ciudad</th>
                        <th>Provincia</th>
                        <th>Estado</th>
                        <th>Prioridad</th>
                        <th>Tipo</th>
                        <th>Potencial (‚Ç¨)</th>
                        <th>Fuente</th>
                        <th>Enlace</th>
                        <th>Encaje 2N</th>
                    </tr>
                </thead>
                <tbody>
            `;

            proyectosFiltrados.forEach(p => {
                const pot = p.potencial_eur
                    ? Number(p.potencial_eur).toLocaleString("es-ES")
                    : "‚Äì";

                html += `
                <tr data-id="${p.id}">
                    <td><input type="checkbox" class="rowCheck" /></td>

                    <td>
                        <button class="proj-title-btn" data-id="${p.id}" style="
                            border:none;background:none;padding:0;margin:0;text-align:left;
                            cursor:pointer;font-size:12px;font-weight:600;color:#111827;">
                            ${p.nombre_obra}
                        </button>
                    </td>

                    <td>${p.cliente_principal || ""}</td>
                    <td>${p.ciudad || ""}</td>
                    <td>${p.provincia || ""}</td>

                    <td><span class="${badgeClass(p.estado)}">${p.estado}</span></td>

                    <td>${p.prioridad || ""}</td>
                    <td>${p.tipo || ""}</td>
                    <td>${pot}</td>
                    <td>${fuenteBadge(p.fuente)}</td>
                    <td>${renderUrl(p.url_obra)}</td>
                    <td>${(p.encaje_2n || "").toUpperCase()}</td>
                </tr>
                `;
            });

            html += `</tbody></table>`;
            tablaWrapper.innerHTML = html;

            const selectAll = document.getElementById("selectAll");
            const rowChecks = [...document.querySelectorAll(".rowCheck")];

            selectAll.addEventListener("change", () => {
                selectedIds = [];
                rowChecks.forEach((chk, i) => {
                    chk.checked = selectAll.checked;
                    if (chk.checked) selectedIds.push(proyectosFiltrados[i].id);
                });
            });

            rowChecks.forEach((chk, i) => {
                chk.addEventListener("change", () => {
                    const id = proyectosFiltrados[i].id;
                    if (chk.checked) {
                        if (!selectedIds.includes(id)) selectedIds.push(id);
                    } else {
                        selectedIds = selectedIds.filter(x => x !== id);
                        selectAll.checked = false;
                    }
                });
            });

            // click en t√≠tulo abre modal de edici√≥n
            document.querySelectorAll(".proj-title-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const id = btn.dataset.id;
                    const p = proyectos.find(x => x.id === id);
                    if (!p) return;
                    document.getElementById("dialogTitle").textContent = "Edici√≥n de proyecto";
                    fillForm(p);
                    projectDialog.showModal();
                });
            });
        }

        function fillForm(p) {
            document.getElementById("projId").value = p?.id || "";
            document.getElementById("nombre_obra").value = p?.nombre_obra || "";
            document.getElementById("cliente_principal").value = p?.cliente_principal || "";
            document.getElementById("ciudad").value = p?.ciudad || "";
            document.getElementById("provincia").value = p?.provincia || "";
            document.getElementById("estado").value = p?.estado || "Detectado";
            document.getElementById("prioridad").value = p?.prioridad || "Media";
            document.getElementById("tipo").value = p?.tipo || "Residencial";
            document.getElementById("potencial_eur").value = p?.potencial_eur || "";
            document.getElementById("url_obra").value = p?.url_obra || "";
            document.getElementById("seguimiento_fecha").value = p?.seguimiento_fecha || "";
            document.getElementById("seguimiento_comentario").value = p?.seguimiento_comentario || "";
            document.getElementById("tarea_fecha").value = p?.tarea_fecha || "";
            document.getElementById("tarea_comentario").value = p?.tarea_comentario || "";
            document.getElementById("fuente").value = p?.fuente || "manual";
        }

        window.openNewProject = function () {
            document.getElementById("dialogTitle").textContent = "Nuevo proyecto";
            fillForm(null);
            projectDialog.showModal();
        };

        function closeDialog() {
            projectDialog.close();
        }
        window.closeDialog = closeDialog;

        projectForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            const id = document.getElementById("projId").value;

            const payload = {
                nombre_obra: document.getElementById("nombre_obra").value.trim(),
                cliente_principal: document.getElementById("cliente_principal").value.trim(),
                ciudad: document.getElementById("ciudad").value.trim(),
                provincia: document.getElementById("provincia").value.trim(),
                estado: document.getElementById("estado").value,
                prioridad: document.getElementById("prioridad").value,
                tipo: document.getElementById("tipo").value,
                potencial_eur: Number(document.getElementById("potencial_eur").value || 0),
                url_obra: document.getElementById("url_obra").value.trim(),
                seguimiento_fecha: document.getElementById("seguimiento_fecha").value || null,
                seguimiento_comentario: document.getElementById("seguimiento_comentario").value.trim(),
                tarea_fecha: document.getElementById("tarea_fecha").value || null,
                tarea_comentario: document.getElementById("tarea_comentario").value.trim(),
                fuente: document.getElementById("fuente").value
            };

            try {
                if (id) {
                    // actualizaci√≥n: no tocamos ownerId
                    await updateDoc(doc(db, "proyectos", id), payload);
                } else {
                    // creaci√≥n: a√±adimos ownerId seg√∫n el usuario autenticado
                    const ownerId = auth.currentUser ? auth.currentUser.uid : null;
                    await addDoc(collection(db, "proyectos"), {
                        ...payload,
                        ownerId: ownerId || ""
                    });
                }

                projectDialog.close();
                cargarProyectos();

            } catch (err) {
                console.error("‚ùå Error guardando:", err);
                alert("Error guardando el proyecto.");
            }
        });

        window.onEditSelected = function () {
            if (selectedIds.length !== 1) {
                alert("Selecciona un √∫nico proyecto para editar.");
                return;
            }
            const id = selectedIds[0];
            const p = proyectos.find(x => x.id === id);
            document.getElementById("dialogTitle").textContent = "Editar proyecto";
            fillForm(p);
            projectDialog.showModal();
        };

        window.onDeleteSelected = function () {
            if (!selectedIds.length) {
                alert("Selecciona proyectos a borrar.");
                return;
            }
            pendingDeleteIds = [...selectedIds];
            deleteText.textContent = `Se van a borrar ${pendingDeleteIds.length} proyecto(s).`;
            deleteDialog.showModal();
        };

        function closeDeleteDialog() {
            deleteDialog.close();
        }
        window.closeDeleteDialog = closeDeleteDialog;

        window.confirmDelete = async function () {
            try {
                for (const id of pendingDeleteIds) {
                    await deleteDoc(doc(db, "proyectos", id));
                }
                deleteDialog.close();
                cargarProyectos();

            } catch (err) {
                console.error("‚ùå Error borrando:", err);
                alert("Error borrando proyecto.");
            }
        };

        window.openImport = function () {
            fileInput.value = "";
            fileInput.click();
        };

        fileInput.addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const rows = await readExcelFile(file);

                if (!rows.length) {
                    alert("El Excel est√° vac√≠o.");
                    return;
                }

                const mapped = rows
                    .map(row => {
                        const p = mapRowToProyecto(row);
                        if (!p.nombre_obra) return null;
                        p.fuente = detectSource(row);
                        return p;
                    })
                    .filter(Boolean);

                const existingKeys = new Set(proyectos.map(p => makeKey(p)));
                const batchKeys = new Set();
                const toImport = [];
                const duplicates = [];

                for (const p of mapped) {
                    const key = makeKey(p);
                    if (existingKeys.has(key) || batchKeys.has(key)) {
                        duplicates.push(p);
                        continue;
                    }
                    batchKeys.add(key);
                    toImport.push(p);
                }

                const ref = collection(db, "proyectos");
                const ownerId = auth.currentUser ? auth.currentUser.uid : null;

                for (const p of toImport) {
                    await addDoc(ref, {
                        ...p,
                        ownerId: ownerId || ""
                    });
                }

                alert(`Importados ${toImport.length} proyectos.\nDuplicados ignorados: ${duplicates.length}`);

                cargarProyectos();

            } catch (err) {
                console.error(err);
                alert("Error importando Excel.");
            }
        });

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: "array" });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
                        resolve(json);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function makeKey(p) {
            return [
                (p.nombre_obra || "").toLowerCase().trim(),
                (p.ciudad || "").toLowerCase().trim(),
                (p.cliente_principal || "").toLowerCase().trim()
            ].join("|");
        }

        function detectSource(row) {
            const keys = Object.keys(row).map(k => k.toLowerCase());
            if (keys.some(k => k.includes("obra:url"))) return "construdata";
            return "prompt";
        }

        function normalizeHeaderKey(key) {
            return key.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "");
        }

        const HEADER_MAP = {
            nombre_obra: ["nombre_obra","obra","obranombre","proyecto","obra:Nombre"],
            cliente_principal: ["cliente_principal","cliente","promotor","promotor1:empresa"],
            ciudad: ["ciudad","localidad","municipio","obra:localidad"],
            provincia: ["provincia"],
            prioridad: ["prioridad"],
            tipo: ["tipo","tipologia"],
            potencial_eur: ["potencial_eur","presupuesto","importe","obra:presupuesto"],
            url_obra: ["url_obra","obra:url","enlace","obra:url (enlace obra)"],
            seguimiento_fecha: ["seguimiento_fecha","fecha seguimiento","obra:fecha hito actual"],
            seguimiento_comentario: ["seguimiento_comentario","comentario seguimiento"],
            tarea_fecha: ["tarea_fecha","fecha tarea"],
            tarea_comentario: ["tarea_comentario","comentario tarea"],
            encaje_2n: ["encaje_2n","encaje 2n"],
            motivo_encaje_2n: ["motivo_encaje_2n","motivo encaje 2n"]
        };

        function getCell(row, variants) {
            for (const v of variants) {
                if (row[v] !== undefined && row[v] !== "") return row[v];
            }
            const normalized = variants.map(normalizeHeaderKey);
            for (const key of Object.keys(row)) {
                const nk = normalizeHeaderKey(key);
                if (normalized.includes(nk)) return row[key];
            }
            return "";
        }

        function normalizeDate(value) {
            if (!value) return "";
            if (typeof value === "string" && value.includes("-")) return value;
            if (typeof value === "string" && value.includes("/")) {
                const [d,m,y] = value.split("/");
                return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
            }
            if (typeof value === "number") {
                const date = XLSX.SSF.parse_date_code(value);
                if (!date) return "";
                return `${date.y}-${String(date.m).padStart(2,"0")}-${String(date.d).padStart(2,"0")}`;
            }
            return "";
        }

        function mapRowToProyecto(row) {
            return {
                nombre_obra: getCell(row, HEADER_MAP.nombre_obra).toString().trim(),
                cliente_principal: getCell(row, HEADER_MAP.cliente_principal).toString().trim(),
                ciudad: getCell(row, HEADER_MAP.ciudad).toString().trim(),
                provincia: getCell(row, HEADER_MAP.provincia).toString().trim(),

                // TODO IMPORTADO ‚Üí SIEMPRE ESTADO DETECTADO
                estado: "Detectado",

                prioridad: getCell(row, HEADER_MAP.prioridad) || "Media",
                tipo: getCell(row, HEADER_MAP.tipo) || "Residencial",
                potencial_eur: Number(getCell(row, HEADER_MAP.potencial_eur) || 0),

                url_obra: getCell(row, HEADER_MAP.url_obra).toString().trim(),

                seguimiento_fecha: normalizeDate(getCell(row, HEADER_MAP.seguimiento_fecha)),
                seguimiento_comentario: getCell(row, HEADER_MAP.seguimiento_comentario).toString().trim(),

                tarea_fecha: normalizeDate(getCell(row, HEADER_MAP.tarea_fecha)),
                tarea_comentario: getCell(row, HEADER_MAP.tarea_comentario).toString().trim(),

                encaje_2n: getCell(row, HEADER_MAP.encaje_2n).toString().trim(),
                motivo_encaje_2n: getCell(row, HEADER_MAP.motivo_encaje_2n).toString().trim()
            };
        }

        fCiudad.addEventListener("change", aplicarFiltros);
        fEstado.addEventListener("change", aplicarFiltros);
        fTipo.addEventListener("change", aplicarFiltros);
        fPrioridad.addEventListener("change", aplicarFiltros);
        fEncaje2N.addEventListener("change", aplicarFiltros);
        fTexto.addEventListener("input", aplicarFiltros);

        cargarProyectos();

    </script>

    <!-- Guardia de autenticaci√≥n -->
    <script type="module" src="auth.js"></script>
</body>
</html>
