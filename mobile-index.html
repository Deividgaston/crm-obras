<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM 2N ‚Äì Inicio (M√≥vil)</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="mobile.css" />
</head>

<body>
  <div class="topnav">
    <div class="logo">CRM 2N ¬∑ M√≥vil</div>
    <div style="display:flex;align-items:center;gap:6px;">
      <span id="mobileUserEmail" style="font-size:11px;color:#475569;"></span>
      <button id="btnLogout"
        style="font-size:11px;padding:4px 8px;border-radius:999px;
               border:1px solid #E5E7EB;background:#FFFFFF;color:#111827;">
        Salir
      </button>
    </div>
  </div>

  <main class="content">
    <div class="mobile-shell">

      <div class="mobile-title">Resumen r√°pido</div>
      <div class="mobile-subtitle">Vista ligera para acceso m√≥vil.</div>

      <input id="searchMobile" type="text" class="search-input-mobile"
        placeholder="Buscar obra / cliente / ciudad..." />

      <div class="mobile-kpis">
        <div class="mobile-kpi">
          <div class="mobile-kpi-label">Proyectos totales</div>
          <div id="kpiMobileProyectos" class="mobile-kpi-value">‚Äì</div>
        </div>
        <div class="mobile-kpi">
          <div class="mobile-kpi-label">Encaje ALTO / MEDIO</div>
          <div id="kpiMobileEncaje" class="mobile-kpi-value">‚Äì</div>
        </div>
        <div class="mobile-kpi">
          <div class="mobile-kpi-label">Tareas abiertas</div>
          <div id="kpiMobileTareas" class="mobile-kpi-value">‚Äì</div>
        </div>
        <div class="mobile-kpi">
          <div class="mobile-kpi-label">Clientes con 2N activo</div>
          <div id="kpiMobileClientes2N" class="mobile-kpi-value">‚Äì</div>
        </div>
      </div>

      <section class="mobile-section">
        <div class="mobile-section-title">Pr√≥ximos seguimientos</div>
        <div class="mobile-section-sub">Tareas por fecha.</div>
        <div id="listaTareas" class="mobile-list"></div>
      </section>

      <section class="mobile-section">
        <div class="mobile-section-title">Proyectos recientes</div>
        <div class="mobile-section-sub">√öltimas obras modificadas.</div>
        <div id="listaProyectos" class="mobile-list"></div>
      </section>

      <section class="mobile-section">
        <div class="mobile-section-title">Clientes con 2N activo</div>
        <div class="mobile-section-sub">Clientes marcados como activos.</div>
        <div id="listaClientes" class="mobile-list"></div>
      </section>

    </div>
  </main>

  <div class="mobile-bottombar">
    <div class="mobile-nav-item active" onclick="location.href='mobile-index.html'">
      <span>üè†</span>Inicio
    </div>
    <div class="mobile-nav-item" onclick="location.href='mobile-proyectos.html'">
      <span>üèóÔ∏è</span>Proyectos
    </div>
    <div class="mobile-nav-item" onclick="location.href='mobile-tareas.html'">
      <span>‚úÖ</span>Tareas
    </div>
    <div class="mobile-nav-item" onclick="location.href='mobile-clientes.html'">
      <span>üë•</span>Clientes
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import { collection, getDocs }
      from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { onAuthStateChanged }
      from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const kpiProy   = document.getElementById("kpiMobileProyectos");
    const kpiEncaje = document.getElementById("kpiMobileEncaje");
    const kpiTareas = document.getElementById("kpiMobileTareas");
    const kpiCli2N  = document.getElementById("kpiMobileClientes2N");

    const listaTareas   = document.getElementById("listaTareas");
    const listaProy     = document.getElementById("listaProyectos");
    const listaClientes = document.getElementById("listaClientes");

    const searchInput = document.getElementById("searchMobile");
    const userEmailSpan = document.getElementById("mobileUserEmail");

    let proyectos = [];
    let tareas = [];
    let clientes = [];
    let filtro = "";

    function norm(t) {
      return (t || "").normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .toLowerCase().trim();
    }

    function ms(v){ try{ return v?.toMillis ? v.toMillis() : new Date(v).getTime(); }catch{return 0;} }

    async function cargar() {
      const [p,t,c] = await Promise.all([
        getDocs(collection(db,"proyectos")),
        getDocs(collection(db,"tareas")),
        getDocs(collection(db,"clientes")),
      ]);

      proyectos = p.docs.map(d=>({id:d.id,...d.data()}));
      tareas    = t.docs.map(d=>({id:d.id,...d.data()}));
      clientes  = c.docs.map(d=>({id:d.id,...d.data()}));

      renderTodo();
    }

    function renderTodo() {
      // KPIs
      kpiProy.textContent = proyectos.length;
      kpiEncaje.textContent = proyectos.filter(p=>{
        const e=(p.encaje_2n||"").toUpperCase();
        return e==="ALTO"||e==="MEDIO";
      }).length;
      kpiTareas.textContent = tareas.filter(t=>{
        const e=(t.estado||"").toLowerCase();
        return e!=="cerrada" && e!=="completada";
      }).length;
      kpiCli2N.textContent = clientes.filter(c=>c.trabaja_con_2n).length;

      renderProyectos();
      renderTareas();
      renderClientes();
    }

    function renderProyectos() {
      listaProy.innerHTML = "";
      let arr = [...proyectos];
      if (filtro) arr = arr.filter(p =>
        norm(p.nombre_obra||p.nombre||"").includes(filtro)
      );
      arr.sort((a,b)=>ms(b.fecha_actualizacion)-ms(a.fecha_actualizacion));
      arr.slice(0,6).forEach(p=>{
        const card = document.createElement("div");
        card.className = "mobile-card";
        card.innerHTML = `
          <div class="mobile-card-header">
            <div class="mobile-card-title">${p.nombre_obra||p.nombre}</div>
            <div class="mobile-chip">${p.estado||"‚Äì"}</div>
          </div>
          <div class="mobile-card-body">
            ${p.provincia?`<div><strong>Zona:</strong> ${p.provincia}</div>`:""}
          </div>`;
        listaProy.appendChild(card);
      });
    }

    function renderTareas() {
      listaTareas.innerHTML = "";
      let arr = tareas.filter(t=>{
        const e=(t.estado||"").toLowerCase();
        return e!=="cerrada" && e!=="completada";
      });
      if (filtro) arr = arr.filter(t => norm(t.titulo||"").includes(filtro));
      arr.sort((a,b)=>ms(a.fecha_vencimiento)-ms(b.fecha_vencimiento));
      arr.slice(0,5).forEach(t=>{
        const card = document.createElement("div");
        card.className = "mobile-card";
        card.innerHTML = `
          <div class="mobile-card-header">
            <div class="mobile-card-title">${t.titulo}</div>
            <div class="mobile-chip">${t.tipo||""}</div>
          </div>
          <div class="mobile-card-body">
            <div><strong>Fecha:</strong> ${
              t.fecha_vencimiento
                ? new Date(ms(t.fecha_vencimiento)).toLocaleDateString("es-ES")
                : "-"
            }</div>
            ${t.proyectoNombre?`<div><strong>Proyecto:</strong> ${t.proyectoNombre}</div>`:""}
          </div>`;
        listaTareas.appendChild(card);
      });
    }

    function renderClientes() {
      listaClientes.innerHTML="";
      let arr = clientes.filter(c=>c.trabaja_con_2n);
      if (filtro) arr = arr.filter(c => norm(c.nombre||"").includes(filtro));
      arr.sort((a,b)=>(a.nombre||"").localeCompare(b.nombre||"","es"));
      arr.slice(0,8).forEach(c=>{
        const card=document.createElement("div");
        card.className="mobile-card";
        card.innerHTML=`
          <div class="mobile-card-header">
            <div class="mobile-card-title">${c.nombre}</div>
            <div class="mobile-chip mobile-chip-activo">2N activo</div>
          </div>
          <div class="mobile-card-body">
            ${c.tipo?`<div><strong>Tipo:</strong> ${c.tipo}</div>`:""}
            ${c.provincia?`<div><strong>Zona:</strong> ${c.provincia}</div>`:""}
          </div>`;
        listaClientes.appendChild(card);
      });
    }

    searchInput.addEventListener("input",()=>{
      filtro = norm(searchInput.value||"");
      renderTodo();
    });

    onAuthStateChanged(auth,(u)=>{
      if(!u) return location.replace("login.html");
      userEmailSpan.textContent=u.email;
      cargar();
    });
  </script>

  <script type="module" src="auth.js"></script>
</body>
</html>
