<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM 2N â€“ Tareas (MÃ³vil)</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="mobile.css" />
</head>

<body>
  <div class="topnav">
    <div class="logo">CRM 2N Â· Tareas (MÃ³vil)</div>
    <div style="display:flex;align-items:center;gap:6px;">
      <span id="mobileUserEmail" style="font-size:11px;color:#475569;"></span>
      <button id="btnLogout"
        style="font-size:11px;padding:4px 8px;border-radius:999px;
               border:1px solid #E5E7EB;background:#FFFFFF;color:#111827;">
        Salir
      </button>
    </div>
  </div>

  <main class="content">
    <div class="mobile-shell">
      <div class="mobile-title">Tareas y seguimientos</div>
      <div class="mobile-subtitle">
        Vista ligera de seguimientos, tareas recurrentes y notas rÃ¡pidas (solo lectura).
      </div>

      <input
        id="searchMobileTareas"
        class="search-input-mobile"
        placeholder="Buscar por tÃ­tulo, proyecto, cliente..."
      />

      <div class="mobile-filters-row">
        <select id="fTipo" class="mobile-select">
          <option value="Todos">Tipo: todos</option>
        </select>
        <select id="fPrioridad" class="mobile-select">
          <option value="Todas">Prioridad: todas</option>
          <option value="alta">Alta</option>
          <option value="media">Media</option>
          <option value="baja">Baja</option>
        </select>
        <select id="fEstado" class="mobile-select">
          <option value="Todos">Estado: todos</option>
          <option value="abiertas">Solo abiertas</option>
          <option value="cerradas">Solo cerradas</option>
        </select>
      </div>

      <div class="mobile-kpis">
        <div class="mobile-kpi">
          <div class="mobile-kpi-label">Tareas abiertas</div>
          <div id="kpiAbiertas" class="mobile-kpi-value">â€“</div>
          <div class="mobile-kpi-footnote">Seguimientos activos.</div>
        </div>
        <div class="mobile-kpi">
          <div class="mobile-kpi-label">PrÃ³ximos 7 dÃ­as</div>
          <div id="kpiProximas" class="mobile-kpi-value">â€“</div>
          <div class="mobile-kpi-footnote">Vencimiento en una semana.</div>
        </div>
        <div class="mobile-kpi">
          <div class="mobile-kpi-label">Notas rÃ¡pidas</div>
          <div id="kpiNotas" class="mobile-kpi-value">â€“</div>
        </div>
        <div class="mobile-kpi">
          <div class="mobile-kpi-label">Total tareas</div>
          <div id="kpiTotal" class="mobile-kpi-value">â€“</div>
        </div>
      </div>

      <section class="mobile-section">
        <div class="mobile-section-title">Hoy y prÃ³ximos seguimientos</div>
        <div class="mobile-section-sub">Ordenadas por fecha de vencimiento.</div>
        <div id="listaProximas" class="mobile-list"></div>
      </section>

      <section class="mobile-section">
        <div class="mobile-section-title">Tareas vencidas</div>
        <div class="mobile-section-sub">Seguimientos que se han pasado de fecha y siguen abiertos.</div>
        <div id="listaVencidas" class="mobile-list"></div>
      </section>

      <section class="mobile-section">
        <div class="mobile-section-title">Notas rÃ¡pidas (recientes)</div>
        <div class="mobile-section-sub">Notas de tipo rÃ¡pido / recordatorio.</div>
        <div id="listaNotas" class="mobile-list"></div>
      </section>
    </div>
  </main>

  <div class="mobile-bottombar">
    <div class="mobile-nav-item" onclick="location.href='mobile-index.html'">
      <span>ğŸ </span>Inicio
    </div>
    <div class="mobile-nav-item" onclick="location.href='mobile-proyectos.html'">
      <span>ğŸ—ï¸</span>Proyectos
    </div>
    <div class="mobile-nav-item active" onclick="location.href='mobile-tareas.html'">
      <span>âœ…</span>Tareas
    </div>
    <div class="mobile-nav-item" onclick="location.href='mobile-clientes.html'">
      <span>ğŸ‘¥</span>Clientes
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import { collection, getDocs }
      from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { onAuthStateChanged }
      from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const userEmailSpan = document.getElementById("mobileUserEmail");

    const searchInput    = document.getElementById("searchMobileTareas");
    const selectTipo     = document.getElementById("fTipo");
    const selectPrioridad= document.getElementById("fPrioridad");
    const selectEstado   = document.getElementById("fEstado");

    const kpiAbiertas  = document.getElementById("kpiAbiertas");
    const kpiProximas  = document.getElementById("kpiProximas");
    const kpiNotas     = document.getElementById("kpiNotas");
    const kpiTotal     = document.getElementById("kpiTotal");

    const listaProximas= document.getElementById("listaProximas");
    const listaVencidas= document.getElementById("listaVencidas");
    const listaNotas   = document.getElementById("listaNotas");

    let tareas = [];
    let filtroTexto = "";

    function norm(t){
      return (t||"").toString().normalize("NFD")
        .replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();
    }
    function ms(v){
      if(!v) return 0;
      try{ return v.toMillis ? v.toMillis() : new Date(v).getTime(); }
      catch{ return 0; }
    }
    function isCerrada(t){
      const e=(t.estado||"").toLowerCase().trim();
      return e==="completada"||e==="cerrada"||e==="hecha";
    }

    async function cargarTareas(){
      const snap = await getDocs(collection(db,"tareas"));
      tareas = snap.docs.map(d=>({id:d.id,...d.data()}));
      inicializarFiltros();
      aplicarFiltrosYRender();
    }

    function inicializarFiltros(){
      const tipos=new Set();
      tareas.forEach(t=>{ if(t.tipo) tipos.add(t.tipo); });
      selectTipo.innerHTML =
        '<option value="Todos">Tipo: todos</option>' +
        [...tipos].sort((a,b)=>a.localeCompare(b,"es"))
          .map(t=>`<option value="${t}">${t}</option>`).join("");
    }

    function aplicarFiltrosBase(){
      let lista=[...tareas];
      const tSel = selectTipo.value;
      const pSel = selectPrioridad.value;
      const eSel = selectEstado.value;

      if(tSel!=="Todos") lista=lista.filter(t=>(t.tipo||"")===tSel);
      if(pSel!=="Todas") lista=lista.filter(t=>(t.prioridad||"").toLowerCase()===pSel);
      if(eSel==="abiertas") lista=lista.filter(t=>!isCerrada(t));
      else if(eSel==="cerradas") lista=lista.filter(t=>isCerrada(t));

      if(filtroTexto){
        lista=lista.filter(t=>{
          const blob=[t.titulo,t.descripcion,t.nota,t.proyectoNombre,t.clienteNombre].join(" ");
          return norm(blob).includes(filtroTexto);
        });
      }
      return lista;
    }

    function aplicarFiltrosYRender(){
      const base=aplicarFiltrosBase();
      renderKPIs(base);
      renderSecciones(base);
    }

    function renderKPIs(lista){
      const total   = lista.length;
      const abiertas= lista.filter(t=>!isCerrada(t)).length;
      const notas   = lista.filter(t=>{
        const tipo=(t.tipo||"").toLowerCase();
        return tipo.includes("nota");
      }).length;

      const ahora = Date.now();
      const semana= 7*24*60*60*1000;
      const proximas = lista.filter(t=>{
        if(isCerrada(t)) return false;
        const fv=t.fecha_vencimiento||t.fecha;
        const m=ms(fv);
        return m && m>=ahora && m<=ahora+semana;
      }).length;

      kpiTotal.textContent    = total||0;
      kpiAbiertas.textContent = abiertas||0;
      kpiNotas.textContent    = notas||0;
      kpiProximas.textContent = proximas||0;
    }

    function crearCard(t){
      const titulo = t.titulo || "Tarea sin tÃ­tulo";
      const tipo   = t.tipo   || "Tarea";
      const prio   = (t.prioridad||"").toLowerCase();
      const proyecto = t.proyectoNombre||t.proyecto||"";
      const cliente  = t.clienteNombre||t.cliente||"";
      const desc   = t.descripcion||t.nota||"";
      const fv     = t.fecha_vencimiento||t.fecha;
      const fTxt   = fv ? new Date(ms(fv)).toLocaleDateString("es-ES"):"-";

      let clasePrio="mobile-chip";
      if(prio==="alta") clasePrio+=" chip-prio-alta";
      else if(prio==="media") clasePrio+=" chip-prio-media";
      else if(prio==="baja") clasePrio+=" chip-prio-baja";

      const card=document.createElement("div");
      card.className="mobile-card";
      card.innerHTML=`
        <div class="mobile-card-header">
          <div class="mobile-card-title">${titulo}</div>
          <div>
            <span class="mobile-chip chip-tipo">${tipo}</span>
            <span class="${clasePrio}">
              ${prio ? "Prioridad: "+prio : "Sin prioridad"}
            </span>
          </div>
        </div>
        <div class="mobile-card-body">
          <div><strong>Fecha:</strong> ${fTxt}</div>
          ${proyecto?`<div><strong>Proyecto:</strong> ${proyecto}</div>`:""}
          ${cliente?`<div><strong>Cliente:</strong> ${cliente}</div>`:""}
          ${desc?`<div>${desc}</div>`:""}
        </div>
        <div class="mobile-meta">
          Estado: ${t.estado||"Sin estado"}
        </div>`;
      return card;
    }

    function renderSecciones(lista){
      listaProximas.innerHTML="";
      listaVencidas.innerHTML="";
      listaNotas.innerHTML="";

      const ahora = Date.now();
      const hoy0  = new Date(); hoy0.setHours(0,0,0,0);
      const semana= 7*24*60*60*1000;

      const abiertas = lista.filter(t=>!isCerrada(t));

      const proximas = abiertas.filter(t=>{
        const m=ms(t.fecha_vencimiento||t.fecha);
        return m && m>=hoy0.getTime() && m<=ahora+semana;
      }).sort((a,b)=>ms(a.fecha_vencimiento||a.fecha)-ms(b.fecha_vencimiento||b.fecha));

      const vencidas = abiertas.filter(t=>{
        const m=ms(t.fecha_vencimiento||t.fecha);
        return m && m<hoy0.getTime();
      }).sort((a,b)=>ms(a.fecha_vencimiento||a.fecha)-ms(b.fecha_vencimiento||b.fecha));

      const notas = lista.filter(t=>{
        const tipo=(t.tipo||"").toLowerCase();
        return tipo.includes("nota");
      }).sort((a,b)=>ms(b.fecha||0)-ms(a.fecha||0)).slice(0,8);

      if(!proximas.length){
        listaProximas.innerHTML='<div style="font-size:10px;color:#6b7280;">No hay seguimientos prÃ³ximos.</div>';
      }else{
        proximas.forEach(t=>listaProximas.appendChild(crearCard(t)));
      }

      if(!vencidas.length){
        listaVencidas.innerHTML='<div style="font-size:10px;color:#6b7280;">No hay tareas vencidas abiertas.</div>';
      }else{
        vencidas.forEach(t=>listaVencidas.appendChild(crearCard(t)));
      }

      if(!notas.length){
        listaNotas.innerHTML='<div style="font-size:10px;color:#6b7280;">No hay notas rÃ¡pidas recientes.</div>';
      }else{
        notas.forEach(t=>listaNotas.appendChild(crearCard(t)));
      }
    }

    searchInput.addEventListener("input",()=>{
      filtroTexto = norm(searchInput.value||"");
      aplicarFiltrosYRender();
    });
    selectTipo.addEventListener("change",aplicarFiltrosYRender);
    selectPrioridad.addEventListener("change",aplicarFiltrosYRender);
    selectEstado.addEventListener("change",aplicarFiltrosYRender);

    onAuthStateChanged(auth,u=>{
      if(!u) return location.replace("login.html");
      userEmailSpan.textContent=u.email;
      cargarTareas();
    });
  </script>

  <script type="module" src="auth.js"></script>
</body>
</html>
