<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM 2N ‚Äì Clientes (M√≥vil)</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="mobile.css" />
</head>

<body>
  <div class="topnav">
    <div class="logo">CRM 2N ¬∑ Clientes (M√≥vil)</div>
    <div style="display:flex;align-items:center;gap:6px;">
      <span id="mobileUserEmail" style="font-size:11px;color:#475569;"></span>
      <button id="btnLogout"
        style="font-size:11px;padding:4px 8px;border-radius:999px;
               border:1px solid #E5E7EB;background:#FFFFFF;color:#111827;">
        Salir
      </button>
    </div>
  </div>

  <main class="content">
    <div class="mobile-shell">

      <div class="mobile-title">Clientes</div>
      <div class="mobile-subtitle">
        Consulta r√°pida de segmentos, actividad y si ya trabajan con 2N.
      </div>

      <input id="searchMobileClientes" class="search-input-mobile"
             placeholder="Buscar nombre, tipo, segmento..." />

      <div class="mobile-filters-row">
        <select id="fTipo" class="mobile-select">
          <option value="Todos">Tipo: todos</option>
        </select>
        <select id="fSegmento" class="mobile-select">
          <option value="Todos">Segmento: todos</option>
        </select>
        <select id="fProvincia" class="mobile-select">
          <option value="Todas">Provincia: todas</option>
        </select>
      </div>

      <div class="mobile-kpis">
        <div class="mobile-kpi">
          <div class="mobile-kpi-label">Clientes filtrados</div>
          <div id="kpiClientesFiltrados" class="mobile-kpi-value">‚Äì</div>
        </div>
        <div class="mobile-kpi">
          <div class="mobile-kpi-label">Clientes con 2N activo</div>
          <div id="kpiClientesActivos" class="mobile-kpi-value">‚Äì</div>
        </div>
      </div>

      <section>
        <div id="listaClientesMobile" class="mobile-list"></div>
      </section>

    </div>
  </main>

  <div class="mobile-bottombar">
    <div class="mobile-nav-item" onclick="location.href='mobile-index.html'">
      <span>üè†</span>Inicio
    </div>
    <div class="mobile-nav-item" onclick="location.href='mobile-proyectos.html'">
      <span>üèóÔ∏è</span>Proyectos
    </div>
    <div class="mobile-nav-item" onclick="location.href='mobile-tareas.html'">
      <span>‚úÖ</span>Tareas
    </div>
    <div class="mobile-nav-item active" onclick="location.href='mobile-clientes.html'">
      <span>üë•</span>Clientes
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import { collection, getDocs }
      from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { onAuthStateChanged }
      from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const userEmailSpan = document.getElementById("mobileUserEmail");
    const searchInput   = document.getElementById("searchMobileClientes");
    const selectTipo    = document.getElementById("fTipo");
    const selectSegmento= document.getElementById("fSegmento");
    const selectProv    = document.getElementById("fProvincia");

    const kpiFiltrados  = document.getElementById("kpiClientesFiltrados");
    const kpiActivos    = document.getElementById("kpiClientesActivos");
    const listaClientes = document.getElementById("listaClientesMobile");

    let clientes = [];
    let filtroTexto = "";

    function norm(t){
      return (t||"").normalize("NFD")
        .replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();
    }

    async function cargarClientes(){
      const snap = await getDocs(collection(db,"clientes"));
      clientes = snap.docs.map(d=>({id:d.id,...d.data()}));
      inicializarFiltros();
      aplicarFiltrosYRender();
    }

    function inicializarFiltros(){
      const tipos     = new Set();
      const segmentos = new Set();
      const provincias= new Set();

      clientes.forEach(c=>{
        if(c.tipo) tipos.add(c.tipo);
        if(c.segmento) segmentos.add(c.segmento);
        if(c.provincia) provincias.add(c.provincia);
      });

      selectTipo.innerHTML =
        '<option value="Todos">Tipo: todos</option>' +
        [...tipos].sort().map(t=>`<option value="${t}">${t}</option>`).join("");

      selectSegmento.innerHTML =
        '<option value="Todos">Segmento: todos</option>' +
        [...segmentos].sort().map(s=>`<option value="${s}">${s}</option>`).join("");

      selectProv.innerHTML =
        '<option value="Todas">Provincia: todas</option>' +
        [...provincias].sort().map(p=>`<option value="${p}">${p}</option>`).join("");
    }

    function aplicarFiltros(){
      let lista=[...clientes];
      const tSel  = selectTipo.value;
      const sSel  = selectSegmento.value;
      const pSel  = selectProv.value;

      if(tSel!=="Todos")   lista=lista.filter(c=>(c.tipo||"")===tSel);
      if(sSel!=="Todos")   lista=lista.filter(c=>(c.segmento||"")===sSel);
      if(pSel!=="Todas")   lista=lista.filter(c=>(c.provincia||"")===pSel);

      if(filtroTexto){
        lista=lista.filter(c=>{
          const blob=[c.nombre,c.nombre_cliente,c.tipo,c.segmento,c.provincia].join(" ");
          return norm(blob).includes(filtroTexto);
        });
      }
      return lista;
    }

    function aplicarFiltrosYRender(){
      const lista=aplicarFiltros();
      renderKPIs(lista);
      renderLista(lista);
    }

    function renderKPIs(lista){
      kpiFiltrados.textContent = lista.length||0;
      kpiActivos.textContent   = lista.filter(c=>c.trabaja_con_2n===true).length;
    }

    function renderLista(lista){
      listaClientes.innerHTML="";
      if(!lista.length){
        listaClientes.innerHTML =
          '<div style="font-size:10px;color:#6b7280;">No hay clientes con estos filtros.</div>';
        return;
      }
      lista.sort((a,b)=>
        (a.nombre||a.nombre_cliente||"").localeCompare(
          b.nombre||b.nombre_cliente||"","es"
        )
      );
      lista.forEach(c=>{
        const nombre   = c.nombre||c.nombre_cliente||"Cliente sin nombre";
        const tipo     = c.tipo||"Sin tipo";
        const segmento = c.segmento||"";
        const provincia= c.provincia||"";
        const activo   = c.trabaja_con_2n===true;

        const card=document.createElement("div");
        card.className="mobile-card";
        card.innerHTML=`
          <div class="mobile-card-header">
            <div class="mobile-card-title">${nombre}</div>
            ${activo?'<div class="mobile-chip mobile-chip-activo">2N activo</div>':""}
          </div>
          <div class="mobile-card-body">
            <div><strong>Tipo:</strong> ${tipo}</div>
            ${segmento?`<div><strong>Segmento:</strong> ${segmento}</div>`:""}
            ${provincia?`<div><strong>Zona:</strong> ${provincia}</div>`:""}
          </div>`;
        listaClientes.appendChild(card);
      });
    }

    searchInput.addEventListener("input",()=>{
      filtroTexto = norm(searchInput.value||"");
      aplicarFiltrosYRender();
    });
    selectTipo.addEventListener("change",aplicarFiltrosYRender);
    selectSegmento.addEventListener("change",aplicarFiltrosYRender);
    selectProv.addEventListener("change",aplicarFiltrosYRender);

    onAuthStateChanged(auth,u=>{
      if(!u) return location.replace("login.html");
      userEmailSpan.textContent=u.email;
      cargarClientes();
    });
  </script>

  <script type="module" src="auth.js"></script>
</body>
</html>
