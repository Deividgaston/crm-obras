<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM 2N – Admin usuarios</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    .admin-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
    .admin-title{font-size:16px;font-weight:600;color:#111827;}
    .admin-subtitle{font-size:12px;color:#6B7280;margin-top:2px;}
    .admin-form-row{display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end;margin-bottom:10px;}
    .admin-form-group{display:flex;flex-direction:column;gap:3px;min-width:180px;}
    .admin-label{font-size:11px;color:#4B5563;}
    .admin-input{border-radius:999px;border:1px solid #D1D5DB;padding:4px 8px;font-size:11px;}
    .admin-input:focus{outline:none;border-color:#2563EB;box-shadow:0 0 0 1px rgba(37,99,235,0.15);background:#FFFFFF;}
    .admin-select{border-radius:999px;border:1px solid #D1D5DB;padding:4px 8px;font-size:11px;background:#F9FAFB;}
    .admin-select:focus{outline:none;border-color:#2563EB;box-shadow:0 0 0 1px rgba(37,99,235,0.15);background:#FFFFFF;}
    .admin-table{width:100%;border-collapse:collapse;font-size:11px;}
    .admin-table th,.admin-table td{border:1px solid #E5E7EB;padding:4px 6px;text-align:left;}
    .admin-table th{background:#F3F4F6;font-weight:600;color:#111827;}
    .badge-role{font-size:10px;border-radius:999px;padding:2px 6px;border:1px solid #D1D5DB;background:#F9FAFB;color:#374151;display:inline-block;}
    .badge-role-admin{border-color:#4F46E5;background:#EEF2FF;color:#312E81;}
    .badge-role-user{border-color:#22C55E;background:#ECFDF3;color:#166534;}
    .badge-role-read{border-color:#F59E0B;background:#FEF3C7;color:#B45309;}
    .text-muted{font-size:10px;color:#9CA3AF;}
    .danger-link{font-size:10px;color:#DC2626;cursor:pointer;text-decoration:underline;}
    .pill-me{font-size:10px;border-radius:999px;background:#111827;color:#F9FAFB;padding:2px 6px;margin-left:4px;}
  </style>
</head>

<body>
  <div class="topnav">
    <div class="logo">CRM 2N</div>

    <div class="nav-tabs">
      <div class="nav-item" onclick="location.href='index.html'">Dashboard</div>
      <div class="nav-item" onclick="location.href='proyectos.html'">Proyectos</div>
      <div class="nav-item" onclick="location.href='buscar.html'">Buscar</div>
      <div class="nav-item" onclick="location.href='pipeline.html'">Pipeline</div>
      <div class="nav-item" onclick="location.href='clientes.html'">Clientes</div>
      <div class="nav-item" onclick="location.href='tareas.html'">Tareas</div>
      <div class="nav-item" onclick="location.href='reportes.html'">Reportes</div>
      <div class="nav-item active" onclick="location.href='admin.html'">Admin</div>
    </div>

    <div style="display:flex;align-items:center;gap:8px;">
      <span id="adminUserEmail" style="font-size:11px;color:#E5E7EB;"></span>
      <button
        id="btnLogout"
        type="button"
        style="font-size:11px;padding:6px 10px;border-radius:999px;border:1px solid #E5E7EB;background:#FFFFFF;color:#111827;cursor:pointer;white-space:nowrap;"
      >
        Cerrar sesión
      </button>
    </div>
  </div>

  <main class="content">
    <div class="admin-header">
      <div>
        <div class="admin-title">Administración de usuarios</div>
        <div class="admin-subtitle">
          Gestiona los correos autorizados y roles del CRM 2N.
        </div>
      </div>
      <div class="text-muted" id="adminInfo"></div>
    </div>

    <section class="card" style="margin-bottom:12px;">
      <div class="admin-form-row">
        <div class="admin-form-group">
          <label class="admin-label">Correo del usuario</label>
          <input id="emailNuevo" type="email" class="admin-input" placeholder="usuario@empresa.com" />
        </div>

        <div class="admin-form-group">
          <label class="admin-label">Rol</label>
          <select id="rolNuevo" class="admin-select">
            <option value="user">Usuario normal</option>
            <option value="read">Solo lectura</option>
            <option value="admin">Administrador</option>
          </select>
        </div>

        <button id="btnAddUser" class="btn-primary" style="font-size:11px;padding:6px 12px;height:30px;">
          + Añadir
        </button>
      </div>

      <div class="text-muted">El usuario debe iniciar sesión con este mismo correo.</div>
    </section>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <div style="font-size:12px;font-weight:600;color:#111827;">Usuarios permitidos</div>
        <div class="text-muted" id="estadoCarga">Cargando...</div>
      </div>

      <div style="max-height:320px;overflow:auto;">
        <table class="admin-table" id="tablaUsuarios">
          <thead>
            <tr>
              <th>Email</th>
              <th>Rol</th>
              <th>Añadido</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import {
      collection, getDocs, setDoc, deleteDoc, doc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const SUPER_ADMIN = "gastonortigosa@gmail.com";

    const emailNuevo = document.getElementById("emailNuevo");
    const rolNuevo = document.getElementById("rolNuevo");
    const btnAddUser = document.getElementById("btnAddUser");
    const tablaUsuariosBody = document.querySelector("#tablaUsuarios tbody");
    const estadoCarga = document.getElementById("estadoCarga");
    const adminUserEmail = document.getElementById("adminUserEmail");
    const adminInfo = document.getElementById("adminInfo");

    function sanitize(email){return (email||"").trim().toLowerCase();}
    function format(ts){if(!ts)return"-";try{return ts.toDate().toLocaleString("es-ES");}catch{return"-";}}

    async function loadUsers(){
      estadoCarga.textContent="Cargando...";
      tablaUsuariosBody.innerHTML="";

      try{
        const snap=await getDocs(collection(db,"usuarios_admin"));
        const arr=[];
        snap.forEach(d=>arr.push({id:d.id,...d.data()}));

        if(!arr.length){
          tablaUsuariosBody.innerHTML="<tr><td colspan='4' class='text-muted'>No hay usuarios.</td></tr>";
          estadoCarga.textContent="0 usuarios";
          return;
        }

        arr.sort((a,b)=>a.email.localeCompare(b.email));
        tablaUsuariosBody.innerHTML="";

        arr.forEach(u=>{
          const rol=u.rol||"user";
          const badgeClass=
            rol==="admin" ? "badge-role-admin" :
            rol==="read" ? "badge-role-read" :
            "badge-role-user";

          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td>${u.email}</td>
            <td><span class="badge-role ${badgeClass}">${rol}</span>${u.email===SUPER_ADMIN?'<span class="pill-me">Tú</span>':''}</td>
            <td>${format(u.createdAt)}</td>
            <td><span data-email="${u.id}" class="danger-link">Eliminar</span></td>
          `;

          tr.querySelector(".danger-link").onclick=async()=>{
            if(!confirm("¿Eliminar usuario?"))return;
            await deleteDoc(doc(db,"usuarios_admin",u.id));
            loadUsers();
          };

          tablaUsuariosBody.appendChild(tr);
        });

        estadoCarga.textContent=arr.length+" usuarios";

      }catch(e){
        estadoCarga.textContent="Error cargando";
        tablaUsuariosBody.innerHTML="<tr><td colspan='4' class='text-muted'>Error (permisos)</td></tr>";
      }
    }

    async function addUser(){
      const email=sanitize(emailNuevo.value);
      const rol=rolNuevo.value;

      if(!email){alert("Pon un email válido.");return;}

      btnAddUser.disabled=true;
      btnAddUser.textContent="Añadiendo...";

      try{
        await setDoc(doc(db,"usuarios_admin",email),{
          email,
          rol,
          createdAt:serverTimestamp()
        });
        emailNuevo.value="";
        rolNuevo.value="user";
        loadUsers();
      }catch(e){
        alert("Error añadiendo usuario (reglas Firestore).");
      }finally{
        btnAddUser.disabled=false;
        btnAddUser.textContent="+ Añadir";
      }
    }

    btnAddUser.onclick=addUser;

    onAuthStateChanged(auth,user=>{
      if(!user){location.href="login.html";return;}

      adminUserEmail.textContent=user.email;

      if(user.email!==SUPER_ADMIN){
        adminInfo.textContent="No eres superadmin. Puede que no puedas gestionar la lista blanca.";
      }else{
        adminInfo.textContent="Superadmin activo.";
      }

      loadUsers();
    });
  </script>

  <script type="module" src="auth.js"></script>
</body>
</html>
