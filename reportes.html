<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM 2N ‚Äì Reportes</title>
  <link rel="stylesheet" href="style.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <!-- PDF (html2canvas + jsPDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    @media screen {
      .solo-pdf {
        display: none;
      }
    }

    /* Estilo extra para las p√°ginas de reporte (para que el PDF se vea m√°s ‚Äúplantilla‚Äù) */
    .report-page {
      background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
      padding: 16px 10px 24px 10px;
      margin-bottom: 20px;
    }
    .report-inner {
      max-width: 780px;
      margin: 0 auto;
      background: #FFFFFF;
      border-radius: 16px;
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.18);
      padding: 18px 20px 20px 20px;
      border: 1px solid #E5E7EB;
    }
    .report-header-card {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
      border-bottom: 1px solid #E5E7EB;
      padding-bottom: 8px;
    }
    .report-title {
      font-size: 13px;
      font-weight: 700;
      color: #0F172A;
    }
    .report-subtitle {
      font-size: 11px;
      color: #6B7280;
      margin-top: 2px;
    }
    .report-filtros {
      font-size: 10px;
      color: #9CA3AF;
      text-align: right;
      max-width: 260px;
    }
    .report-kpis-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }
    .report-kpi {
      flex: 1 1 100px;
      background: linear-gradient(135deg, #F9FAFB 0%, #EFF6FF 100%);
      border-radius: 10px;
      padding: 6px 8px;
      border: 1px solid #E5E7EB;
    }
    .report-kpi-label {
      font-size: 10px;
      color: #6B7280;
      margin-bottom: 2px;
    }
    .report-kpi-value {
      font-size: 16px;
      font-weight: 700;
      color: #111827;
      line-height: 1.1;
    }
    .report-kpi-footnote {
      font-size: 9px;
      color: #9CA3AF;
      margin-top: 2px;
    }
    .report-chart-container {
      margin-top: 6px;
      margin-bottom: 8px;
      border-radius: 14px;
      background: radial-gradient(circle at top left, #EEF2FF 0, #FFFFFF 45%, #F9FAFB 100%);
      border: 1px solid #E5E7EB;
      padding: 10px 12px;
    }
    .report-chart-wrapper {
      position: relative;
      height: 420px; /* gr√°fico grande para PDF */
    }
    .report-data {
      font-size: 10.5px;
      color: #4B5563;
      background: #F9FAFB;
      border-radius: 10px;
      border: 1px dashed #D1D5DB;
      padding: 8px 9px;
    }
    .report-data strong {
      color: #111827;
    }
    .report-data ul {
      padding-left: 16px;
      margin: 4px 0 0 0;
    }
    .report-data li {
      margin-bottom: 2px;
    }

    .tabla-mini {
      width: 100%;
      border-collapse: collapse;
      margin-top: 4px;
      font-size: 9.5px;
    }
    .tabla-mini th,
    .tabla-mini td {
      border: 1px solid #E5E7EB;
      padding: 3px 4px;
      text-align: left;
    }
    .tabla-mini th {
      background: #F3F4F6;
      font-weight: 600;
      color: #111827;
    }
  </style>
</head>

<body>
  <!-- NAV SUPERIOR -->
  <div class="topnav">
    <div class="logo">CRM 2N</div>

    <div class="nav-tabs">
      <div class="nav-item" onclick="location.href='index.html'">Dashboard</div>
      <div class="nav-item" onclick="location.href='proyectos.html'">Proyectos</div>
      <div class="nav-item" onclick="location.href='buscar.html'">Buscar</div>
      <div class="nav-item" onclick="location.href='pipeline.html'">Pipeline</div>
      <div class="nav-item" onclick="location.href='clientes.html'">Clientes</div>
      <div class="nav-item" onclick="location.href='tareas.html'">Tareas</div>
      <div class="nav-item active" onclick="location.href='reportes.html'">Reportes</div>
    </div>

    <input type="text" class="search-box" id="buscadorGlobal" placeholder="Filtrar proyectos / clientes..." />
  </div>

  <main class="content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <div>
        <h2 style="margin-top:0;margin-bottom:4px;color:#16325C;">Reportes ¬∑ Vista analista de mercado</h2>
        <div style="font-size:12px;color:#5A6872;">
          Control total de obras y clientes, segmentado por provincia, estado, encaje 2N y tipo de cliente.
        </div>
      </div>
      <button id="btnExportPDF" class="btn-primary" type="button" style="font-size:11px;padding:6px 12px;">
        üìÑ Descargar PDF del reporte
      </button>
    </div>

    <!-- FILTROS -->
    <div class="card" style="margin-bottom:12px;">
      <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
        <select id="fVista" class="select-input" style="max-width:180px;">
          <option value="mixto">Vista: Mixta</option>
          <option value="proyectos">Solo proyectos</option>
          <option value="clientes">Solo clientes</option>
        </select>

        <select id="fZona" class="select-input" style="max-width:200px;">
          <option value="Todas">Provincia: todas</option>
        </select>

        <select id="fEstado" class="select-input" style="max-width:200px;">
          <option value="Todos">Estado proyecto: todos</option>
        </select>

        <select id="fEncaje" class="select-input" style="max-width:180px;">
          <option value="Todos">Encaje 2N: todos</option>
          <option value="ALTO">ALTO</option>
          <option value="MEDIO">MEDIO</option>
          <option value="BAJO">BAJO</option>
          <option value="SIN">Sin clasificar</option>
        </select>

        <div style="flex:1;"></div>

        <span style="font-size:10.5px;color:#9CA3AF;">
          El PDF usa estos filtros ¬∑ Un gr√°fico grande por hoja con datos debajo.
        </span>
      </div>
    </div>

    <!-- CONTENIDO DEL REPORTE (SE CAPTURA PARA PDF) -->
    <div id="reportContent">

      <!-- P√ÅGINA 1: ESTADO DEL PIPELINE -->
      <section class="report-page" id="page-estado" data-title="Estado del pipeline de proyectos">
        <div class="report-inner">
          <div class="report-header-card">
            <div>
              <div class="report-title">P√°gina 1 ¬∑ Estado del pipeline</div>
              <div class="report-subtitle">
                Distribuci√≥n de proyectos por estado (igual que en Pipeline) con KPIs clave.
              </div>
            </div>
            <div class="report-filtros"></div>
          </div>

          <div class="report-kpis-row">
            <div class="report-kpi">
              <div class="report-kpi-label">Proyectos filtrados</div>
              <div id="kpiProyectos" class="report-kpi-value">‚Äì</div>
              <div class="report-kpi-footnote">Total de obras seg√∫n filtros actuales.</div>
            </div>
            <div class="report-kpi">
              <div class="report-kpi-label">Obras encaje ALTO / MEDIO</div>
              <div id="kpiEncajeAltoMedio" class="report-kpi-value">‚Äì</div>
              <div class="report-kpi-footnote">Donde el encaje tecnol√≥gico de 2N es muy bueno.</div>
            </div>
          </div>

          <div class="report-chart-container">
            <div class="report-chart-wrapper">
              <canvas id="chartEstado"></canvas>
            </div>
          </div>

          <div class="report-data" id="datosEstado"></div>
        </div>
      </section>

      <!-- P√ÅGINA 2: ENCAJE 2N -->
      <section class="report-page" id="page-encaje" data-title="Encaje 2N en proyectos">
        <div class="report-inner">
          <div class="report-header-card">
            <div>
              <div class="report-title">P√°gina 2 ¬∑ Encaje 2N en proyectos filtrados</div>
              <div class="report-subtitle">
                C√≥mo se reparten los proyectos seg√∫n encaje ALTO / MEDIO / BAJO con soluciones 2N.
              </div>
            </div>
            <div class="report-filtros"></div>
          </div>

          <div class="report-chart-container">
            <div class="report-chart-wrapper">
              <canvas id="chartEncaje"></canvas>
            </div>
          </div>

          <div class="report-data" id="datosEncaje"></div>
        </div>
      </section>

      <!-- P√ÅGINA 3: CLIENTES 2N POR SEGMENTO -->
      <section class="report-page" id="page-clientes-segmento" data-title="Clientes 2N por segmento">
        <div class="report-inner">
          <div class="report-header-card">
            <div>
              <div class="report-title">P√°gina 3 ¬∑ Clientes con 2N activo por segmento</div>
              <div class="report-subtitle">
                Solo clientes marcados como ‚Äú2N ya est√° trabajando‚Äù agrupados por segmento principal.
              </div>
            </div>
            <div class="report-filtros"></div>
          </div>

          <div class="report-chart-container">
            <div class="report-chart-wrapper">
              <canvas id="chartSegmento"></canvas>
            </div>
          </div>

          <div class="report-data" id="datosSegmento"></div>
        </div>
      </section>

      <!-- P√ÅGINA 4: CLIENTES 2N POR TIPO + TOP CLIENTES -->
      <section class="report-page" id="page-clientes-tipo" data-title="Clientes 2N por tipo de cliente">
        <div class="report-inner">
          <div class="report-header-card">
            <div>
              <div class="report-title">P√°gina 4 ¬∑ Clientes con 2N activo por tipo de cliente</div>
              <div class="report-subtitle">
                Promotoras, arquitecturas, ingenier√≠as, fondos, integradores, etc. con 2N ya implantado.
              </div>
            </div>
            <div class="report-filtros"></div>
          </div>

          <div class="report-chart-container">
            <div class="report-chart-wrapper">
              <canvas id="chartClientesTipo"></canvas>
            </div>
          </div>

          <div class="report-data" id="datosClientesTipo">
            <div id="textoClientesTipo"></div>
            <table class="tabla-mini" id="tablaClientes2N">
              <thead>
                <tr>
                  <th>Cliente</th>
                  <th>Tipo</th>
                  <th>Segmento</th>
                  <th>Provincia</th>
                  <th>Obras vinculadas</th>
                </tr>
              </thead>
              <tbody>
                <!-- filas generadas por JS -->
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script type="module">
    import { db } from "./firebase.js";
    import {
      collection,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    let proyectos = [];
    let clientes = [];
    let clientesView = [];

    let chartEstado = null;
    let chartEncaje = null;
    let chartSegmento = null;
    let chartClientesTipo = null;

    const fVista = document.getElementById("fVista");
    const fZona = document.getElementById("fZona");
    const fEstado = document.getElementById("fEstado");
    const fEncaje = document.getElementById("fEncaje");
    const buscadorGlobal = document.getElementById("buscadorGlobal");

    const kpiProyectos = document.getElementById("kpiProyectos");
    const kpiEncajeAltoMedio = document.getElementById("kpiEncajeAltoMedio");

    const datosEstado = document.getElementById("datosEstado");
    const datosEncaje = document.getElementById("datosEncaje");
    const datosSegmento = document.getElementById("datosSegmento");
    const datosClientesTipo = document.getElementById("datosClientesTipo");
    const textoClientesTipo = document.getElementById("textoClientesTipo");
    const tablaClientes2NBody = document.querySelector("#tablaClientes2N tbody");

    const btnExportPDF = document.getElementById("btnExportPDF");
    const reportContent = document.getElementById("reportContent");

    function norm(text) {
      return (text || "")
        .toString()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .trim();
    }

    function contarObrasPorClienteNombre(nombreCliente) {
      const target = (nombreCliente || "").toString().toLowerCase().trim();
      if (!target) return 0;
      let contador = 0;
      proyectos.forEach(p => {
        const campos = [
          p.cliente_principal,
          p.promotora,
          p.constructora,
          p.arquitectura,
          p.ingenieria
        ];
        if (campos.some(v => (v || "").toString().toLowerCase().trim() === target)) {
          contador++;
        }
      });
      return contador;
    }

    function buildClientesView() {
      clientesView = clientes.map(c => {
        const nombre = c.nombre || c.nombre_cliente || "";
        return {
          ...c,
          nombre_display: nombre,
          num_obras: contarObrasPorClienteNombre(nombre)
        };
      });
    }

    function inicializarFiltroProvincia() {
      const provincias = new Set();
      proyectos.forEach(p => { if (p.provincia) provincias.add(p.provincia); });
      clientes.forEach(c => { if (c.provincia) provincias.add(c.provincia); });

      const lista = [...provincias].filter(z => z).sort((a, b) => a.localeCompare(b, "es"));
      fZona.innerHTML =
        '<option value="Todas">Provincia: todas</option>' +
        lista.map(z => `<option value="${z}">${z}</option>`).join("");
    }

    function inicializarFiltroEstado() {
      const estadosSet = new Set();
      proyectos.forEach(p => { if (p.estado) estadosSet.add(p.estado); });
      const lista = [...estadosSet].sort((a, b) => a.localeCompare(b, "es"));
      fEstado.innerHTML =
        '<option value="Todos">Estado proyecto: todos</option>' +
        lista.map(e => `<option value="${e}">${e}</option>`).join("");
    }

    async function cargarDatos() {
      const [snapProy, snapCli] = await Promise.all([
        getDocs(collection(db, "proyectos")),
        getDocs(collection(db, "clientes"))
      ]);

      proyectos = snapProy.docs.map(d => ({ id: d.id, ...d.data() }));
      clientes = snapCli.docs.map(d => ({ id: d.id, ...d.data() }));

      buildClientesView();
      inicializarFiltroProvincia();
      inicializarFiltroEstado();
      aplicarFiltrosYRender();
    }

    function filtrarDatos() {
      const vista = fVista.value;
      const provincia = fZona.value;
      const estado = fEstado.value;
      const encaje = fEncaje.value;
      const txt = norm(buscadorGlobal.value);

      let proy = proyectos.slice();
      let clis = clientesView.slice();

      if (provincia !== "Todas") {
        proy = proy.filter(p => p.provincia === provincia);
        clis = clis.filter(c => c.provincia === provincia);
      }

      if (estado !== "Todos") {
        proy = proy.filter(p => (p.estado || "") === estado);
      }

      if (encaje !== "Todos") {
        proy = proy.filter(p => {
          const e = (p.encaje_2n || "").toString().toUpperCase().trim();
          if (encaje === "SIN") {
            return !["ALTO", "MEDIO", "BAJO"].includes(e);
          }
          return e === encaje;
        });
      }

      if (txt) {
        proy = proy.filter(p => {
          const blob = [
            p.nombre_obra,
            p.nombre,
            p.ciudad,
            p.provincia,
            p.estado,
            p.encaje_2n,
            p.cliente_principal,
            p.promotora
          ].join(" ").toLowerCase();
          return blob.includes(txt);
        });

        clis = clis.filter(c => {
          const blob = [
            c.nombre_display,
            c.tipo,
            c.segmento,
            c.ciudad,
            c.provincia
          ].join(" ").toLowerCase();
          return blob.includes(txt);
        });
      }

      if (vista === "proyectos") {
        return { proy, clis: [] };
      }
      if (vista === "clientes") {
        return { proy: [], clis };
      }
      return { proy, clis };
    }

    function updateFiltrosTexto() {
      const txt = `Provincia: ${fZona.value} ¬∑ Estado: ${fEstado.value} ¬∑ Encaje: ${fEncaje.value} ¬∑ Vista: ${fVista.value}`;
      document.querySelectorAll(".report-filtros").forEach(el => {
        el.textContent = txt;
      });
    }

    function renderKPIs(proy) {
      kpiProyectos.textContent = proy.length;

      const encAltoMedio = proy.filter(p => {
        const e = (p.encaje_2n || "").toString().toUpperCase().trim();
        return e === "ALTO" || e === "MEDIO";
      }).length;
      kpiEncajeAltoMedio.textContent = encAltoMedio;
    }

    function renderChartEstado(proy) {
      if (chartEstado) chartEstado.destroy();
      const ctx = document.getElementById("chartEstado").getContext("2d");

      const counts = {};
      proy.forEach(p => {
        const e = p.estado || "Sin estado";
        counts[e] = (counts[e] || 0) + 1;
      });

      const labels = Object.keys(counts).length ? Object.keys(counts) : ["Sin datos"];
      const data = Object.keys(counts).length ? labels.map(l => counts[l]) : [1];
      const total = data.reduce((a, b) => a + b, 0);

      Chart.register(window.ChartDataLabels);

      chartEstado = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [
            {
              data,
              backgroundColor: [
                "#60A5FA",
                "#34D399",
                "#F97373",
                "#FBBF24",
                "#A855F7",
                "#E5E7EB"
              ],
              borderColor: "#FFFFFF",
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          cutout: "55%",
          plugins: {
            legend: {
              position: "bottom",
              labels: { font: { size: 10 } }
            },
            datalabels: {
              formatter: (v) => {
                if (!total || !v) return "";
                const pct = Math.round((v * 100) / total);
                return pct ? pct + "%" : "";
              },
              color: "#111827",
              font: { size: 9, weight: "600" }
            }
          }
        }
      });

      // texto debajo
      if (!proy.length) {
        datosEstado.innerHTML = "No hay proyectos en esta vista. Ajusta los filtros para ver el pipeline.";
        return;
      }

      const estadosLista = labels.map(l => `${l}: ${counts[l]} proyectos`).join(" ¬∑ ");
      datosEstado.innerHTML = `
        <strong>Lectura r√°pida:</strong> el pipeline actual se reparte as√≠ por estados:<br/>
        ${estadosLista}.<br/><br/>
        <strong>Insight:</strong> revisa especialmente los proyectos ‚ÄúEn curso‚Äù con encaje ALTO / MEDIO para priorizar acciones comerciales.
      `;
    }

    function renderChartEncaje(proy) {
      if (chartEncaje) chartEncaje.destroy();
      const ctx = document.getElementById("chartEncaje").getContext("2d");

      const counts = { ALTO: 0, MEDIO: 0, BAJO: 0, SIN: 0 };
      proy.forEach(p => {
        const e = (p.encaje_2n || "").toString().toUpperCase().trim();
        if (e === "ALTO") counts.ALTO++;
        else if (e === "MEDIO") counts.MEDIO++;
        else if (e === "BAJO") counts.BAJO++;
        else counts.SIN++;
      });

      const labels = ["ALTO", "MEDIO", "BAJO", "SIN"];
      const data = [counts.ALTO, counts.MEDIO, counts.BAJO, counts.SIN];
      const total = data.reduce((a, b) => a + b, 0) || 1;

      chartEncaje = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [
            {
              data,
              backgroundColor: ["#16A34A", "#FACC15", "#FB7185", "#E5E7EB"],
              borderColor: "#FFFFFF",
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          cutout: "55%",
          plugins: {
            legend: {
              position: "bottom",
              labels: { font: { size: 10 } }
            },
            datalabels: {
              formatter: (v) => {
                if (!v) return "";
                const pct = Math.round((v * 100) / total);
                return pct ? pct + "%" : "";
              },
              color: "#111827",
              font: { size: 9, weight: "600" }
            }
          }
        }
      });

      const tAlto = counts.ALTO;
      const tMedio = counts.MEDIO;
      const tBajo = counts.BAJO;
      const tSin = counts.SIN;

      datosEncaje.innerHTML = `
        <strong>Distribuci√≥n de encaje:</strong><br/>
        ALTO: <strong>${tAlto}</strong> ¬∑ MEDIO: <strong>${tMedio}</strong> ¬∑ BAJO: <strong>${tBajo}</strong> ¬∑ Sin clasificar: <strong>${tSin}</strong>.<br/><br/>
        <strong>Recomendaci√≥n:</strong>
        centra los esfuerzos en los proyectos con encaje <strong>ALTO</strong> y <strong>MEDIO</strong> y revisa los ‚ÄúSin clasificar‚Äù
        para no perder oportunidades donde 2N pueda aportar m√°s valor.
      `;
    }

    function renderChartSegmento(clis) {
      if (chartSegmento) chartSegmento.destroy();
      const ctx = document.getElementById("chartSegmento").getContext("2d");

      const activos = clis.filter(c => c.trabaja_con_2n);
      const counts = {};
      activos.forEach(c => {
        const seg = c.segmento || "Sin segmento";
        counts[seg] = (counts[seg] || 0) + 1;
      });

      const labels = Object.keys(counts).length ? Object.keys(counts) : ["Sin datos"];
      const data = Object.keys(counts).length ? labels.map(l => counts[l]) : [1];
      const total = data.reduce((a, b) => a + b, 0) || 1;

      chartSegmento = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [
            {
              data,
              backgroundColor: [
                "#4F46E5",
                "#22C55E",
                "#F97316",
                "#0EA5E9",
                "#A855F7",
                "#E5E7EB"
              ],
              borderColor: "#FFFFFF",
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          cutout: "55%",
          plugins: {
            legend: {
              position: "bottom",
              labels: { font: { size: 10 } }
            },
            datalabels: {
              formatter: (v) => {
                if (!v) return "";
                const pct = Math.round((v * 100) / total);
                return pct ? pct + "%" : "";
              },
              color: "#111827",
              font: { size: 9, weight: "600" }
            }
          }
        }
      });

      if (!activos.length) {
        datosSegmento.innerHTML = `
          No hay clientes marcados como ‚Äú2N ya est√° trabajando con este cliente‚Äù en esta vista.
          Marca primero clientes en la ficha de clientes para ver este gr√°fico segmentado.
        `;
        return;
      }

      const lista = labels.map(l => `${l}: ${counts[l]} clientes`).join(" ¬∑ ");

      datosSegmento.innerHTML = `
        <strong>Distribuci√≥n por segmento de los clientes activos 2N:</strong><br/>
        ${lista}.<br/><br/>
        <strong>Uso pr√°ctico:</strong> este gr√°fico te ayuda a ver en qu√© segmentos est√°s m√°s posicionado con 2N
        y d√≥nde puedes abrir nuevo mercado (segmentos con menos peso relativo).
      `;
    }

    function renderChartClientesTipo(clis) {
      if (chartClientesTipo) chartClientesTipo.destroy();
      const ctx = document.getElementById("chartClientesTipo").getContext("2d");

      const activos = clis.filter(c => c.trabaja_con_2n);
      const counts = {};
      activos.forEach(c => {
        const tipo = c.tipo || "Sin tipo";
        counts[tipo] = (counts[tipo] || 0) + 1;
      });

      const labels = Object.keys(counts).length ? Object.keys(counts) : ["Sin datos"];
      const data = Object.keys(counts).length ? labels.map(l => counts[l]) : [1];
      const total = data.reduce((a, b) => a + b, 0) || 1;

      chartClientesTipo = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [
            {
              data,
              backgroundColor: [
                "#22C55E",
                "#4ADE80",
                "#A7F3D0",
                "#6EE7B7",
                "#BBF7D0",
                "#E5E7EB"
              ],
              borderColor: "#FFFFFF",
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          cutout: "55%",
          plugins: {
            legend: {
              position: "bottom",
              labels: { font: { size: 10 } }
            },
            datalabels: {
              formatter: (v) => {
                if (!v) return "";
                const pct = Math.round((v * 100) / total);
                return pct ? pct + "%" : "";
              },
              color: "#111827",
              font: { size: 9, weight: "600" }
            }
          }
        }
      });

      if (!activos.length) {
        textoClientesTipo.innerHTML = `
          No hay clientes con 2N activo en esta vista. Marca clientes en la ficha de clientes
          (checkbox ‚Äú2N ya est√° trabajando con este cliente‚Äù) para ver su distribuci√≥n por tipo.
        `;
        tablaClientes2NBody.innerHTML = "";
        return;
      }

      const resumenTipos = labels.map(l => `${l}: ${counts[l]} clientes`).join(" ¬∑ ");
      textoClientesTipo.innerHTML = `
        <strong>Distribuci√≥n por tipo de cliente con 2N activo:</strong><br/>
        ${resumenTipos}.<br/><br/>
        <strong>Insight:</strong> usa esta vista para saber si tu esfuerzo se concentra en promotoras, arquitecturas,
        integradores, fondos, etc. y equilibrar tu estrategia de prescripci√≥n.
      `;

      const topActivos = activos
        .slice()
        .sort((a, b) => (b.num_obras || 0) - (a.num_obras || 0))
        .slice(0, 15);

      tablaClientes2NBody.innerHTML = topActivos
        .map(c => `
          <tr>
            <td>${c.nombre_display || ""}</td>
            <td>${c.tipo || ""}</td>
            <td>${c.segmento || ""}</td>
            <td>${c.provincia || ""}</td>
            <td>${c.num_obras || 0}</td>
          </tr>
        `)
        .join("");
    }

    function aplicarFiltrosYRender() {
      const { proy, clis } = filtrarDatos();

      updateFiltrosTexto();
      renderKPIs(proy);
      renderChartEstado(proy);
      renderChartEncaje(proy);
      renderChartSegmento(clis);
      renderChartClientesTipo(clis);
    }

    fVista.addEventListener("change", aplicarFiltrosYRender);
    fZona.addEventListener("change", aplicarFiltrosYRender);
    fEstado.addEventListener("change", aplicarFiltrosYRender);
    fEncaje.addEventListener("change", aplicarFiltrosYRender);
    buscadorGlobal.addEventListener("input", () => {
      clearTimeout(buscadorGlobal._t);
      buscadorGlobal._t = setTimeout(aplicarFiltrosYRender, 200);
    });

    btnExportPDF.addEventListener("click", async () => {
      const { jsPDF } = window.jspdf;
      btnExportPDF.disabled = true;
      btnExportPDF.textContent = "Generando PDF...";

      try {
        const pages = Array.from(document.querySelectorAll(".report-page"));
        let pdf = null;
        const pageWidth = 210;   // A4 mm
        const pageHeight = 297;  // A4 mm
        const usableHeight = pageHeight - 35; // margen para cabecera

        const fechaStr = new Date().toLocaleDateString("es-ES");

        function drawHeader(pdfInstance, title, pageIndex) {
          pdfInstance.setFillColor(15, 23, 42);
          pdfInstance.rect(0, 0, pageWidth, 18, "F");

          pdfInstance.setFont("helvetica", "bold");
          pdfInstance.setFontSize(11);
          pdfInstance.setTextColor(255, 255, 255);
          pdfInstance.text("CRM 2N ¬∑ Reporte analista de mercado", 10, 8);

          pdfInstance.setFont("helvetica", "normal");
          pdfInstance.setFontSize(9);
          pdfInstance.text(title, 10, 14);

          pdfInstance.setFontSize(8);
          pdfInstance.setTextColor(209, 213, 219);
          pdfInstance.text(fechaStr, pageWidth - 10, 8, { align: "right" });
          pdfInstance.text("P√°gina " + pageIndex, pageWidth - 10, 14, { align: "right" });

          pdfInstance.setTextColor(17, 24, 39);
        }

        let globalPageIndex = 1;

        for (const page of pages) {
          const title = page.dataset.title || "Reporte CRM 2N";

          const canvas = await html2canvas(page, {
            scale: 2,
            useCORS: true,
            windowWidth: document.documentElement.scrollWidth
          });
          const imgData = canvas.toDataURL("image/png");

          const imgWidth = pageWidth - 20;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;

          let heightLeft = imgHeight;
          let offsetY = 0;
          let sliceIndex = 0;

          while (heightLeft > 0) {
            if (!pdf) {
              pdf = new jsPDF("p", "mm", "a4");
            } else {
              pdf.addPage();
            }

            const pageTitle = title + (sliceIndex > 0 ? " (cont.)" : "");
            drawHeader(pdf, pageTitle, globalPageIndex++);

            const posY = 22;
            pdf.addImage(
              imgData,
              "PNG",
              10,
              posY - (offsetY * imgWidth) / imgWidth,
              imgWidth,
              imgHeight
            );

            heightLeft -= usableHeight;
            offsetY += usableHeight;
            sliceIndex++;
          }
        }

        if (pdf) {
          pdf.save("reporte_crm_2n.pdf");
        } else {
          alert("No hay datos para exportar.");
        }
      } catch (err) {
        console.error("Error generando PDF:", err);
        alert("Ha ocurrido un error al generar el PDF.");
      } finally {
        btnExportPDF.disabled = false;
        btnExportPDF.textContent = "üìÑ Descargar PDF del reporte";
      }
    });

    cargarDatos();
  </script>
</body>
</html>
