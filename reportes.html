<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM 2N ‚Äì Reportes</title>
  <link rel="stylesheet" href="style.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <!-- PDF (html2canvas + jsPDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    @media screen {
      .solo-pdf {
        display: none;
      }
    }

    /* Lienzo general de reportes */
    .report-page {
      background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
      padding: 16px 10px 24px 10px;
      margin-bottom: 20px;
    }
    .report-inner {
      max-width: 1120px;
      margin: 0 auto;
      background: #FFFFFF;
      border-radius: 16px;
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.18);
      padding: 18px 20px 20px 20px;
      border: 1px solid #E5E7EB;
    }
    .report-header-card {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
      border-bottom: 1px solid #E5E7EB;
      padding-bottom: 8px;
    }
    .report-title {
      font-size: 13px;
      font-weight: 700;
      color: #0F172A;
    }
    .report-subtitle {
      font-size: 11px;
      color: #6B7280;
      margin-top: 2px;
    }
    .report-filtros {
      font-size: 10px;
      color: #9CA3AF;
      text-align: right;
      max-width: 260px;
    }
    .report-kpis-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    .report-kpi {
      flex: 1 1 140px;
      background: linear-gradient(135deg, #F9FAFB 0%, #EFF6FF 100%);
      border-radius: 10px;
      padding: 6px 8px;
      border: 1px solid #E5E7EB;
    }
    .report-kpi-label {
      font-size: 10px;
      color: #6B7280;
      margin-bottom: 2px;
    }
    .report-kpi-value {
      font-size: 16px;
      font-weight: 700;
      color: #111827;
      line-height: 1.1;
    }
    .report-kpi-footnote {
      font-size: 9px;
      color: #9CA3AF;
      margin-top: 2px;
    }

    /* Cuadros de gr√°ficos en grid 2x2 en pantalla */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
    }
    .chart-card {
      background: radial-gradient(circle at top left, #EEF2FF 0, #FFFFFF 45%, #F9FAFB 100%);
      border-radius: 14px;
      border: 1px solid #E5E7EB;
      padding: 10px 12px;
    }
    .chart-card-header {
      font-size: 12px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 3px;
    }
    .chart-card-sub {
      font-size: 10.5px;
      color: #6B7280;
      margin-bottom: 6px;
    }
    .chart-card-wrapper {
      position: relative;
      height: 360px; /* M√ÅS GRANDE PARA EL GR√ÅFICO + LEYENDA DERECHA */
      margin-bottom: 6px;
    }
    .chart-card-data {
      font-size: 10px;
      color: #4B5563;
      background: rgba(249, 250, 251, 0.9);
      border-radius: 8px;
      border: 1px dashed #D1D5DB;
      padding: 6px 7px;
    }
    .chart-card-data strong {
      color: #111827;
    }
    .chart-card-data ul {
      padding-left: 14px;
      margin: 4px 0 0 0;
    }
    .chart-card-data li {
      margin-bottom: 2px;
    }

    /* Tabla mini */
    .tabla-mini {
      width: 100%;
      border-collapse: collapse;
      margin-top: 4px;
      font-size: 9.5px;
    }
    .tabla-mini th,
    .tabla-mini td {
      border: 1px solid #E5E7EB;
      padding: 3px 4px;
      text-align: left;
    }
    .tabla-mini th {
      background: #F3F4F6;
      font-weight: 600;
      color: #111827;
    }

    @media (max-width: 900px) {
      .charts-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      .chart-card-wrapper {
        height: 300px;
      }
    }
  </style>
</head>

<body>
  <!-- NAV SUPERIOR -->
  <div class="topnav">
    <div class="logo">CRM 2N</div>

    <div class="nav-tabs">
      <div class="nav-item" onclick="location.href='index.html'">Dashboard</div>
      <div class="nav-item" onclick="location.href='proyectos.html'">Proyectos</div>
      <div class="nav-item" onclick="location.href='buscar.html'">Buscar</div>
      <div class="nav-item" onclick="location.href='pipeline.html'">Pipeline</div>
      <div class="nav-item" onclick="location.href='clientes.html'">Clientes</div>
      <div class="nav-item" onclick="location.href='tareas.html'">Tareas</div>
      <div class="nav-item active" onclick="location.href='reportes.html'">Reportes</div>
    </div>

    <div style="display:flex;align-items:center;gap:8px;">
      <input
        type="text"
        class="search-box"
        id="buscadorGlobal"
        placeholder="Filtrar proyectos / clientes..."
      />
      <button
        id="btnLogout"
        type="button"
        style="
          font-size:11px;
          padding:6px 10px;
          border-radius:999px;
          border:1px solid #E5E7EB;
          background:#FFFFFF;
          color:#111827;
          cursor:pointer;
          white-space:nowrap;
        "
      >
        Cerrar sesi√≥n
      </button>
    </div>
  </div>

  <main class="content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <div>
        <h2 style="margin-top:0;margin-bottom:4px;color:#16325C;">Reportes ¬∑ Vista analista de mercado</h2>
        <div style="font-size:12px;color:#5A6872;">
          4 gr√°ficos clave en una sola vista ¬∑ PDF con un gr√°fico grande por p√°gina.
        </div>
      </div>
      <button id="btnExportPDF" class="btn-primary" type="button" style="font-size:11px;padding:6px 12px;">
        üìÑ Descargar PDF del reporte
      </button>
    </div>

    <!-- FILTROS -->
    <div class="card" style="margin-bottom:12px;">
      <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
        <select id="fVista" class="select-input" style="max-width:180px;">
          <option value="mixto">Vista: Mixta</option>
          <option value="proyectos">Solo proyectos</option>
          <option value="clientes">Solo clientes</option>
        </select>

        <select id="fZona" class="select-input" style="max-width:200px;">
          <option value="Todas">Provincia: todas</option>
        </select>

        <select id="fEstado" class="select-input" style="max-width:200px;">
          <option value="Todos">Estado proyecto: todos</option>
        </select>

        <select id="fEncaje" class="select-input" style="max-width:180px;">
          <option value="Todos">Encaje 2N: todos</option>
          <option value="ALTO">ALTO</option>
          <option value="MEDIO">MEDIO</option>
          <option value="BAJO">BAJO</option>
          <option value="SIN">Sin clasificar</option>
        </select>

        <div style="flex:1;"></div>

        <span style="font-size:10.5px;color:#9CA3AF;">
          En pantalla ves los 4 ¬∑ En PDF: 1 gr√°fico grande por hoja con sus datos.
        </span>
      </div>
    </div>

    <!-- P√ÅGINA VISUAL: 4 GR√ÅFICOS JUNTOS -->
    <section class="report-page">
      <div class="report-inner">
        <div class="report-header-card">
          <div>
            <div class="report-title">Resumen gr√°fico CRM 2N</div>
            <div class="report-subtitle">
              Pipeline, encaje 2N y clientes activos por segmento y tipo.
            </div>
          </div>
          <div class="report-filtros" id="textoFiltrosResumen"></div>
        </div>

        <div class="report-kpis-row">
          <div class="report-kpi">
            <div class="report-kpi-label">Proyectos filtrados</div>
            <div id="kpiProyectos" class="report-kpi-value">‚Äì</div>
            <div class="report-kpi-footnote">Total de obras seg√∫n filtros actuales.</div>
          </div>
          <div class="report-kpi">
            <div class="report-kpi-label">Obras encaje ALTO / MEDIO</div>
            <div id="kpiEncajeAltoMedio" class="report-kpi-value">‚Äì</div>
            <div class="report-kpi-footnote">Donde el encaje tecnol√≥gico de 2N es muy bueno.</div>
          </div>
        </div>

        <div class="charts-grid">
          <!-- CARD 1: Estado -->
          <div class="chart-card chart-page" id="card-estado" data-title="Estado del pipeline de proyectos">
            <div class="chart-card-header">Estado del pipeline</div>
            <div class="chart-card-sub">
              Distribuci√≥n de proyectos por estado (igual que en Pipeline).
            </div>
            <div class="chart-card-wrapper">
              <canvas id="chartEstado"></canvas>
            </div>
            <div class="chart-card-data" id="datosEstado"></div>
          </div>

          <!-- CARD 2: Encaje -->
          <div class="chart-card chart-page" id="card-encaje" data-title="Encaje 2N en proyectos filtrados">
            <div class="chart-card-header">Encaje 2N en proyectos</div>
            <div class="chart-card-sub">
              C√≥mo se reparten los proyectos seg√∫n encaje ALTO / MEDIO / BAJO / sin clasificar.
            </div>
            <div class="chart-card-wrapper">
              <canvas id="chartEncaje"></canvas>
            </div>
            <div class="chart-card-data" id="datosEncaje"></div>
          </div>

          <!-- CARD 3: Clientes 2N por segmento -->
          <div class="chart-card chart-page" id="card-segmento" data-title="Clientes 2N por segmento">
            <div class="chart-card-header">Clientes con 2N activo por segmento</div>
            <div class="chart-card-sub">
              Solo clientes marcados como ‚Äú2N ya est√° trabajando‚Äù, agrupados por segmento.
            </div>
            <div class="chart-card-wrapper">
              <canvas id="chartSegmento"></canvas>
            </div>
            <div class="chart-card-data" id="datosSegmento"></div>
          </div>

          <!-- CARD 4: Clientes 2N por tipo -->
          <div class="chart-card chart-page" id="card-tipo" data-title="Clientes 2N por tipo de cliente">
            <div class="chart-card-header">Clientes con 2N activo por tipo de cliente</div>
            <div class="chart-card-sub">
              Promotoras, arquitecturas, ingenier√≠as, fondos, integradores, etc.
            </div>
            <div class="chart-card-wrapper">
              <canvas id="chartClientesTipo"></canvas>
            </div>
            <div class="chart-card-data" id="datosClientesTipo">
              <div id="textoClientesTipo"></div>
              <table class="tabla-mini" id="tablaClientes2N">
                <thead>
                  <tr>
                    <th>Cliente</th>
                    <th>Tipo</th>
                    <th>Segmento</th>
                    <th>Provincia</th>
                    <th>Obras</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </section>
  </main>

  <script type="module">
    import { db } from "./firebase.js";
    import {
      collection,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    let proyectos = [];
    let clientes = [];
    let clientesView = [];

    let chartEstado = null;
    let chartEncaje = null;
    let chartSegmento = null;
    let chartClientesTipo = null;

    const fVista = document.getElementById("fVista");
    const fZona = document.getElementById("fZona");
    const fEstado = document.getElementById("fEstado");
    const fEncaje = document.getElementById("fEncaje");
    const buscadorGlobal = document.getElementById("buscadorGlobal");

    const kpiProyectos = document.getElementById("kpiProyectos");
    const kpiEncajeAltoMedio = document.getElementById("kpiEncajeAltoMedio");
    const textoFiltrosResumen = document.getElementById("textoFiltrosResumen");

    const datosEstado = document.getElementById("datosEstado");
    const datosEncaje = document.getElementById("datosEncaje");
    const datosSegmento = document.getElementById("datosSegmento");
    const datosClientesTipo = document.getElementById("datosClientesTipo");
    const textoClientesTipo = document.getElementById("textoClientesTipo");
    const tablaClientes2NBody = document.querySelector("#tablaClientes2N tbody");

    const btnExportPDF = document.getElementById("btnExportPDF");

    function norm(text) {
      return (text || "")
        .toString()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .trim();
    }

    function contarObrasPorClienteNombre(nombreCliente) {
      const target = (nombreCliente || "").toString().toLowerCase().trim();
      if (!target) return 0;
      let contador = 0;
      proyectos.forEach(p => {
        const campos = [
          p.cliente_principal,
          p.promotora,
          p.constructora,
          p.arquitectura,
          p.ingenieria
        ];
        if (campos.some(v => (v || "").toString().toLowerCase().trim() === target)) {
          contador++;
        }
      });
      return contador;
    }

    function buildClientesView() {
      clientesView = clientes.map(c => {
        const nombre = c.nombre || c.nombre_cliente || "";
        return {
          ...c,
          nombre_display: nombre,
          num_obras: contarObrasPorClienteNombre(nombre)
        };
      });
    }

    function inicializarFiltroProvincia() {
      const provincias = new Set();
      proyectos.forEach(p => { if (p.provincia) provincias.add(p.provincia); });
      clientes.forEach(c => { if (c.provincia) provincias.add(c.provincia); });

      const lista = [...provincias].filter(z => z).sort((a, b) => a.localeCompare(b, "es"));
      fZona.innerHTML =
        '<option value="Todas">Provincia: todas</option>' +
        lista.map(z => `<option value="${z}">${z}</option>`).join("");
    }

    function inicializarFiltroEstado() {
      const estadosSet = new Set();
      proyectos.forEach(p => { if (p.estado) estadosSet.add(p.estado); });
      const lista = [...estadosSet].sort((a, b) => a.localeCompare(b, "es"));
      fEstado.innerHTML =
        '<option value="Todos">Estado proyecto: todos</option>' +
        lista.map(e => `<option value="${e}">${e}</option>`).join("");
    }

    async function cargarDatos() {
      const [snapProy, snapCli] = await Promise.all([
        getDocs(collection(db, "proyectos")),
        getDocs(collection(db, "clientes"))
      ]);

      proyectos = snapProy.docs.map(d => ({ id: d.id, ...d.data() }));
      clientes = snapCli.docs.map(d => ({ id: d.id, ...d.data() }));

      buildClientesView();
      inicializarFiltroProvincia();
      inicializarFiltroEstado();
      aplicarFiltrosYRender();
    }

    function filtrarDatos() {
      const vista = fVista.value;
      const provincia = fZona.value;
      const estado = fEstado.value;
      const encaje = fEncaje.value;
      const txt = norm(buscadorGlobal.value);

      let proy = proyectos.slice();
      let clis = clientesView.slice();

      if (provincia !== "Todas") {
        proy = proy.filter(p => p.provincia === provincia);
        clis = clis.filter(c => c.provincia === provincia);
      }

      if (estado !== "Todos") {
        proy = proy.filter(p => (p.estado || "") === estado);
      }

      if (encaje !== "Todos") {
        proy = proy.filter(p => {
          const e = (p.encaje_2n || "").toString().toUpperCase().trim();
          if (encaje === "SIN") {
            return !["ALTO", "MEDIO", "BAJO"].includes(e);
          }
          return e === encaje;
        });
      }

      if (txt) {
        proy = proy.filter(p => {
          const blob = [
            p.nombre_obra,
            p.nombre,
            p.ciudad,
            p.provincia,
            p.estado,
            p.encaje_2n,
            p.cliente_principal,
            p.promotora
          ].join(" ").toLowerCase();
          return blob.includes(txt);
        });

        clis = clis.filter(c => {
          const blob = [
            c.nombre_display,
            c.tipo,
            c.segmento,
            c.ciudad,
            c.provincia
          ].join(" ").toLowerCase();
          return blob.includes(txt);
        });
      }

      if (vista === "proyectos") {
        return { proy, clis: [] };
      }
      if (vista === "clientes") {
        return { proy: [], clis };
      }
      return { proy, clis };
    }

    function updateFiltrosTexto() {
      textoFiltrosResumen.textContent =
        `Provincia: ${fZona.value} ¬∑ Estado: ${fEstado.value} ¬∑ Encaje: ${fEncaje.value} ¬∑ Vista: ${fVista.value}`;
    }

    function renderKPIs(proy) {
      kpiProyectos.textContent = proy.length;

      const encAltoMedio = proy.filter(p => {
        const e = (p.encaje_2n || "").toString().toUpperCase().trim();
        return e === "ALTO" || e === "MEDIO";
      }).length;
      kpiEncajeAltoMedio.textContent = encAltoMedio;
    }

    function renderChartEstado(proy) {
      if (chartEstado) chartEstado.destroy();
      const ctx = document.getElementById("chartEstado").getContext("2d");

      const counts = {};
      proy.forEach(p => {
        const e = p.estado || "Sin estado";
        counts[e] = (counts[e] || 0) + 1;
      });

      const labels = Object.keys(counts).length ? Object.keys(counts) : ["Sin datos"];
      const data = Object.keys(counts).length ? labels.map(l => counts[l]) : [1];
      const total = data.reduce((a, b) => a + b, 0) || 1;

      Chart.register(window.ChartDataLabels);

      chartEstado = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [
            {
              data,
              backgroundColor: [
                "#60A5FA",
                "#34D399",
                "#F97373",
                "#FBBF24",
                "#A855F7",
                "#E5E7EB"
              ],
              borderColor: "#FFFFFF",
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: "55%",
          plugins: {
            legend: {
              position: "right",
              align: "center",
              labels: { font: { size: 9 }, usePointStyle: true }
            },
            datalabels: {
              formatter: (v) => {
                if (!v) return "";
                const pct = Math.round((v * 100) / total);
                return pct ? pct + "%" : "";
              },
              color: "#111827",
              font: { size: 9, weight: "600" }
            }
          },
          layout: {
            padding: { top: 5, bottom: 5, left: 0, right: 0 }
          }
        }
      });

      if (!proy.length) {
        datosEstado.innerHTML = "No hay proyectos en esta vista. Ajusta los filtros para ver el pipeline.";
        return;
      }

      const estadosLista = labels.map(l => `${l}: ${counts[l]} proyectos`).join(" ¬∑ ");
      datosEstado.innerHTML = `
        <strong>Lectura r√°pida:</strong> el pipeline actual se reparte as√≠ por estados:<br/>
        ${estadosLista}.<br/><br/>
        <strong>Insight:</strong> prioriza los proyectos ‚ÄúEn curso‚Äù con encaje ALTO / MEDIO.
      `;
    }

    function renderChartEncaje(proy) {
      if (chartEncaje) chartEncaje.destroy();
      const ctx = document.getElementById("chartEncaje").getContext("2d");

      const counts = { ALTO: 0, MEDIO: 0, BAJO: 0, SIN: 0 };
      proy.forEach(p => {
        const e = (p.encaje_2n || "").toString().toUpperCase().trim();
        if (e === "ALTO") counts.ALTO++;
        else if (e === "MEDIO") counts.MEDIO++;
        else if (e === "BAJO") counts.BAJO++;
        else counts.SIN++;
      });

      const labels = ["ALTO", "MEDIO", "BAJO", "SIN"];
      const data = [counts.ALTO, counts.MEDIO, counts.BAJO, counts.SIN];
      const total = data.reduce((a, b) => a + b, 0) || 1;

      chartEncaje = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [
            {
              data,
              backgroundColor: ["#16A34A", "#FACC15", "#FB7185", "#E5E7EB"],
              borderColor: "#FFFFFF",
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: "55%",
          plugins: {
            legend: {
              position: "right",
              align: "center",
              labels: { font: { size: 9 }, usePointStyle: true }
            },
            datalabels: {
              formatter: (v) => {
                if (!v) return "";
                const pct = Math.round((v * 100) / total);
                return pct ? pct + "%" : "";
              },
              color: "#111827",
              font: { size: 9, weight: "600" }
            }
          },
          layout: {
            padding: { top: 5, bottom: 5, left: 0, right: 0 }
          }
        }
      });

      const tAlto = counts.ALTO;
      const tMedio = counts.MEDIO;
      const tBajo = counts.BAJO;
      const tSin = counts.SIN;

      datosEncaje.innerHTML = `
        <strong>Distribuci√≥n de encaje:</strong><br/>
        ALTO: <strong>${tAlto}</strong> ¬∑ MEDIO: <strong>${tMedio}</strong> ¬∑ BAJO: <strong>${tBajo}</strong> ¬∑ Sin clasificar: <strong>${tSin}</strong>.
      `;
    }

    function renderChartSegmento(clis) {
      if (chartSegmento) chartSegmento.destroy();
      const ctx = document.getElementById("chartSegmento").getContext("2d");

      const activos = clis.filter(c => c.trabaja_con_2n);
      const counts = {};
      activos.forEach(c => {
        const seg = c.segmento || "Sin segmento";
        counts[seg] = (counts[seg] || 0) + 1;
      });

      const labels = Object.keys(counts).length ? Object.keys(counts) : ["Sin datos"];
      const data = Object.keys(counts).length ? labels.map(l => counts[l]) : [1];
      const total = data.reduce((a, b) => a + b, 0) || 1;

      chartSegmento = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [
            {
              data,
              backgroundColor: [
                "#4F46E5",
                "#22C55E",
                "#F97316",
                "#0EA5E9",
                "#A855F7",
                "#E5E7EB"
              ],
              borderColor: "#FFFFFF",
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: "55%",
          plugins: {
            legend: {
              position: "right",
              align: "center",
              labels: { font: { size: 9 }, usePointStyle: true }
            },
            datalabels: {
              formatter: (v) => {
                if (!v) return "";
                const pct = Math.round((v * 100) / total);
                return pct ? pct + "%" : "";
              },
              color: "#111827",
              font: { size: 9, weight: "600" }
            }
          },
          layout: {
            padding: { top: 5, bottom: 5, left: 0, right: 0 }
          }
        }
      });

      if (!activos.length) {
        datosSegmento.innerHTML = `
          No hay clientes marcados como ‚Äú2N ya est√° trabajando con este cliente‚Äù en esta vista.
        `;
        return;
      }

      const lista = labels.map(l => `${l}: ${counts[l]} clientes`).join(" ¬∑ ");
      datosSegmento.innerHTML = `
        <strong>Clientes 2N por segmento:</strong><br/>
        ${lista}.
      `;
    }

    function renderChartClientesTipo(clis) {
      if (chartClientesTipo) chartClientesTipo.destroy();
      const ctx = document.getElementById("chartClientesTipo").getContext("2d");

      const activos = clis.filter(c => c.trabaja_con_2n);
      const counts = {};
      activos.forEach(c => {
        const tipo = c.tipo || "Sin tipo";
        counts[tipo] = (counts[tipo] || 0) + 1;
      });

      const labels = Object.keys(counts).length ? Object.keys(counts) : ["Sin datos"];
      const data = Object.keys(counts).length ? labels.map(l => counts[l]) : [1];
      const total = data.reduce((a, b) => a + b, 0) || 1;

      chartClientesTipo = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [
            {
              data,
              backgroundColor: [
                "#22C55E",
                "#4ADE80",
                "#A7F3D0",
                "#6EE7B7",
                "#BBF7D0",
                "#E5E7EB"
              ],
              borderColor: "#FFFFFF",
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: "55%",
          plugins: {
            legend: {
              position: "right",
              align: "center",
              labels: { font: { size: 9 }, usePointStyle: true }
            },
            datalabels: {
              formatter: (v) => {
                if (!v) return "";
                const pct = Math.round((v * 100) / total);
                return pct ? pct + "%" : "";
              },
              color: "#111827",
              font: { size: 9, weight: "600" }
            }
          },
          layout: {
            padding: { top: 5, bottom: 5, left: 0, right: 0 }
          }
        }
      });

      if (!activos.length) {
        textoClientesTipo.innerHTML = `
          No hay clientes con 2N activo en esta vista.
        `;
        tablaClientes2NBody.innerHTML = "";
        return;
      }

      const resumenTipos = labels.map(l => `${l}: ${counts[l]} clientes`).join(" ¬∑ ");
      textoClientesTipo.innerHTML = `
        <strong>Clientes 2N por tipo de cliente:</strong><br/>
        ${resumenTipos}.
      `;

      const topActivos = activos
        .slice()
        .sort((a, b) => (b.num_obras || 0) - (a.num_obras || 0))
        .slice(0, 15);

      tablaClientes2NBody.innerHTML = topActivos
        .map(c => `
          <tr>
            <td>${c.nombre_display || ""}</td>
            <td>${c.tipo || ""}</td>
            <td>${c.segmento || ""}</td>
            <td>${c.provincia || ""}</td>
            <td>${c.num_obras || 0}</td>
          </tr>
        `)
        .join("");
    }

    function aplicarFiltrosYRender() {
      const { proy, clis } = filtrarDatos();
      updateFiltrosTexto();
      renderKPIs(proy);
      renderChartEstado(proy);
      renderChartEncaje(proy);
      renderChartSegmento(clis);
      renderChartClientesTipo(clis);
    }

    fVista.addEventListener("change", aplicarFiltrosYRender);
    fZona.addEventListener("change", aplicarFiltrosYRender);
    fEstado.addEventListener("change", aplicarFiltrosYRender);
    fEncaje.addEventListener("change", aplicarFiltrosYRender);
    buscadorGlobal.addEventListener("input", () => {
      clearTimeout(buscadorGlobal._t);
      buscadorGlobal._t = setTimeout(aplicarFiltrosYRender, 200);
    });

    btnExportPDF.addEventListener("click", async () => {
      const { jsPDF } = window.jspdf;
      btnExportPDF.disabled = true;
      btnExportPDF.textContent = "Generando PDF...";

      try {
        const cards = Array.from(document.querySelectorAll(".chart-page"));
        let pdf = null;
        const pageWidth = 210;
        const pageHeight = 297;
        const margin = 10;
        const headerHeight = 18;
        const fechaStr = new Date().toLocaleDateString("es-ES");

        function drawHeader(pdfInstance, title, pageIndex) {
          pdfInstance.setFillColor(15, 23, 42);
          pdfInstance.rect(0, 0, pageWidth, headerHeight, "F");

          pdfInstance.setFont("helvetica", "bold");
          pdfInstance.setFontSize(11);
          pdfInstance.setTextColor(255, 255, 255);
          pdfInstance.text("CRM 2N ¬∑ Reporte analista de mercado", margin, 7);

          pdfInstance.setFont("helvetica", "normal");
          pdfInstance.setFontSize(9);
          pdfInstance.text(title, margin, 14);

          pdfInstance.setFontSize(8);
          pdfInstance.setTextColor(209, 213, 219);
          pdfInstance.text(fechaStr, pageWidth - margin, 7, { align: "right" });
          pdfInstance.text("P√°gina " + pageIndex, pageWidth - margin, 14, { align: "right" });

          pdfInstance.setTextColor(17, 24, 39);
        }

        let pageIndex = 1;

        for (const card of cards) {
          const title = card.dataset.title || "Reporte CRM 2N";

          const canvas = await html2canvas(card, {
            scale: 2,
            useCORS: true,
            windowWidth: document.documentElement.scrollWidth
          });
          const imgData = canvas.toDataURL("image/png");

          const maxW = pageWidth - margin * 2;
          const maxH = pageHeight - headerHeight - margin * 2;
          const imgRatio = canvas.width / canvas.height;
          let imgW = maxW;
          let imgH = imgW / imgRatio;
          if (imgH > maxH) {
            imgH = maxH;
            imgW = imgH * imgRatio;
          }

          const offsetX = (pageWidth - imgW) / 2;
          const offsetY = headerHeight + ((pageHeight - headerHeight - imgH) / 2);

          if (!pdf) {
            pdf = new jsPDF("p", "mm", "a4");
          } else {
            pdf.addPage();
          }

          drawHeader(pdf, title, pageIndex++);
          pdf.addImage(imgData, "PNG", offsetX, offsetY, imgW, imgH);
        }

        if (pdf) {
          pdf.save("reporte_crm_2n.pdf");
        } else {
          alert("No hay datos para exportar.");
        }
      } catch (err) {
        console.error("Error generando PDF:", err);
        alert("Ha ocurrido un error al generar el PDF.");
      } finally {
        btnExportPDF.disabled = false;
        btnExportPDF.textContent = "üìÑ Descargar PDF del reporte";
      }
    });

    cargarDatos();
  </script>

  <!-- Guardia de autenticaci√≥n -->
  <script type="module" src="auth.js"></script>
</body>
</html>
