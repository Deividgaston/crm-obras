<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM 2N ‚Äì Reportes</title>
  <link rel="stylesheet" href="style.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <!-- PDF (html2canvas + jsPDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      align-items: stretch;
    }
    .chart-card {
      background: #FFFFFF;
      border-radius: 12px;
      padding: 8px 10px 8px 10px;
      border: 1px solid #E5E7EB;
      display: flex;
      flex-direction: column;
      min-height: 260px;
    }
    .chart-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 4px;
    }
    .chart-card-title {
      font-size: 12px;
      font-weight: 600;
      color: #111827;
    }
    .chart-card-sub {
      font-size: 10.5px;
      color: #6B7280;
      margin-bottom: 6px;
    }
    .chart-card-wrapper {
      position: relative;
      height: 360px; /* M√ÅS GRANDE PARA EL GR√ÅFICO + LEYENDA DERECHA */
      margin-bottom: 6px;
    }
    .chart-card-data {
      font-size: 10px;
      color: #4B5563;
      background: #F9FAFB;
      padding: 6px 7px;
      border-radius: 8px;
      border: 1px dashed #E5E7EB;
    }
    .chart-legend-right {
      position: absolute;
      top: 18px;
      right: 2px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 10px;
      background: rgba(255,255,255,0.9);
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid #E5E7EB;
      max-width: 140px;
      pointer-events: none;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .legend-color {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,0.15);
    }
    .chart-container-inner {
      position: relative;
      height: 100%;
      padding-right: 150px; /* deja espacio a la derecha para la leyenda */
    }
    .chart-canvas {
      position: absolute;
      inset: 0 150px 0 0;
    }

    .filtros-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    .select-input {
      border-radius: 999px;
      border: 1px solid #D1D5DB;
      background: #F9FAFB;
      font-size: 11px;
      padding: 4px 8px;
      color: #111827;
    }
    .select-input:focus {
      outline: none;
      border-color: #2563EB;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.15);
      background: #FFFFFF;
    }
    .search-input {
      border-radius: 999px;
      border: 1px solid #D1D5DB;
      padding: 4px 8px;
      font-size: 11px;
      min-width: 140px;
    }
    .search-input:focus {
      outline: none;
      border-color: #2563EB;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.15);
      background: #FFFFFF;
    }

    .report-kpis-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    .report-kpi {
      flex: 1 1 140px;
      background: linear-gradient(135deg, #F9FAFB 0%, #EFF6FF 100%);
      border-radius: 10px;
      padding: 6px 8px;
      border: 1px solid #E5E7EB;
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    .report-kpi-label {
      font-size: 10px;
      color: #6B7280;
      margin-bottom: 2px;
    }
    .report-kpi-value {
      font-size: 16px;
      font-weight: 700;
      color: #111827;
      line-height: 1.1;
    }
    .report-kpi-footnote {
      font-size: 9px;
      color: #9CA3AF;
    }

    .tabla-mini {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 10px;
    }
    .tabla-mini th,
    .tabla-mini td {
      padding: 3px 4px;
      text-align: left;
      border: 1px solid #E5E7EB;
    }
    .tabla-mini th {
      background: #F3F4F6;
      font-weight: 600;
      color: #111827;
    }

    @media (max-width: 900px) {
      .charts-grid {
        grid-template-columns: minmax(0, 1fr);
      }

      .chart-card-wrapper {
        height: 320px;
      }

      .chart-container-inner {
        padding-right: 130px;
      }
      .chart-canvas {
        inset: 0 130px 0 0;
      }
      .chart-legend-right {
        max-width: 130px;
      }
    }
  </style>
</head>

<body>
  <!-- NAV SUPERIOR -->
  <div class="topnav">
    <div class="logo">CRM 2N</div>

    <div class="nav-tabs">
      <div class="nav-item" onclick="location.href='index.html'">Dashboard</div>
      <div class="nav-item" onclick="location.href='proyectos.html'">Proyectos</div>
      <div class="nav-item" onclick="location.href='buscar.html'">Buscar</div>
      <div class="nav-item" onclick="location.href='pipeline.html'">Pipeline</div>
      <div class="nav-item" onclick="location.href='clientes.html'">Clientes</div>
      <div class="nav-item" onclick="location.href='tareas.html'">Tareas</div>
      <div class="nav-item active" onclick="location.href='reportes.html'">Reportes</div>
    </div>

    <div style="display:flex;align-items:center;gap:8px;">
      <input type="text" class="search-box" id="buscadorGlobal" placeholder="Filtrar proyectos / clientes..." />
      <button
        id="btnLogout"
        type="button"
        style="
          font-size:11px;
          padding:6px 10px;
          border-radius:999px;
          border:1px solid #E5E7EB;
          background:#FFFFFF;
          color:#111827;
          cursor:pointer;
          white-space:nowrap;
        "
      >
        Cerrar sesi√≥n
      </button>
    </div>
  </div>

  <main class="content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <div>
        <h2 style="margin-top:0;margin-bottom:4px;color:#16325C;">Reportes ¬∑ Vista analista de mercado</h2>
        <div style="font-size:12px;color:#5A6872;">
          4 gr√°ficos clave en una sola vista ¬∑ PDF con un gr√°fico grande por p√°gina.
        </div>
      </div>
      <button id="btnExportPDF" class="btn-primary" type="button" style="font-size:11px;padding:6px 12px;">
        üìÑ Descargar PDF del reporte
      </button>
    </div>

    <!-- FILTROS -->
    <div class="card" style="margin-bottom:10px;">
      <div class="filtros-bar">
        <select id="fVista" class="select-input">
          <option value="general">Vista general</option>
          <option value="solo2n">Clientes que trabajan con 2N</option>
        </select>

        <select id="fZona" class="select-input">
          <option value="Todas">Todas las zonas</option>
        </select>

        <select id="fEstado" class="select-input">
          <option value="Todos">Todos los estados</option>
        </select>

        <select id="fEncaje" class="select-input">
          <option value="Todos">Todos los encajes 2N</option>
          <option value="ALTO">Encaje ALTO</option>
          <option value="MEDIO">Encaje MEDIO</option>
          <option value="BAJO">Encaje BAJO</option>
          <option value="SIN">Sin dato de encaje</option>
        </select>

        <input
          id="buscadorLocal"
          type="text"
          class="search-input"
          placeholder="Filtrar por obra / cliente..."
        />
      </div>

      <div style="font-size:10.5px;color:#6B7280;">
        <span id="textoFiltrosResumen"></span>
      </div>
    </div>

    <!-- KPIs -->
    <div class="report-kpis-row">
      <div class="report-kpi">
        <div class="report-kpi-label">Proyectos en vista actual</div>
        <div class="report-kpi-value" id="kpiProyectos">‚Äì</div>
        <div class="report-kpi-footnote">
          Contando todos los estados (detectado ‚Üí ganado/perdido/paralizado).
        </div>
      </div>
      <div class="report-kpi">
        <div class="report-kpi-label">Encaje 2N alto + medio</div>
        <div class="report-kpi-value" id="kpiEncajeAltoMedio">‚Äì</div>
        <div class="report-kpi-footnote">
          N√∫mero de obras donde 2N encaja muy bien o razonablemente bien.
        </div>
      </div>
    </div>

    <!-- GRID 2x2 GR√ÅFICOS -->
    <div class="charts-grid" id="chartsGrid">

      <!-- 1) ESTADO DEL PIPELINE -->
      <div class="chart-card">
        <div class="chart-card-header">
          <div class="chart-card-title">Estado del pipeline</div>
        </div>
        <div class="chart-card-sub">
          Distribuci√≥n de proyectos por estado actual (detectado, prescripci√≥n, oferta, negociaci√≥n, ganado, perdido, paralizado).
        </div>
        <div class="chart-card-wrapper">
          <div class="chart-container-inner">
            <canvas id="chartEstado" class="chart-canvas"></canvas>
            <div id="legendEstado" class="chart-legend-right"></div>
          </div>
        </div>
        <div id="datosEstado" class="chart-card-data">
          Sin datos a√∫n.
        </div>
      </div>

      <!-- 2) ENCAJE 2N -->
      <div class="chart-card">
        <div class="chart-card-header">
          <div class="chart-card-title">Encaje 2N en los proyectos</div>
        </div>
        <div class="chart-card-sub">
          Obras donde las soluciones 2N tienen un encaje alto, medio, bajo o sin dato.
        </div>
        <div class="chart-card-wrapper">
          <div class="chart-container-inner">
            <canvas id="chartEncaje" class="chart-canvas"></canvas>
            <div id="legendEncaje" class="chart-legend-right"></div>
          </div>
        </div>
        <div id="datosEncaje" class="chart-card-data">
          Sin datos a√∫n.
        </div>
      </div>

      <!-- 3) SEGMENTO / TIPO DE PROYECTO -->
      <div class="chart-card">
        <div class="chart-card-header">
          <div class="chart-card-title">Proyectos por segmento</div>
        </div>
        <div class="chart-card-sub">
          Segmento de los proyectos (BTR, BTS, coliving, hotel, oficinas, residencial, etc.).
        </div>
        <div class="chart-card-wrapper">
          <div class="chart-container-inner">
            <canvas id="chartSegmento" class="chart-canvas"></canvas>
            <div id="legendSegmento" class="chart-legend-right"></div>
          </div>
        </div>
        <div id="datosSegmento" class="chart-card-data">
          Sin datos a√∫n.
        </div>
      </div>

      <!-- 4) CLIENTES QUE TRABAJAN CON 2N -->
      <div class="chart-card">
        <div class="chart-card-header">
          <div class="chart-card-title">Clientes que trabajan con 2N por tipo</div>
        </div>
        <div class="chart-card-sub">
          Tipo de cliente (promotora, arquitectura, ingenier√≠a, fondo, etc.) que ya tiene proyectos activos con 2N.
        </div>
        <div class="chart-card-wrapper">
          <div class="chart-container-inner">
            <canvas id="chartClientesTipo" class="chart-canvas"></canvas>
            <div id="legendClientesTipo" class="chart-legend-right"></div>
          </div>
        </div>
        <div id="datosClientesTipo" class="chart-card-data">
          Sin datos a√∫n.
        </div>
      </div>

    </div>

    <!-- TABLA MINI DE CLIENTES 2N -->
    <div class="card" style="margin-top:10px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
        <div style="font-size:11.5px;font-weight:600;color:#111827;">
          Clientes con proyectos activos 2N (vista actual)
        </div>
        <div id="textoClientesTipo" style="font-size:10px;color:#6B7280;">
          Sin datos.
        </div>
      </div>

      <div style="max-height:220px;overflow:auto;">
        <table class="tabla-mini" id="tablaClientes2N">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Tipo</th>
              <th>Segmento</th>
              <th>Provincia</th>
              <th># Obras activas</th>
            </tr>
          </thead>
          <tbody>
            <!-- Se rellena por JS -->
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script type="module">
    import { db } from "./firebase.js";
    import {
      collection,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    let proyectos = [];
    let clientes = [];
    let clientesView = [];

    let chartEstado = null;
    let chartEncaje = null;
    let chartSegmento = null;
    let chartClientesTipo = null;

    const fVista = document.getElementById("fVista");
    const fZona = document.getElementById("fZona");
    const fEstado = document.getElementById("fEstado");
    const fEncaje = document.getElementById("fEncaje");
    const buscadorGlobal = document.getElementById("buscadorGlobal");

    const kpiProyectos = document.getElementById("kpiProyectos");
    const kpiEncajeAltoMedio = document.getElementById("kpiEncajeAltoMedio");
    const textoFiltrosResumen = document.getElementById("textoFiltrosResumen");

    const datosEstado = document.getElementById("datosEstado");
    const datosEncaje = document.getElementById("datosEncaje");
    const datosSegmento = document.getElementById("datosSegmento");
    const datosClientesTipo = document.getElementById("datosClientesTipo");
    const textoClientesTipo = document.getElementById("textoClientesTipo");
    const tablaClientes2NBody = document.querySelector("#tablaClientes2N tbody");

    const btnExportPDF = document.getElementById("btnExportPDF");

    function norm(text) {
      return (text || "")
        .toString()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .trim();
    }

    function contarObrasPorClienteNombre(nombreCliente) {
      const target = (nombreCliente || "").toString().toLowerCase().trim();
      if (!target) return 0;
      return proyectos.filter(p => {
        const c = (p.cliente_principal || "").toString().toLowerCase().trim();
        return c === target;
      }).length;
    }

    async function cargarDatos() {
      const [snapProy, snapCli] = await Promise.all([
        getDocs(collection(db, "proyectos")),
        getDocs(collection(db, "clientes"))
      ]);

      proyectos = snapProy.docs.map(d => ({ id: d.id, ...d.data() }));
      clientes = snapCli.docs.map(d => ({ id: d.id, ...d.data() }));

      buildClientesView();
      inicializarFiltroProvincia();
      inicializarFiltroEstado();
      aplicarFiltrosYRender();
    }

    function buildClientesView() {
      clientesView = clientes.map(c => {
        const nombre = c.nombre || c.nombre_cliente || "";
        return {
          ...c,
          nombre_display: nombre,
          num_obras: contarObrasPorClienteNombre(nombre)
        };
      });
    }

    function inicializarFiltroProvincia() {
      const provincias = new Set();
      proyectos.forEach(p => { if (p.provincia) provincias.add(p.provincia); });
      clientes.forEach(c => { if (c.provincia) provincias.add(c.provincia); });

      const arr = Array.from(provincias).sort((a, b) => a.localeCompare(b, "es"));

      fZona.innerHTML = '<option value="Todas">Todas las zonas</option>' +
        arr.map(z => `<option value="${z}">${z}</option>`).join("");
    }

    function inicializarFiltroEstado() {
      const estadosSet = new Set();
      proyectos.forEach(p => { if (p.estado) estadosSet.add(p.estado); });
      const arr = Array.from(estadosSet).sort((a, b) => a.localeCompare(b, "es"));

      fEstado.innerHTML = '<option value="Todos">Todos los estados</option>' +
        arr.map(e => `<option value="${e}">${e}</option>`).join("");
    }

    function filtrarDatos() {
      let proy = [...proyectos];
      let clis = [...clientesView];

      const vista = fVista.value;
      const provincia = fZona.value;
      const estado = fEstado.value;
      const encaje = fEncaje.value;
      const texto = norm(buscadorGlobal.value || "");

      if (provincia !== "Todas") {
        proy = proy.filter(p => p.provincia === provincia);
        clis = clis.filter(c => c.provincia === provincia);
      }

      if (estado !== "Todos") {
        proy = proy.filter(p => (p.estado || "") === estado);
      }

      if (encaje !== "Todos") {
        proy = proy.filter(p => {
          const e = (p.encaje_2n || "").toString().toUpperCase().trim();
          if (encaje === "SIN") {
            return !e;
          }
          return e === encaje;
        });
      }

      if (vista === "solo2n") {
        proy = proy.filter(p => !!p.encaje_2n && ["ALTO", "MEDIO"].includes((p.encaje_2n || "").toString().toUpperCase().trim()));
        clis = clis.filter(c => c.trabaja_con_2n === true);
      }

      if (texto) {
        proy = proy.filter(p => {
          const blob = [
            p.nombre_obra,
            p.cliente_principal,
            p.ciudad,
            p.provincia
          ].join(" ");
          return norm(blob).includes(texto);
        });

        clis = clis.filter(c => {
          const blob = [
            c.nombre_display,
            c.tipo,
            c.segmento,
            c.provincia
          ].join(" ");
          return norm(blob).includes(texto);
        });
      }

      return { proy, clis };
    }

    function actualizarResumenFiltros({ proy, clis }) {
      const totalProy = proy.length;
      const encajeAlto = proy.filter(p => (p.encaje_2n || "").toString().toUpperCase().trim() === "ALTO").length;
      const encajeMedio = proy.filter(p => (p.encaje_2n || "").toString().toUpperCase().trim() === "MEDIO").length;

      kpiProyectos.textContent = totalProy || "0";
      kpiEncajeAltoMedio.textContent = (encajeAlto + encajeMedio) || "0";

      const partes = [];
      if (fVista.value === "solo2n") partes.push("Vista: solo clientes que trabajan con 2N");
      if (fZona.value !== "Todas") partes.push(`Zona: ${fZona.value}`);
      if (fEstado.value !== "Todos") partes.push(`Estado: ${fEstado.value}`);
      if (fEncaje.value !== "Todos") {
        partes.push(
          fEncaje.value === "SIN"
            ? "Encaje: sin dato"
            : `Encaje 2N: ${fEncaje.value}`
        );
      }
      if (!partes.length) {
        textoFiltrosResumen.textContent = "Vista general sin filtros adicionales.";
      } else {
        textoFiltrosResumen.textContent = partes.join(" ¬∑ ");
      }
    }

    function destroyChartIfExists(chart) {
      if (chart) chart.destroy();
    }

    function colorPalette() {
      return [
        "#1D4ED8", "#EC4899", "#10B981", "#F97316", "#6366F1",
        "#14B8A6", "#F59E0B", "#8B5CF6", "#22C55E", "#EF4444"
      ];
    }

    function buildPieConfig(labels, data) {
      const colors = colorPalette().slice(0, labels.length);
      return {
        type: "pie",
        data: {
          labels,
          datasets: [
            {
              data,
              backgroundColor: colors,
              borderColor: "#FFFFFF",
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { top: 10, bottom: 10, left: 10, right: 10 } },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0) || 1;
                  const value = context.parsed;
                  const pct = ((value / total) * 100).toFixed(1);
                  return `${context.label}: ${value} (${pct}%)`;
                }
              }
            },
            datalabels: {
              color: "#111827",
              font: { size: 10, weight: "600" },
              formatter: (value, ctx) => {
                const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0) || 1;
                const pct = (value / total) * 100;
                return pct >= 5 ? `${pct.toFixed(0)}%` : "";
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      };
    }

    function renderLegend(containerId, labels, data) {
      const el = document.getElementById(containerId);
      if (!el) return;
      el.innerHTML = "";

      const total = data.reduce((a, b) => a + b, 0) || 1;
      const colors = colorPalette().slice(0, labels.length);

      labels.forEach((label, idx) => {
        const value = data[idx] || 0;
        const pct = ((value / total) * 100) || 0;

        const item = document.createElement("div");
        item.className = "legend-item";
        item.innerHTML = `
          <div class="legend-color" style="background:${colors[idx]};"></div>
          <div style="flex:1;">
            <div style="font-size:10px;color:#111827;">${label}</div>
            <div style="font-size:9px;color:#6B7280;">${value} ¬∑ ${pct.toFixed(1)}%</div>
          </div>
        `;
        el.appendChild(item);
      });
    }

    function renderChartEstado(proyFiltrados) {
      const conteo = {
        "Detectado": 0,
        "En Prescripci√≥n": 0,
        "Oferta Enviada": 0,
        "Negociaci√≥n": 0,
        "Ganado": 0,
        "Perdido": 0,
        "Paralizado": 0
      };

      proyFiltrados.forEach(p => {
        const estado = p.estado || "Detectado";
        if (conteo[estado] === undefined) conteo[estado] = 0;
        conteo[estado]++;
      });

      const labels = Object.keys(conteo);
      const data = labels.map(l => conteo[l] || 0);

      destroyChartIfExists(chartEstado);
      const ctx = document.getElementById("chartEstado").getContext("2d");
      const cfg = buildPieConfig(labels, data);
      chartEstado = new Chart(ctx, cfg);

      renderLegend("legendEstado", labels, data);

      const total = data.reduce((a, b) => a + b, 0);
      if (!total) {
        datosEstado.textContent = "No hay proyectos en la vista actual.";
      } else {
        datosEstado.textContent = `Total proyectos: ${total}. Estados dominantes: ${
          labels
            .map((l, idx) => ({ label: l, value: data[idx] }))
            .sort((a, b) => (b.value || 0) - (a.value || 0))
            .slice(0, 3)
            .map(x => `${x.label} (${x.value})`)
            .join(", ")
        }.`;
      }
    }

    function renderChartEncaje(proyFiltrados) {
      const conteo = {
        "ALTO": 0,
        "MEDIO": 0,
        "BAJO": 0,
        "SIN DATO": 0
      };

      proyFiltrados.forEach(p => {
        const e = (p.encaje_2n || "").toString().toUpperCase().trim();
        if (e === "ALTO") conteo["ALTO"]++;
        else if (e === "MEDIO") conteo["MEDIO"]++;
        else if (e === "BAJO") conteo["BAJO"]++;
        else conteo["SIN DATO"]++;
      });

      const labels = Object.keys(conteo);
      const data = labels.map(l => conteo[l] || 0);

      destroyChartIfExists(chartEncaje);
      const ctx = document.getElementById("chartEncaje").getContext("2d");
      const cfg = buildPieConfig(labels, data);
      chartEncaje = new Chart(ctx, cfg);

      renderLegend("legendEncaje", labels, data);

      const total = data.reduce((a, b) => a + b, 0);
      if (!total) {
        datosEncaje.textContent = "No hay datos de encaje para los proyectos de la vista actual.";
      } else {
        const altoMedio = conteo["ALTO"] + conteo["MEDIO"];
        const pct = ((altoMedio / total) * 100).toFixed(1);
        datosEncaje.textContent =
          `Total proyectos: ${total}. Encaje ALTO + MEDIO en ${altoMedio} obras (${pct}%).`;
      }
    }

    function renderChartSegmento(proyFiltrados) {
      const conteo = {};
      proyFiltrados.forEach(p => {
        let seg = (p.segmento || p.tipo || "Sin segmento").toString().trim();
        if (!seg) seg = "Sin segmento";
        if (!conteo[seg]) conteo[seg] = 0;
        conteo[seg]++;
      });

      const labels = Object.keys(conteo);
      const data = labels.map(l => conteo[l] || 0);

      destroyChartIfExists(chartSegmento);
      const ctx = document.getElementById("chartSegmento").getContext("2d");
      const cfg = buildPieConfig(labels, data);
      chartSegmento = new Chart(ctx, cfg);

      renderLegend("legendSegmento", labels, data);

      const total = data.reduce((a, b) => a + b, 0);
      if (!total) {
        datosSegmento.textContent = "No hay proyectos suficientes para mostrar segmentos.";
      } else {
        datosSegmento.textContent =
          `Total proyectos: ${total}. Segmentos principales: ${
            labels
              .map((l, idx) => ({ label: l, value: data[idx] }))
              .sort((a, b) => (b.value || 0) - (a.value || 0))
              .slice(0, 3)
              .map(x => `${x.label} (${x.value})`)
              .join(", ")
          }.`;
      }
    }

    function renderChartClientesTipo(clientesFiltrados) {
      const solo2n = clientesFiltrados.filter(c => c.trabaja_con_2n === true);

      const conteo = {};
      solo2n.forEach(c => {
        const tipo = (c.tipo || "Sin tipo").toString().trim();
        if (!conteo[tipo]) conteo[tipo] = 0;
        conteo[tipo] += c.num_obras || 1;
      });

      const labels = Object.keys(conteo);
      const data = labels.map(l => conteo[l] || 0);

      destroyChartIfExists(chartClientesTipo);
      const ctx = document.getElementById("chartClientesTipo").getContext("2d");
      const cfg = buildPieConfig(labels, data);
      chartClientesTipo = new Chart(ctx, cfg);

      renderLegend("legendClientesTipo", labels, data);

      const totalClientes2N = solo2n.length;
      const totalObras2N = data.reduce((a, b) => a + b, 0);

      if (!totalClientes2N) {
        datosClientesTipo.textContent =
          "No hay clientes marcados como que trabajan con 2N en la vista actual.";
      } else {
        datosClientesTipo.textContent =
          `Clientes activos con 2N: ${totalClientes2N}. Obras asociadas en la vista: ${totalObras2N}.`;
      }

      const topActivos = solo2n
        .slice()
        .sort((a, b) => (b.num_obras || 0) - (a.num_obras || 0))
        .slice(0, 15);

      tablaClientes2NBody.innerHTML = topActivos
        .map(c => `
          <tr>
            <td>${c.nombre_display || ""}</td>
            <td>${c.tipo || ""}</td>
            <td>${c.segmento || ""}</td>
            <td>${c.provincia || ""}</td>
            <td>${c.num_obras || 0}</td>
          </tr>
        `)
        .join("");
    }

    function aplicarFiltrosYRender() {
      const { proy, clis } = filtrarDatos();

      actualizarResumenFiltros({ proy, clis });

      renderChartEstado(proy);
      renderChartEncaje(proy);
      renderChartSegmento(proy);
      renderChartClientesTipo(clis);
    }

    fVista.addEventListener("change", aplicarFiltrosYRender);
    fZona.addEventListener("change", aplicarFiltrosYRender);
    fEstado.addEventListener("change", aplicarFiltrosYRender);
    fEncaje.addEventListener("change", aplicarFiltrosYRender);
    document.getElementById("buscadorLocal").addEventListener("input", aplicarFiltrosYRender);
    buscadorGlobal.addEventListener("input", aplicarFiltrosYRender);

    btnExportPDF.addEventListener("click", async () => {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ format: "a4", unit: "pt" });

      const charts = [
        { id: "chartEstado", title: "Estado del pipeline" },
        { id: "chartEncaje", title: "Encaje 2N en los proyectos" },
        { id: "chartSegmento", title: "Proyectos por segmento" },
        { id: "chartClientesTipo", title: "Clientes que trabajan con 2N por tipo" }
      ];

      btnExportPDF.disabled = true;
      btnExportPDF.textContent = "Generando PDF...";

      try {
        for (let i = 0; i < charts.length; i++) {
          const { id, title } = charts[i];
          const canvas = document.getElementById(id);

          if (!canvas) continue;

          const canvasRect = canvas.getBoundingClientRect();
          const clone = canvas.cloneNode(true);
          const wrapper = document.createElement("div");
          wrapper.style.position = "relative";
          wrapper.style.width = canvasRect.width + "px";
          wrapper.style.height = canvasRect.height + "px";
          wrapper.appendChild(clone);
          document.body.appendChild(wrapper);

          const canvasImg = await html2canvas(wrapper, { scale: 2 });
          const imgData = canvasImg.toDataURL("image/png");

          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();

          const margin = 40;
          const availableWidth = pageWidth - margin * 2;
          const availableHeight = pageHeight - margin * 2 - 40;

          let imgWidth = availableWidth;
          let imgHeight = (canvasImg.height * imgWidth) / canvasImg.width;

          if (imgHeight > availableHeight) {
            imgHeight = availableHeight;
            imgWidth = (canvasImg.width * imgHeight) / canvasImg.height;
          }

          if (i > 0) pdf.addPage();

          pdf.setFontSize(14);
          pdf.setTextColor(17, 24, 39);
          pdf.text(title, margin, margin + 10);

          const x = (pageWidth - imgWidth) / 2;
          const y = margin + 30;

          pdf.addImage(imgData, "PNG", x, y, imgWidth, imgHeight);

          document.body.removeChild(wrapper);
        }
      } catch (err) {
        console.error("Error generando PDF:", err);
        alert("Ha ocurrido un error al generar el PDF.");
      } finally {
        btnExportPDF.disabled = false;
        btnExportPDF.textContent = "üìÑ Descargar PDF del reporte";
      }
    });

    cargarDatos();
  </script>

  <!-- Guardia de autenticaci√≥n -->
  <script type="module" src="auth.js"></script>
</body>
</html>
