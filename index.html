<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM 2N – Dashboard</title>
  <link rel="stylesheet" href="style.css" />

  <!-- Chart.js para el donut de encaje 2N -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
</head>

<body>
  <!-- NAV SUPERIOR -->
  <div class="topnav">
    <div class="logo">CRM 2N</div>

    <div class="nav-tabs">
      <div class="nav-item active" onclick="location.href='index.html'">Dashboard</div>
      <div class="nav-item" onclick="location.href='proyectos.html'">Proyectos</div>
      <div class="nav-item" onclick="location.href='buscar.html'">Buscar</div>
      <div class="nav-item" onclick="location.href='pipeline.html'">Pipeline</div>
      <div class="nav-item" onclick="location.href='clientes.html'">Clientes</div>
      <div class="nav-item" onclick="location.href='tareas.html'">Tareas</div>
      <div class="nav-item" onclick="location.href='reportes.html'">Reportes</div>
    </div>

    <input type="text" class="search-box" placeholder="(Solo UI) Buscar..." />
  </div>

  <main class="content">
    <h2 style="margin-top:0;margin-bottom:4px;color:#16325C;">Dashboard general</h2>
    <div style="font-size:12px;color:#5A6872;margin-bottom:16px;">
      Vista rápida de proyectos, encaje 2N y seguimientos de la próxima semana.
    </div>

    <!-- FILA KPIs -->
    <div class="kpi-row" style="margin-bottom:14px;">
      <div class="kpi-card">
        <div class="kpi-label">Proyectos totales</div>
        <div id="kpiTotal" class="kpi-value">–</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">En curso</div>
        <div id="kpiEnCurso" class="kpi-value">–</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Ganados</div>
        <div id="kpiGanados" class="kpi-value">–</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Perdidos</div>
        <div id="kpiPerdidos" class="kpi-value">–</div>
      </div>
    </div>

    <!-- FILA PRINCIPAL: DONUT + SEGUIMIENTOS -->
    <div style="display:grid;grid-template-columns:minmax(0,0.9fr) minmax(0,1.1fr);gap:16px;align-items:flex-start;">
      <!-- CARD DONUT ENCAJE 2N -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
          <div>
            <div style="font-size:12px;font-weight:600;color:#111827;">
              Obras potenciales 2N (ALTO / MEDIO)
            </div>
            <div style="font-size:10.5px;color:#6B7280;">
              Distribución por encaje 2N de todos los proyectos del CRM.
            </div>
          </div>
        </div>
        <div style="position:relative;height:220px;">
          <canvas id="chartEncaje"></canvas>
        </div>
      </div>

      <!-- CARD SEGUIMIENTOS PRÓXIMOS 7 DÍAS -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
          <div>
            <div style="font-size:12px;font-weight:600;color:#111827;">
              Seguimientos próximos 7 días
            </div>
            <div style="font-size:10.5px;color:#6B7280;">
              Proyectos con fecha de seguimiento entre hoy y los próximos 7 días.
            </div>
          </div>
        </div>

        <div id="seguimientosList" style="display:flex;flex-direction:column;gap:6px;"></div>
      </div>
    </div>
  </main>

  <!-- DIALOGO EDICIÓN SEGUIMIENTO / TAREA -->
  <dialog id="seguimientoDialog">
    <div class="modal-header">Editar seguimiento</div>
    <form id="seguimientoForm" method="dialog">
      <input type="hidden" id="segProjId" />

      <div class="form-group">
        <label style="font-size:12px;font-weight:600;color:#111827;">Proyecto</label>
        <div id="segNombreObra" style="font-size:12px;color:#374151;padding:6px 8px;border-radius:6px;background:#F9FAFB;border:1px solid #E5E7EB;"></div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label for="segFecha" style="font-size:11.5px;font-weight:600;color:#111827;">Fecha seguimiento</label>
          <input id="segFecha" type="date" />
        </div>
        <div class="form-group">
          <label for="tareaFecha" style="font-size:11.5px;font-weight:600;color:#111827;">Fecha tarea</label>
          <input id="tareaFecha" type="date" />
        </div>
      </div>

      <div class="form-group">
        <label for="segComentario" style="font-size:11.5px;font-weight:600;color:#111827;">Comentario seguimiento</label>
        <textarea id="segComentario" rows="3"></textarea>
      </div>

      <div class="form-group">
        <label for="tareaComentario" style="font-size:11.5px;font-weight:600;color:#111827;">Descripción tarea</label>
        <textarea id="tareaComentario" rows="3"></textarea>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="window.closeSegDialog()">Cancelar</button>
        <button type="submit" class="btn-primary">Guardar</button>
      </div>
    </form>
  </dialog>

  <script type="module">
    import { db } from "./firebase.js";
    import {
      collection,
      getDocs,
      updateDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    let proyectos = [];
    let chartEncaje = null;

    const kpiTotal = document.getElementById("kpiTotal");
    const kpiEnCurso = document.getElementById("kpiEnCurso");
    const kpiGanados = document.getElementById("kpiGanados");
    const kpiPerdidos = document.getElementById("kpiPerdidos");

    const seguimientosList = document.getElementById("seguimientosList");
    const segDialog = document.getElementById("seguimientoDialog");
    const segForm = document.getElementById("seguimientoForm");

    const segProjId = document.getElementById("segProjId");
    const segNombreObra = document.getElementById("segNombreObra");
    const segFecha = document.getElementById("segFecha");
    const tareaFecha = document.getElementById("tareaFecha");
    const segComentario = document.getElementById("segComentario");
    const tareaComentario = document.getElementById("tareaComentario");

    async function cargarDashboard() {
      const snap = await getDocs(collection(db, "proyectos"));
      proyectos = [];
      snap.forEach(d => proyectos.push({ id: d.id, ...d.data() }));

      renderKpis();
      renderEncajeChart();
      renderSeguimientos();
    }

    function renderKpis() {
      const total = proyectos.length;
      const ganados = proyectos.filter(p => p.estado === "Ganado").length;
      const perdidos = proyectos.filter(p => p.estado === "Perdido").length;
      const enCurso = proyectos.filter(p =>
        p.estado &&
        !["Ganado", "Perdido"].includes(p.estado)
      ).length;

      kpiTotal.textContent = total;
      kpiGanados.textContent = ganados;
      kpiPerdidos.textContent = perdidos;
      kpiEnCurso.textContent = enCurso;
    }

    function renderEncajeChart() {
      const counts = { ALTO: 0, MEDIO: 0, BAJO: 0, SIN: 0 };

      proyectos.forEach(p => {
        const enc = (p.encaje_2n || "").toString().toUpperCase().trim();
        if (enc === "ALTO") counts.ALTO++;
        else if (enc === "MEDIO") counts.MEDIO++;
        else if (enc === "BAJO") counts.BAJO++;
        else counts.SIN++;
      });

      const data = [counts.ALTO, counts.MEDIO, counts.BAJO, counts.SIN];
      const total = data.reduce((a, b) => a + b, 0);

      const ctx = document.getElementById("chartEncaje").getContext("2d");
      if (chartEncaje) {
        chartEncaje.destroy();
      }

      // Registrar plugin de datalabels
      Chart.register(window.ChartDataLabels);

      chartEncaje = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["ALTO", "MEDIO", "BAJO", "SIN"],
          datasets: [
            {
              data,
              backgroundColor: ["#16A34A", "#FACC15", "#F97316", "#E5E7EB"],
              borderColor: "#FFFFFF",
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: "bottom",
              labels: {
                font: { size: 11 }
              }
            },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const val = ctx.raw || 0;
                  const pct = total ? Math.round((val * 100) / total) : 0;
                  return `${ctx.label}: ${val} (${pct}%)`;
                }
              }
            },
            datalabels: {
              formatter: (value, ctx) => {
                if (!total || !value) return "";
                const pct = Math.round((value * 100) / total);
                return pct ? pct + "%" : "";
              },
              color: "#111827",
              font: {
                weight: "700",
                size: 11
              }
            }
          },
          cutout: "55%"
        }
      });
    }

    function renderSeguimientos() {
      seguimientosList.innerHTML = "";

      const hoy = new Date();
      hoy.setHours(0, 0, 0, 0);
      const limite = new Date(hoy);
      limite.setDate(limite.getDate() + 7);
      limite.setHours(23, 59, 59, 999);

      const proximos = proyectos
        .filter(p => p.seguimiento_fecha)
        .map(p => {
          const d = new Date(p.seguimiento_fecha);
          if (isNaN(d.getTime())) return null;
          d.setHours(0, 0, 0, 0);
          return { ...p, _segDate: d };
        })
        .filter(p => p && p._segDate >= hoy && p._segDate <= limite)
        .sort((a, b) => a._segDate - b._segDate);

      if (!proximos.length) {
        const empty = document.createElement("div");
        empty.className = "empty-state";
        empty.textContent = "No hay seguimientos en los próximos 7 días.";
        seguimientosList.appendChild(empty);
        return;
      }

      proximos.forEach(p => {
        const fechaStr = p._segDate.toLocaleDateString("es-ES", {
          day: "2-digit",
          month: "2-digit"
        });

        const item = document.createElement("div");
        item.className = "seguimiento-item";
        item.style.border = "1px solid #E5E7EB";
        item.style.borderRadius = "8px";
        item.style.padding = "6px 8px";
        item.style.background = "#F9FAFB";

        item.innerHTML = `
          <div class="seguimiento-main" style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <button class="link-like" data-id="${p.id}"
              style="border:none;background:none;padding:0;margin:0;text-align:left;cursor:pointer;display:flex;flex-direction:column;gap:2px;">
              <span style="font-size:11px;color:#6B7280;">${fechaStr}</span>
              <span style="font-size:12px;font-weight:600;color:#111827;">${p.nombre_obra || ""}</span>
            </button>
            <div style="font-size:10.5px;color:#6B7280;white-space:nowrap;">
              ${p.estado || ""}
            </div>
          </div>
          <div class="seg-coment" style="font-size:11px;color:#4B5563;margin-top:4px;">
            ${(p.seguimiento_comentario || "").slice(0, 140) || "Sin comentario de seguimiento."}
          </div>
        `;

        seguimientosList.appendChild(item);
      });

      // Eventos de click para abrir diálogo
      seguimientosList.querySelectorAll("button.link-like").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          openSegDialog(id);
        });
      });
    }

    function openSegDialog(id) {
      const p = proyectos.find(x => x.id === id);
      if (!p) return;

      segProjId.value = p.id;
      segNombreObra.textContent = p.nombre_obra || "";
      segFecha.value = p.seguimiento_fecha || "";
      tareaFecha.value = p.tarea_fecha || "";
      segComentario.value = p.seguimiento_comentario || "";
      tareaComentario.value = p.tarea_comentario || "";

      segDialog.showModal();
    }

    window.closeSegDialog = function () {
      segDialog.close();
    };

    segForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = segProjId.value;
      if (!id) {
        segDialog.close();
        return;
      }

      const payload = {
        seguimiento_fecha: segFecha.value || null,
        seguimiento_comentario: segComentario.value.trim(),
        tarea_fecha: tareaFecha.value || null,
        tarea_comentario: tareaComentario.value.trim()
      };

      try {
        await updateDoc(doc(db, "proyectos", id), payload);
        segDialog.close();
        await cargarDashboard(); // recargar datos y volver a pintar
      } catch (err) {
        console.error("❌ Error guardando seguimiento:", err);
        alert("Error guardando el seguimiento.");
      }
    });

    // Inicializar
    cargarDashboard();
  </script>
</body>
</html>
