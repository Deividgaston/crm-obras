<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM 2N – Dashboard</title>
  <link rel="stylesheet" href="style.css" />

  <!-- Chart.js para el donut de encaje 2N -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <style>
    /* Drag & drop de paneles del dashboard */
    .dashboard-panel {
      cursor: grab;
    }
    .dashboard-panel.dragging {
      opacity: 0.6;
      cursor: grabbing;
    }
    .dashboard-panel.drop-target {
      outline: 2px dashed #4F46E5;
      outline-offset: 3px;
    }

    /* Contenedor específico del donut de encaje 2N */
    .donut-encaje-wrapper {
      position: relative;
      height: 260px;
      margin-bottom: 10px;
    }
    .donut-encaje-wrapper canvas {
      max-width: 100%;
      max-height: 100%;
    }
  </style>
</head>

<body>
  <script>
  // Detección sencilla de móvil
  const esMovil = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

  if (esMovil) {
    window.location.href = "mobile-index.html";
  }
</script>

  <!-- NAV SUPERIOR -->
  <div class="topnav">
    <div class="logo">CRM 2N</div>

    <div class="nav-tabs">
      <div class="nav-item active" onclick="location.href='index.html'">Dashboard</div>
      <div class="nav-item" onclick="location.href='proyectos.html'">Proyectos</div>
      <div class="nav-item" onclick="location.href='buscar.html'">Buscar</div>
      <div class="nav-item" onclick="location.href='pipeline.html'">Pipeline</div>
      <div class="nav-item" onclick="location.href='clientes.html'">Clientes</div>
      <div class="nav-item" onclick="location.href='tareas.html'">Tareas</div>
      <div class="nav-item" onclick="location.href='reportes.html'">Reportes</div>
    </div>

    <div style="display:flex;align-items:center;gap:8px;">
      <input
        type="text"
        class="search-box"
        placeholder="(Solo UI) Buscar..."
      />
      <button
        id="btnLogout"
        type="button"
        style="
          font-size:11px;
          padding:6px 10px;
          border-radius:999px;
          border:1px solid #E5E7EB;
          background:#FFFFFF;
          color:#111827;
          cursor:pointer;
          white-space:nowrap;
        "
      >
        Cerrar sesión
      </button>
    </div>
  </div>

  <main class="content">
    <h2 style="margin-top:0;margin-bottom:4px;color:#16325C;">Dashboard general</h2>
    <div style="font-size:12px;color:#5A6872;margin-bottom:16px;">
      Vista rápida de proyectos, encaje 2N, tareas y notas rápidas.
    </div>

    <!-- FILA KPIs -->
    <div class="kpi-row" style="margin-bottom:14px;">
      <div class="kpi-card">
        <div class="kpi-label">Proyectos totales</div>
        <div id="kpiTotal" class="kpi-value">–</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">En curso</div>
        <div id="kpiEnCurso" class="kpi-value">–</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Ganados</div>
        <div id="kpiGanados" class="kpi-value">–</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Perdidos</div>
        <div id="kpiPerdidos" class="kpi-value">–</div>
      </div>
    </div>

    <!-- GRID REORDENABLE DE PANELes -->
    <div
      id="dashboardPanels"
      style="
        display:grid;
        grid-template-columns:minmax(0,1.1fr) minmax(0,0.9fr);
        gap:16px;
        align-items:flex-start;
        margin-top:4px;
      "
    >

      <!-- PANEL 1: SEGUIMIENTOS -->
      <div class="card dashboard-panel" draggable="true" data-panel-id="seguimientos">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
          <div>
            <div style="font-size:12px;font-weight:600;color:#111827;">
              Seguimientos próximos 7 días
            </div>
            <div style="font-size:10.5px;color:#6B7280;">
              Proyectos con fecha de seguimiento entre hoy y los próximos 7 días.
            </div>
          </div>
        </div>
        <div id="seguimientosList" style="display:flex;flex-direction:column;gap:6px;"></div>
      </div>

      <!-- PANEL 2: ENCAJE 2N + TAREAS PROYECTOS -->
      <div class="card dashboard-panel" draggable="true" data-panel-id="encaje_tareas">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
          <div>
            <div style="font-size:12px;font-weight:600;color:#111827;">
              Obras potenciales 2N (ALTO / MEDIO)
            </div>
            <div style="font-size:10.5px;color:#6B7280;">
              Distribución por encaje 2N de todos los proyectos del CRM.
            </div>
          </div>
        </div>

        <!-- AQUÍ SOLO CAMBIO: uso la clase donut-encaje-wrapper -->
        <div class="donut-encaje-wrapper">
          <canvas id="chartEncaje"></canvas>
        </div>

        <div style="border-top:1px solid #E5E7EB;padding-top:8px;margin-top:4px;">
          <div style="font-size:12px;font-weight:600;color:#111827;margin-bottom:2px;">
            Tareas pendientes próximos 7 días (por proyecto)
          </div>
          <div style="font-size:10.5px;color:#6B7280;margin-bottom:6px;">
            Acciones planificadas en proyectos con fecha de tarea en la próxima semana.
          </div>
          <div id="tareasList" style="display:flex;flex-direction:column;gap:6px;"></div>
        </div>
      </div>

      <!-- PANEL 3: TAREAS CRM -->
      <div class="card dashboard-panel" draggable="true" data-panel-id="tareas_crm">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
          <div>
            <div style="font-size:12px;font-weight:600;color:#111827;">
              Tareas CRM (próximos 7 días)
            </div>
            <div style="font-size:10.5px;color:#6B7280;">
              Tareas creadas en la sección Tareas, con o sin proyecto asignado.
            </div>
          </div>
          <button
            type="button"
            class="btn-secondary"
            style="padding:4px 8px;font-size:11px;"
            onclick="location.href='tareas.html'">
            Ver todas
          </button>
        </div>
        <div id="tareasListCRM" style="display:flex;flex-direction:column;gap:6px;"></div>
      </div>

      <!-- PANEL 4: NOTAS RÁPIDAS -->
      <div class="card dashboard-panel" draggable="true" data-panel-id="notas_rapidas">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
          <div>
            <div style="font-size:12px;font-weight:600;color:#111827;">
              Notas rápidas
            </div>
            <div style="font-size:10.5px;color:#6B7280;">
              Notas tipo “nota rápida” creadas en la sección Tareas.
            </div>
          </div>
        </div>
        <div id="notasListCRM" style="display:flex;flex-direction:column;gap:6px;"></div>
      </div>

    </div>
  </main>

  <!-- DIALOGO EDICIÓN SEGUIMIENTO / TAREA -->
  <dialog id="seguimientoDialog">
    <div class="modal-header">Editar seguimiento / tarea</div>
    <form id="seguimientoForm" method="dialog">
      <input type="hidden" id="segProjId" />

      <div class="form-group">
        <label style="font-size:12px;font-weight:600;color:#111827;">Proyecto</label>
        <div id="segNombreObra" style="font-size:12px;color:#374151;padding:6px 8px;border-radius:6px;background:#F9FAFB;border:1px solid #E5E7EB;"></div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label for="segFecha" style="font-size:11.5px;font-weight:600;color:#111827;">Fecha seguimiento</label>
          <input id="segFecha" type="date" />
        </div>
        <div class="form-group">
          <label for="tareaFecha" style="font-size:11.5px;font-weight:600;color:#111827;">Fecha tarea</label>
          <input id="tareaFecha" type="date" />
        </div>
      </div>

      <div class="form-group">
        <label for="segComentario" style="font-size:11.5px;font-weight:600;color:#111827;">Comentario seguimiento</label>
        <textarea id="segComentario" rows="3"></textarea>
      </div>

      <div class="form-group">
        <label for="tareaComentario" style="font-size:11.5px;font-weight:600;color:#111827;">Descripción tarea</label>
        <textarea id="tareaComentario" rows="3"></textarea>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="window.closeSegDialog()">Cancelar</button>
        <button type="submit" class="btn-primary">Guardar</button>
      </div>
    </form>
  </dialog>

  <script type="module">
    import { db } from "./firebase.js";
    import {
      collection,
      getDocs,
      updateDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    let proyectos = [];
    let tareas = [];
    let chartEncaje = null;

    const kpiTotal = document.getElementById("kpiTotal");
    const kpiEnCurso = document.getElementById("kpiEnCurso");
    const kpiGanados = document.getElementById("kpiGanados");
    const kpiPerdidos = document.getElementById("kpiPerdidos");

    const seguimientosList = document.getElementById("seguimientosList");
    const tareasList = document.getElementById("tareasList");

    const tareasListCRM = document.getElementById("tareasListCRM");
    const notasListCRM = document.getElementById("notasListCRM");

    const segDialog = document.getElementById("seguimientoDialog");
    const segForm = document.getElementById("seguimientoForm");

    const segProjId = document.getElementById("segProjId");
    const segNombreObra = document.getElementById("segNombreObra");
    const segFecha = document.getElementById("segFecha");
    const tareaFecha = document.getElementById("tareaFecha");
    const segComentario = document.getElementById("segComentario");
    const tareaComentario = document.getElementById("tareaComentario");

    async function cargarDashboard() {
      const [snapProyectos, snapTareas] = await Promise.all([
        getDocs(collection(db, "proyectos")),
        getDocs(collection(db, "tareas"))
      ]);

      proyectos = [];
      snapProyectos.forEach(d => proyectos.push({ id: d.id, ...d.data() }));

      tareas = [];
      snapTareas.forEach(d => tareas.push({ id: d.id, ...d.data() }));

      renderKpis();
      renderEncajeChart();
      renderSeguimientos();
      renderTareas();
      renderTareasCRM();
      renderNotasCRM();
    }

    function renderKpis() {
      const total = proyectos.length;
      const ganados = proyectos.filter(p => p.estado === "Ganado").length;
      const perdidos = proyectos.filter(p => p.estado === "Perdido").length;
      const enCurso = proyectos.filter(p =>
        p.estado &&
        !["Ganado", "Perdido"].includes(p.estado)
      ).length;

      kpiTotal.textContent = total;
      kpiGanados.textContent = ganados;
      kpiPerdidos.textContent = perdidos;
      kpiEnCurso.textContent = enCurso;
    }

    function renderEncajeChart() {
      const counts = { ALTO: 0, MEDIO: 0, BAJO: 0, SIN: 0 };

      proyectos.forEach(p => {
        const enc = (p.encaje_2n || "").toString().toUpperCase().trim();
        if (enc === "ALTO") counts.ALTO++;
        else if (enc === "MEDIO") counts.MEDIO++;
        else if (enc === "BAJO") counts.BAJO++;
        else counts.SIN++;
      });

      const data = [counts.ALTO, counts.MEDIO, counts.BAJO, counts.SIN];
      const total = data.reduce((a, b) => a + b, 0);

      const ctx = document.getElementById("chartEncaje").getContext("2d");
      if (chartEncaje) chartEncaje.destroy();

      Chart.register(window.ChartDataLabels);

      chartEncaje = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["ALTO", "MEDIO", "BAJO", "SIN"],
          datasets: [
            {
              data,
              backgroundColor: ["#16A34A", "#FACC15", "#F97316", "#E5E7EB"],
              borderColor: "#FFFFFF",
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,  // <-- añadido para que se adapte al contenedor
          plugins: {
            legend: {
              position: "bottom",
              labels: { font: { size: 11 } }
            },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const val = ctx.raw || 0;
                  const pct = total ? Math.round((val * 100) / total) : 0;
                  return `${ctx.label}: ${val} (${pct}%)`;
                }
              }
            },
            datalabels: {
              formatter: (value) => {
                if (!total || !value) return "";
                const pct = Math.round((value * 100) / total);
                return pct ? pct + "%" : "";
              },
              color: "#111827",
              font: { weight: "700", size: 11 }
            }
          },
          cutout: "55%"
        }
      });
    }

    function renderSeguimientos() {
      seguimientosList.innerHTML = "";

      const hoy = new Date();
      hoy.setHours(0, 0, 0, 0);
      const limite = new Date(hoy);
      limite.setDate(limite.getDate() + 7);
      limite.setHours(23, 59, 59, 999);

      const proximos = proyectos
        .filter(p => p.seguimiento_fecha)
        .map(p => {
          const d = new Date(p.seguimiento_fecha);
          if (isNaN(d.getTime())) return null;
          d.setHours(0, 0, 0, 0);
          return { ...p, _segDate: d };
        })
        .filter(p => p && p._segDate >= hoy && p._segDate <= limite)
        .sort((a, b) => a._segDate - b._segDate)
        .slice(0, 20);

      if (!proximos.length) {
        const empty = document.createElement("div");
        empty.className = "empty-state";
        empty.textContent = "No hay seguimientos en los próximos 7 días.";
        seguimientosList.appendChild(empty);
        return;
      }

      proximos.forEach(p => {
        const fechaStr = p._segDate.toLocaleDateString("es-ES", {
          day: "2-digit",
          month: "2-digit"
        });

        const item = document.createElement("div");
        item.style.border = "1px solid #E5E7EB";
        item.style.borderRadius = "8px";
        item.style.padding = "6px 8px";
        item.style.background = "#F9FAFB";

        item.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <button class="link-like" data-id="${p.id}"
              style="border:none;background:none;padding:0;margin:0;text-align:left;cursor:pointer;display:flex;flex-direction:column;gap:2px;">
              <span style="font-size:11px;color:#6B7280;">${fechaStr}</span>
              <span style="font-size:12px;font-weight:600;color:#111827;">${p.nombre_obra || ""}</span>
            </button>
            <div style="font-size:10.5px;color:#6B7280;white-space:nowrap;">
              ${p.estado || ""}
            </div>
          </div>
          <div style="font-size:11px;color:#4B5563;margin-top:4px;">
            ${(p.seguimiento_comentario || "").slice(0, 140) || "Sin comentario de seguimiento."}
          </div>
        `;

        seguimientosList.appendChild(item);
      });

      seguimientosList.querySelectorAll("button.link-like").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          openSegDialog(id);
        });
      });
    }

    function renderTareas() {
      tareasList.innerHTML = "";

      const hoy = new Date();
      hoy.setHours(0, 0, 0, 0);
      const limite = new Date(hoy);
      limite.setDate(limite.getDate() + 7);
      limite.setHours(23, 59, 59, 999);

      const proximasTareas = proyectos
        .filter(p => p.tarea_fecha)
        .map(p => {
          const d = new Date(p.tarea_fecha);
          if (isNaN(d.getTime())) return null;
          d.setHours(0, 0, 0, 0);
          return { ...p, _tareaDate: d };
        })
        .filter(p => p && p._tareaDate >= hoy && p._tareaDate <= limite)
        .sort((a, b) => a._tareaDate - b._tareaDate)
        .slice(0, 20);

      if (!proximasTareas.length) {
        const empty = document.createElement("div");
        empty.className = "empty-state";
        empty.textContent = "No hay tareas pendientes en los próximos 7 días.";
        tareasList.appendChild(empty);
        return;
      }

      proximasTareas.forEach(p => {
        const fechaStr = p._tareaDate.toLocaleDateString("es-ES", {
          day: "2-digit",
          month: "2-digit"
        });

        const item = document.createElement("div");
        item.style.border = "1px solid #E5E7EB";
        item.style.borderRadius = "8px";
        item.style.padding = "6px 8px";
        item.style.background = "#F9FAFB";

        item.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <button class="link-like-tarea" data-id="${p.id}"
              style="border:none;background:none;padding:0;margin:0;text-align:left;cursor:pointer;display:flex;flex-direction:column;gap:2px;">
              <span style="font-size:11px;color:#6B7280;">${fechaStr}</span>
              <span style="font-size:12px;font-weight:600;color:#111827;">${p.nombre_obra || ""}</span>
            </button>
            <div style="font-size:10.5px;color:#6B7280;white-space:nowrap;">
              ${p.estado || ""}
            </div>
          </div>
          <div style="font-size:11px;color:#4B5563;margin-top:4px;">
            ${(p.tarea_comentario || "").slice(0, 140) || "Sin descripción de tarea."}
          </div>
        `;

        tareasList.appendChild(item);
      });

      tareasList.querySelectorAll("button.link-like-tarea").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          openSegDialog(id);
        });
      });
    }

    function renderTareasCRM() {
      tareasListCRM.innerHTML = "";

      const hoy = new Date();
      hoy.setHours(0, 0, 0, 0);
      const limite = new Date(hoy);
      limite.setDate(limite.getDate() + 7);
      limite.setHours(23, 59, 59, 999);

      const proximas = tareas
        .filter(t => t.fecha)
        .map(t => {
          const d = new Date(t.fecha);
          if (isNaN(d.getTime())) return null;
          d.setHours(0, 0, 0, 0);
          return { ...t, _date: d };
        })
        .filter(t => t && t._date >= hoy && t._date <= limite)
        .sort((a, b) => a._date - b._date)
        .slice(0, 10);

      if (!proximas.length) {
        const empty = document.createElement("div");
        empty.className = "empty-state";
        empty.textContent = "No hay tareas CRM en los próximos 7 días.";
        tareasListCRM.appendChild(empty);
        return;
      }

      proximas.forEach(t => {
        const fechaStr = t._date.toLocaleDateString("es-ES", {
          day: "2-digit",
          month: "2-digit"
        });

        const proyectoNombre =
          proyectos.find(p => p.id === t.proyecto_id)?.nombre_obra ||
          "Sin proyecto";

        const badgeColor =
          t.prioridad === "alta"
            ? "background:#FEE2E2;color:#B91C1C;"
            : t.prioridad === "baja"
            ? "background:#E0F2FE;color:#0369A1;"
            : "background:#E5E7EB;color:#374151;";

        const item = document.createElement("div");
        item.style.border = "1px solid #E5E7EB";
        item.style.borderRadius = "8px";
        item.style.padding = "6px 8px";
        item.style.background = "#F9FAFB";

        item.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div style="display:flex;flex-direction:column;gap:2px;">
              <span style="font-size:11px;color:#6B7280;">${fechaStr}</span>
              <span style="font-size:12px;font-weight:600;color:#111827;">
                ${t.titulo || "Sin título"}
              </span>
              <span style="font-size:11px;color:#6B7280;">
                ${proyectoNombre}
              </span>
            </div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
              <span style="font-size:10px;padding:2px 6px;border-radius:999px;${badgeColor}">
                ${(t.prioridad || "").toUpperCase()}
              </span>
              <span style="font-size:10px;color:#6B7280;">
                ${t.tipo || ""}
              </span>
            </div>
          </div>
          <div style="font-size:11px;color:#4B5563;margin-top:4px;">
            ${(t.descripcion || "").slice(0, 140)}
          </div>
        `;

        tareasListCRM.appendChild(item);
      });
    }

    function renderNotasCRM() {
      notasListCRM.innerHTML = "";

      const notas = tareas
        .filter(t => t.tipo === "nota")
        .sort((a, b) => (b.fecha || "").localeCompare(a.fecha || ""))
        .slice(0, 15);

      if (!notas.length) {
        const empty = document.createElement("div");
        empty.className = "empty-state";
        empty.textContent = "Sin notas rápidas.";
        notasListCRM.appendChild(empty);
        return;
      }

      notas.forEach(n => {
        const proyectoNombre =
          proyectos.find(p => p.id === n.proyecto_id)?.nombre_obra ||
          "Sin proyecto";

        const item = document.createElement("div");
        item.style.border = "1px solid #E5E7EB";
        item.style.borderRadius = "8px";
        item.style.padding = "6px 8px";
        item.style.background = "#F9FAFB";

        item.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div style="display:flex;flex-direction:column;gap:2px;">
              <span style="font-size:11px;color:#6B7280;">
                ${n.fecha || ""}
              </span>
              <span style="font-size:12px;font-weight:600;color:#111827;">
                ${n.titulo || "Nota rápida"}
              </span>
              <span style="font-size:11px;color:#6B7280;">
                ${proyectoNombre}
              </span>
            </div>
          </div>
          <div style="font-size:11px;color:#4B5563;margin-top:4px;">
            ${(n.descripcion || "").slice(0, 160)}
          </div>
        `;

        notasListCRM.appendChild(item);
      });
    }

    function openSegDialog(id) {
      const p = proyectos.find(x => x.id === id);
      if (!p) return;

      segProjId.value = p.id;
      segNombreObra.textContent = p.nombre_obra || "";
      segFecha.value = p.seguimiento_fecha || "";
      tareaFecha.value = p.tarea_fecha || "";
      segComentario.value = p.seguimiento_comentario || "";
      tareaComentario.value = p.tarea_comentario || "";

      segDialog.showModal();
    }

    window.closeSegDialog = function () {
      segDialog.close();
    };

    segForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = segProjId.value;
      if (!id) {
        segDialog.close();
        return;
      }

      const payload = {
        seguimiento_fecha: segFecha.value || null,
        seguimiento_comentario: segComentario.value.trim(),
        tarea_fecha: tareaFecha.value || null,
        tarea_comentario: tareaComentario.value.trim()
      };

      try {
        await updateDoc(doc(db, "proyectos", id), payload);
        segDialog.close();
        await cargarDashboard();
      } catch (err) {
        console.error("❌ Error guardando seguimiento:", err);
        alert("Error guardando el seguimiento/tarea.");
      }
    });

    /* ==== DRAG & DROP DE PANELES DEL DASHBOARD ==== */

    const panelsContainer = document.getElementById("dashboardPanels");
    const ORDER_KEY = "crm2n_dashboard_order";

    function getDefaultPanelOrder() {
      return ["seguimientos", "encaje_tareas", "tareas_crm", "notas_rapidas"];
    }

    function loadPanelOrder() {
      try {
        const stored = localStorage.getItem(ORDER_KEY);
        if (!stored) return getDefaultPanelOrder();
        const arr = JSON.parse(stored);
        if (!Array.isArray(arr) || !arr.length) return getDefaultPanelOrder();
        return arr;
      } catch {
        return getDefaultPanelOrder();
      }
    }

    function savePanelOrder() {
      const ids = Array.from(
        panelsContainer.querySelectorAll(".dashboard-panel")
      ).map(p => p.dataset.panelId);
      localStorage.setItem(ORDER_KEY, JSON.stringify(ids));
    }

    function applyPanelOrder() {
      const order = loadPanelOrder();
      const map = {};
      const panels = Array.from(
        panelsContainer.querySelectorAll(".dashboard-panel")
      );
      panels.forEach(p => {
        map[p.dataset.panelId] = p;
      });

      order.forEach(id => {
        if (map[id]) panelsContainer.appendChild(map[id]);
      });

      // por si hay paneles nuevos no contemplados en el orden
      panels.forEach(p => {
        if (!order.includes(p.dataset.panelId)) {
          panelsContainer.appendChild(p);
        }
      });
    }

    function initPanelDragAndDrop() {
      let draggedPanel = null;

      panelsContainer.querySelectorAll(".dashboard-panel").forEach(panel => {
        panel.addEventListener("dragstart", (e) => {
          draggedPanel = panel;
          panel.classList.add("dragging");
          e.dataTransfer.effectAllowed = "move";
        });

        panel.addEventListener("dragend", () => {
          if (draggedPanel) {
            draggedPanel.classList.remove("dragging");
            draggedPanel = null;
            panelsContainer
              .querySelectorAll(".dashboard-panel")
              .forEach(p => p.classList.remove("drop-target"));
            savePanelOrder();
          }
        });

        panel.addEventListener("dragover", (e) => {
          e.preventDefault();
          if (!draggedPanel || draggedPanel === panel) return;
          panel.classList.add("drop-target");
        });

        panel.addEventListener("dragleave", () => {
          panel.classList.remove("drop-target");
        });

        panel.addEventListener("drop", (e) => {
          e.preventDefault();
          panel.classList.remove("drop-target");
          if (!draggedPanel || draggedPanel === panel) return;

          const panels = Array.from(
            panelsContainer.querySelectorAll(".dashboard-panel")
          );
          const draggedIndex = panels.indexOf(draggedPanel);
          const targetIndex = panels.indexOf(panel);

          if (draggedIndex < 0 || targetIndex < 0) return;

          if (draggedIndex < targetIndex) {
            panelsContainer.insertBefore(draggedPanel, panel.nextSibling);
          } else {
            panelsContainer.insertBefore(draggedPanel, panel);
          }

          savePanelOrder();
        });
      });
    }

    applyPanelOrder();
    initPanelDragAndDrop();
    cargarDashboard();
  </script>

  <!-- Guardia de autenticación (login / logout) -->
  <script type="module" src="auth.js"></script>
</body>
</html>
