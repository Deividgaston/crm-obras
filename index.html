<!--
CRM 2N – Modo Desarrollador Eficiente
Estilo Salesforce Moderno + Apple Clean UI
Firebase optimizado (mínimas lecturas, funciones reutilizables)
-->

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CRM 2N – Dashboard</title>

    <link rel="stylesheet" href="style.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <!-- NAV SUPERIOR -->
    <div class="topnav">
        <div class="logo">CRM 2N</div>

        <div class="nav-tabs">
            <div class="nav-item active" onclick="location.href='index.html'">Dashboard</div>
            <div class="nav-item" onclick="location.href='proyectos.html'">Proyectos</div>
            <div class="nav-item" onclick="location.href='pipeline.html'">Pipeline</div>
            <div class="nav-item" onclick="location.href='clientes.html'">Clientes</div>
            <div class="nav-item" onclick="location.href='tareas.html'">Tareas</div>
            <div class="nav-item" onclick="location.href='reportes.html'">Reportes</div>
        </div>

        <input type="text" class="search-box" placeholder="Buscar..." />
    </div>

    <main class="content">

        <!-- TOP CARDS -->
        <div class="cards-grid">
            <div class="card">
                <div class="card-title">Proyectos totales</div>
                <div id="cardProyectos" class="card-value">–</div>
                <a class="card-link" onclick="location.href='proyectos.html'">Ver proyectos →</a>
            </div>

            <div class="card">
                <div class="card-title">Obras Potenciales</div>
                <div id="cardPotenciales" class="card-value">–</div>
                <a class="card-link" onclick="location.href='pipeline.html'">Ver pipeline →</a>
            </div>

            <div class="card">
                <div class="card-title">Tareas pendientes</div>
                <div id="cardTareas" class="card-value">–</div>
                <a class="card-link" onclick="location.href='tareas.html'">Ver tareas →</a>
            </div>
        </div>

        <!-- TAREAS / SEGUIMIENTOS -->
        <div class="columns">
            <div class="panel">
                <div class="panel-title">Tareas pendientes</div>
                <div id="listaTareas"></div>
            </div>

            <div class="panel">
                <div class="panel-title">Acciones de seguimiento</div>
                <div id="listaSeguimientos"></div>
            </div>
        </div>

        <!-- GRÁFICOS -->
        <div class="columns" style="margin-top: 30px;">
            <div class="panel">
                <div class="panel-title">Tipos de Obra</div>
                <canvas id="graficoTipos"></canvas>
            </div>

            <div class="panel">
                <div class="panel-title">Obras Potenciales</div>
                <canvas id="graficoPotenciales"></canvas>
            </div>
        </div>
    </main>

    <script type="module">
        import { db } from "./firebase.js";
        import {
            collection,
            getDocs
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const cardProyectos = document.getElementById("cardProyectos");
        const cardPotenciales = document.getElementById("cardPotenciales");
        const cardTareas = document.getElementById("cardTareas");
        const listaTareas = document.getElementById("listaTareas");
        const listaSeguimientos = document.getElementById("listaSeguimientos");

        async function cargarDashboard() {
            const ref = collection(db, "proyectos");
            const snap = await getDocs(ref);

            let proyectos = [];
            let tareas = [];
            let seguimientos = [];
            let tiposObra = {};
            let obrasPotenciales = 0;

            snap.forEach(doc => {
                const p = doc.data();
                proyectos.push(p);

                if (p.tareas) tareas.push(...p.tareas);
                if (p.seguimientos) seguimientos.push(...p.seguimientos);

                if (p.tipoObra) {
                    tiposObra[p.tipoObra] = (tiposObra[p.tipoObra] || 0) + 1;
                }

                if (p.potencial === true) {
                    obrasPotenciales++;
                }
            });

            cardProyectos.textContent = proyectos.length;
            cardPotenciales.textContent = obrasPotenciales;
            cardTareas.textContent = tareas.length;

            listaTareas.innerHTML = tareas.length
                ? tareas.map(t => `<div class="task-item">${t}</div>`).join("")
                : `<div style="opacity:0.6;">No hay tareas pendientes</div>`;

            listaSeguimientos.innerHTML = seguimientos.length
                ? seguimientos.map(s => `<div class="follow-item">${s}</div>`).join("")
                : `<div style="opacity:0.6;">Sin seguimientos pendientes</div>`;

            new Chart(document.getElementById("graficoTipos"), {
                type: "doughnut",
                data: {
                    labels: Object.keys(tiposObra),
                    datasets: [{
                        data: Object.values(tiposObra)
                    }]
                }
            });

            new Chart(document.getElementById("graficoPotenciales"), {
                type: "bar",
                data: {
                    labels: ["Obras Potenciales"],
                    datasets: [{
                        label: "Total",
                        data: [obrasPotenciales]
                    }]
                }
            });
        }

        cargarDashboard();
    </script>

</body>
</html>
