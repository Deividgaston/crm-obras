<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM 2N – Tareas</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="topnav">
    <div class="logo">CRM 2N</div>

    <div class="nav-tabs">
      <div class="nav-item" onclick="location.href='index.html'">Dashboard</div>
      <div class="nav-item" onclick="location.href='proyectos.html'">Proyectos</div>
      <div class="nav-item" onclick="location.href='buscar.html'">Buscar</div>
      <div class="nav-item" onclick="location.href='pipeline.html'">Pipeline</div>
      <div class="nav-item" onclick="location.href='clientes.html'">Clientes</div>
      <div class="nav-item active" onclick="location.href='tareas.html'">Tareas</div>
      <div class="nav-item" onclick="location.href='reportes.html'">Reportes</div>
    </div>

    <button id="btnLogout" class="btn-logout">Cerrar sesión</button>
  </div>

  <main class="content">
    <h2>Tareas y Notas rápidas</h2>

    <div style="display:flex; gap:10px; margin-bottom:15px;">
      <button id="btnNuevaTarea" class="btn-primary">Nueva tarea</button>
      <button id="btnNuevaNota" class="btn-secondary">Nueva nota</button>
    </div>

    <!-- Kanban -->
    <div class="kanban-grid">
      <div class="kanban-column">
        <h3>Pendiente</h3>
        <div id="pendiente"></div>
      </div>
      <div class="kanban-column">
        <h3>En progreso</h3>
        <div id="progreso"></div>
      </div>
      <div class="kanban-column">
        <h3>Hecho</h3>
        <div id="hecho"></div>
      </div>
    </div>
  </main>

  <!-- Modal -->
  <dialog id="tareaDialog">
    <form id="tareaForm" method="dialog" class="modal">
      <h3 id="tareaTituloModal">Nueva tarea</h3>

      <input type="hidden" id="tareaId" />

      <label>Título</label>
      <input type="text" id="tareaTitulo" required />

      <label>Descripción</label>
      <textarea id="tareaDescripcion"></textarea>

      <label>Fecha límite</label>
      <input type="date" id="tareaFecha" />

      <label>Prioridad</label>
      <select id="tareaPrioridad">
        <option value="alta">Alta</option>
        <option value="media" selected>Media</option>
        <option value="baja">Baja</option>
      </select>

      <label>Estado</label>
      <select id="tareaEstado">
        <option value="pendiente">Pendiente</option>
        <option value="progreso">En progreso</option>
        <option value="hecho">Hecho</option>
      </select>

      <div style="display:flex; justify-content:space-between; margin-top:15px;">
        <button type="button" id="btnEliminarTarea" class="btn-danger">Borrar</button>
        <button type="submit" class="btn-primary">Guardar</button>
      </div>

      <button id="btnCerrarModal" type="button" class="btn-secondary" style="margin-top:8px;">
        Cerrar
      </button>
    </form>
  </dialog>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import {
      collection,
      getDocs,
      addDoc,
      updateDoc,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { onAuthStateChanged }
      from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const colPend = document.getElementById("pendiente");
    const colProg = document.getElementById("progreso");
    const colDone = document.getElementById("hecho");

    const tareaDialog = document.getElementById("tareaDialog");
    const tareaForm = document.getElementById("tareaForm");

    const tareaId = document.getElementById("tareaId");
    const tareaTitulo = document.getElementById("tareaTitulo");
    const tareaDescripcion = document.getElementById("tareaDescripcion");
    const tareaFecha = document.getElementById("tareaFecha");
    const tareaPrioridad = document.getElementById("tareaPrioridad");
    const tareaEstado = document.getElementById("tareaEstado");

    const btnNuevaTarea = document.getElementById("btnNuevaTarea");
    const btnNuevaNota = document.getElementById("btnNuevaNota");
    const btnEliminarTarea = document.getElementById("btnEliminarTarea");

    const tareasColl = collection(db, "tareas");

    let tareas = [];

    async function cargarTareas() {
      const snap = await getDocs(tareasColl);
      tareas = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderKanban();
    }

    function renderKanban() {
      colPend.innerHTML = "";
      colProg.innerHTML = "";
      colDone.innerHTML = "";

      tareas.forEach(t => {
        const div = document.createElement("div");
        div.className = "kanban-item";
        div.innerHTML = `<b>${t.titulo}</b><p>${t.descripcion || ""}</p>`;
        div.onclick = () => abrirEditar(t);

        if (t.estado === "pendiente") colPend.appendChild(div);
        else if (t.estado === "progreso") colProg.appendChild(div);
        else colDone.appendChild(div);
      });
    }

    function abrirEditar(t) {
      tareaId.value = t.id;
      tareaTitulo.value = t.titulo;
      tareaDescripcion.value = t.descripcion || "";
      tareaFecha.value = t.fecha || "";
      tareaPrioridad.value = t.prioridad || "media";
      tareaEstado.value = t.estado || "pendiente";

      btnEliminarTarea.style.display = "inline-block";
      tareaDialog.showModal();
    }

    btnNuevaTarea.onclick = () => {
      tareaId.value = "";
      tareaTitulo.value = "";
      tareaDescripcion.value = "";
      tareaFecha.value = "";
      tareaPrioridad.value = "media";
      tareaEstado.value = "pendiente";
      btnEliminarTarea.style.display = "none";

      tareaDialog.showModal();
    };

    btnNuevaNota.onclick = () => {
      tareaId.value = "";
      tareaTitulo.value = "Nota rápida";
      tareaDescripcion.value = "";
      tareaFecha.value = "";
      tareaPrioridad.value = "baja";
      tareaEstado.value = "pendiente";
      btnEliminarTarea.style.display = "none";

      tareaDialog.showModal();
    };

    /* ============================================================
       FIX: mantener ownerId SIEMPRE (antes se borraba en update)
    ============================================================ */
    tareaForm.onsubmit = async (e) => {
      e.preventDefault();

      const id = tareaId.value;

      const payload = {
        titulo: tareaTitulo.value.trim(),
        descripcion: tareaDescripcion.value.trim(),
        fecha: tareaFecha.value || "",
        prioridad: tareaPrioridad.value,
        estado: tareaEstado.value,
      };

      try {
        if (id) {
          await updateDoc(doc(db, "tareas", id), {
            ...payload,
            ownerId: auth.currentUser ? auth.currentUser.uid : ""
          });
        } else {
          const ownerId = auth.currentUser ? auth.currentUser.uid : "";
          await addDoc(tareasColl, { ...payload, ownerId });
        }

        await cargarTareas();
        tareaDialog.close();
      } catch (err) {
        alert("Error guardando tarea: " + err.message);
      }
    };

    btnEliminarTarea.onclick = async () => {
      const id = tareaId.value;
      if (!id) return;

      if (!confirm("¿Seguro que deseas borrar esta tarea?")) return;

      try {
        await deleteDoc(doc(db, "tareas", id));
        await cargarTareas();
        tareaDialog.close();
      } catch (err) {
        alert("Error borrando: " + err.message);
      }
    };

    onAuthStateChanged(auth, (user) => {
      if (!user) location.href = "login.html";
      else cargarTareas();
    });
  </script>

  <script type="module" src="auth.js"></script>
</body>
</html>
