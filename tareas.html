<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tareas · CRM 2N</title>
  <link rel="stylesheet" href="style.css" />

  <!-- CSS SOLO PARA ESTA PÁGINA -->
  <style>
    .kanban-column-body {
      min-height: 260px;
      padding: 6px;
      border-radius: 12px;
      transition: 0.2s;
    }
    .kanban-column-body:hover {
      background: #F8FAFC;
    }

    .pipeline-card {
      background: white;
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 8px;
      border: 1px solid #E5E7EB;
      cursor: grab;
      transition: 0.15s;
    }

    .pipeline-card:hover {
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      transform: translateY(-1px);
    }

    .pipeline-card:active {
      cursor: grabbing;
    }

    .project-card {
      background: white;
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 8px;
      border: 1px solid #D1D5DB;
      cursor: pointer;
      transition: 0.15s;
    }

    .project-card:hover {
      background: #EEF2FF;
      border-color: #4C6EF5;
    }

    .active-project {
      background: #E0E7FF !important;
      border-color: #4C6EF5 !important;
    }
  </style>
</head>

<body>
  <div class="topnav">
    <div class="logo">CRM 2N</div>

    <div class="nav-tabs">
      <div class="nav-item" onclick="location.href='index.html'">Dashboard</div>
      <div class="nav-item" onclick="location.href='proyectos.html'">Proyectos</div>
      <div class="nav-item" onclick="location.href='buscar.html'">Buscar</div>
      <div class="nav-item" onclick="location.href='pipeline.html'">Pipeline</div>
      <div class="nav-item" onclick="location.href='clientes.html'">Clientes</div>
      <div class="nav-item active" onclick="location.href='tareas.html'">Tareas</div>
      <div class="nav-item" onclick="location.href='reportes.html'">Reportes</div>
    </div>

    <input type="text" class="search-box" id="buscadorTareas" placeholder="Buscar tarea..." />
  </div>

  <main class="content">

    <h2 style="margin-top:0;margin-bottom:4px;color:#16325C;">Tareas · Seguimiento</h2>

    <div class="columns" style="grid-template-columns: 1.1fr 2.2fr 0.9fr; align-items:flex-start; gap:20px;">

      <!-- ==============================
           KANBAN DE PROYECTOS
      =============================== -->
      <aside class="panel">
        <div class="panel-title">Proyectos</div>
        <div id="projectKanban"></div>
      </aside>

      <!-- ==============================
           KANBAN DE TAREAS
      =============================== -->
      <section class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <div>
            <div class="panel-title">Tareas</div>
          </div>

          <button class="btn-primary" id="btnNuevaTarea">+ Nueva tarea</button>
        </div>

        <div class="pipeline-board" id="kanbanBoard">

          <div class="pipeline-column" data-estado="pendiente">
            <div class="pipeline-column-header">
              <span class="pipeline-column-title">Pendiente</span>
              <span class="pipeline-column-count" id="countPendiente">0</span>
            </div>
            <div class="kanban-column-body" data-estado="pendiente"></div>
          </div>

          <div class="pipeline-column" data-estado="proceso">
            <div class="pipeline-column-header">
              <span class="pipeline-column-title">En proceso</span>
              <span class="pipeline-column-count" id="countProceso">0</span>
            </div>
            <div class="kanban-column-body" data-estado="proceso"></div>
          </div>

          <div class="pipeline-column" data-estado="hecho">
            <div class="pipeline-column-header">
              <span class="pipeline-column-title">Hecho</span>
              <span class="pipeline-column-count" id="countHecho">0</span>
            </div>
            <div class="kanban-column-body" data-estado="hecho"></div>
          </div>

        </div>
      </section>

      <!-- ==============================
           NOTAS RÁPIDAS
      =============================== -->
      <aside class="panel">
        <div class="panel-title">Notas rápidas</div>

        <div style="display:flex;gap:8px;margin-bottom:10px;">
          <input id="notaRapidaTexto" type="text" class="search-input" placeholder="Escribe una nota..." />
          <button class="btn-primary" id="btnCrearNotaRapida">+</button>
        </div>

        <div id="listaNotasRapidas" class="activity-list"></div>
      </aside>

    </div>
  </main>

  <!-- ==============================
       MODAL CREAR / EDITAR TAREA
  =============================== -->
  <dialog id="tareaDialog">
    <div class="modal-header">Tarea</div>

    <form id="tareaForm" method="dialog">
      <input type="hidden" id="tareaId" />
      <input type="hidden" id="tareaProyectoHidden" />

      <div class="form-grid">

        <div class="form-group">
          <label>Título</label>
          <input id="tareaTitulo" type="text" required />
        </div>

        <div class="form-group">
          <label>Fecha</label>
          <input id="tareaFechaUnica" type="date" />
        </div>

        <div class="form-group">
          <label>Estado</label>
          <select id="tareaEstado">
            <option value="pendiente">Pendiente</option>
            <option value="proceso">En proceso</option>
            <option value="hecho">Hecho</option>
          </select>
        </div>

        <div class="form-group">
          <label>Prioridad</label>
          <select id="tareaPrioridad">
            <option value="media">Media</option>
            <option value="alta">Alta</option>
            <option value="baja">Baja</option>
          </select>
        </div>

        <div class="form-group">
          <label>Tipo</label>
          <select id="tareaTipo">
            <option value="seguimiento">Seguimiento</option>
            <option value="recurrente">Recurrente</option>
            <option value="nota">Nota rápida</option>
          </select>
        </div>

        <div class="form-group">
          <label>
            <input id="tareaRecurrenteChk" type="checkbox" />
            Es recurrente
          </label>
        </div>

        <div class="form-group">
          <label>Repetir cada (días)</label>
          <input id="tareaRecurrenteDias" type="number" min="1" value="7" />
        </div>
      </div>

      <div class="form-group">
        <label>Descripción</label>
        <textarea id="tareaDescripcion" rows="3"></textarea>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" id="btnBorrarTarea" style="margin-right:auto;">Borrar</button>
        <button type="button" class="btn-secondary" onclick="tareaDialog.close()">Cancelar</button>
        <button type="submit" class="btn-primary">Guardar</button>
      </div>
    </form>
  </dialog>

  <!-- ==============================
       SCRIPT
  =============================== -->
  <script type="module">

    import { db } from "./firebase.js";
    import {
      collection,
      getDocs,
      addDoc,
      updateDoc,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    let tareas = [];
    let proyectos = [];
    let proyectoActivo = null;

    const collTareas = collection(db, "tareas");
    const collProyectos = collection(db, "proyectos");

    async function cargarProyectos() {
      const snap = await getDocs(collProyectos);
      proyectos = [];

      snap.forEach(d => {
        const data = d.data();
        proyectos.push({
          id: d.id,
          nombre: data.nombre_display || data.nombre || ""
        });
      });

      renderProyectos();
    }

    function renderProyectos() {
      const cont = document.getElementById("projectKanban");
      cont.innerHTML = "";

      proyectos.forEach(p => {
        const card = document.createElement("div");
        card.className = "project-card";
        card.dataset.id = p.id;
        card.innerHTML = `
          <div style="font-size:14px;font-weight:600;color:#111;">
            ${p.nombre}
          </div>
        `;

        if (proyectoActivo === p.id) card.classList.add("active-project");

        card.onclick = () => {
          proyectoActivo = p.id;
          renderProyectos();
          renderKanban();
        };

        cont.appendChild(card);
      });
    }

    async function cargarTareas() {
      const snap = await getDocs(collTareas);
      tareas = [];
      snap.forEach(d => tareas.push({ id: d.id, ...d.data() }));
      renderKanban();
      renderNotas();
    }

    function renderKanban() {
      const est = { pendiente: [], proceso: [], hecho: [] };

      tareas.forEach(t => {
        if (proyectoActivo && t.proyecto_id !== proyectoActivo) return;
        est[t.estado || "pendiente"].push(t);
      });

      document.getElementById("countPendiente").textContent = est.pendiente.length;
      document.getElementById("countProceso").textContent = est.proceso.length;
      document.getElementById("countHecho").textContent = est.hecho.length;

      ["pendiente","proceso","hecho"].forEach(e=>{
        const cont = document.querySelector(`.kanban-column-body[data-estado="${e}"]`);
        cont.innerHTML = "";
        est[e].forEach(t => cont.appendChild(cardTarea(t)));
      });

      activarDrag();
    }

    function cardTarea(t) {
      const d = document.createElement("div");
      d.className = "pipeline-card";
      d.draggable = true;
      d.dataset.id = t.id;

      const badge =
        t.prioridad === "alta"
          ? "background:#FEE2E2;color:#B91C1C;"
          : t.prioridad === "baja"
          ? "background:#E0F2FE;color:#0369A1;"
          : "background:#E5E7EB;color:#374151;";

      const proyecto = proyectos.find(x => x.id === t.proyecto_id)?.nombre || "";

      d.innerHTML = `
        <div style="display:flex;justify-content:space-between;">
          <button class="link-button" data-id="${t.id}" style="font-weight:600;">
            ${t.titulo}
          </button>
          <span style="font-size:10px;padding:2px 6px;border-radius:999px;${badge}">
            ${t.prioridad.toUpperCase()}
          </span>
        </div>

        <div style="font-size:11px;color:#6B7280;margin-top:3px;">${proyecto}</div>

        <div style="font-size:11px;color:#4B5563;margin-top:4px;">
          ${(t.descripcion || "").slice(0,120)}
        </div>

        <div style="font-size:10px;color:#6B7280;margin-top:6px;display:flex;justify-content:space-between;">
          <span>${t.fecha || ""}</span>
          <span>${t.tipo}</span>
        </div>
      `;

      d.querySelector("button").onclick = () => abrir(t.id);
      return d;
    }

    function activarDrag() {
      const cards = document.querySelectorAll(".pipeline-card");
      const cols = document.querySelectorAll(".kanban-column-body");

      cards.forEach(c => {
        c.addEventListener("dragstart", e => {
          e.dataTransfer.setData("id", c.dataset.id);
        });
      });

      cols.forEach(col => {
        col.addEventListener("dragover", e => e.preventDefault());
        col.addEventListener("drop", e => {
          const id = e.dataTransfer.getData("id");
          mover(id, col.dataset.estado);
        });
      });
    }

    async function mover(id, estado) {
      const ref = doc(db, "tareas", id);
      await updateDoc(ref, { estado });
      cargarTareas();
    }

    /* ==============
       NOTAS RÁPIDAS
    =============== */
    function renderNotas() {
      const cont = document.getElementById("listaNotasRapidas");
      cont.innerHTML = "";

      const notas = tareas.filter(t => t.tipo === "nota");

      notas.forEach(n => {
        const li = document.createElement("div");
        li.className = "activity-item";

        li.innerHTML = `
          <div class="activity-title">${n.titulo}</div>
          <div class="activity-sub">${(n.descripcion || "").slice(0,130)}</div>
          <div class="activity-meta">${n.fecha}</div>
        `;

        li.onclick = () => abrir(n.id);
        cont.appendChild(li);
      });
    }

    document.getElementById("btnCrearNotaRapida").onclick = async () => {
      const texto = document.getElementById("notaRapidaTexto").value.trim();
      if (!texto) return;

      const hoy = new Date().toISOString().slice(0,10);

      await addDoc(collTareas, {
        titulo: texto,
        descripcion: texto,
        fecha: hoy,
        tipo: "nota",
        prioridad: "baja",
        estado: "pendiente",
        proyecto_id: proyectoActivo || null
      });

      document.getElementById("notaRapidaTexto").value = "";
      cargarTareas();
    };

    /* ==============
       MODAL TAREA
    =============== */
    document.getElementById("btnNuevaTarea").onclick = () => abrir(null);

    function abrir(id) {
      if (!proyectoActivo) {
        alert("Selecciona un proyecto en el panel izquierdo.");
        return;
      }

      if (!id) {
        document.getElementById("tareaId").value = "";
        document.getElementById("tareaTitulo").value = "";
        document.getElementById("tareaFechaUnica").value = "";
        document.getElementById("tareaEstado").value = "pendiente";
        document.getElementById("tareaPrioridad").value = "media";
        document.getElementById("tareaTipo").value = "seguimiento";
        document.getElementById("tareaRecurrenteChk").checked = false;
        document.getElementById("tareaDescripcion").value = "";
        document.getElementById("tareaProyectoHidden").value = proyectoActivo;
        document.getElementById("btnBorrarTarea").style.display = "none";
      } else {
        const t = tareas.find(x => x.id === id);

        document.getElementById("tareaId").value = t.id;
        document.getElementById("tareaTitulo").value = t.titulo;
        document.getElementById("tareaFechaUnica").value = t.fecha || "";
        document.getElementById("tareaEstado").value = t.estado;
        document.getElementById("tareaPrioridad").value = t.prioridad;
        document.getElementById("tareaTipo").value = t.tipo;
        document.getElementById("tareaDescripcion").value = t.descripcion || "";
        document.getElementById("tareaRecurrenteChk").checked = !!t.es_recurrente;
        document.getElementById("tareaRecurrenteDias").value = t.recurrente_dias || 7;
        document.getElementById("tareaProyectoHidden").value = t.proyecto_id;

        document.getElementById("btnBorrarTarea").style.display = "inline-block";
      }

      document.getElementById("tareaDialog").showModal();
    }

    document.getElementById("tareaForm").onsubmit = async (e) => {
      e.preventDefault();

      const id = document.getElementById("tareaId").value;
      const payload = {
        titulo: document.getElementById("tareaTitulo").value.trim(),
        fecha: document.getElementById("tareaFechaUnica").value || null,
        estado: document.getElementById("tareaEstado").value,
        prioridad: document.getElementById("tareaPrioridad").value,
        tipo: document.getElementById("tareaTipo").value,
        es_recurrente: document.getElementById("tareaRecurrenteChk").checked,
        recurrente_dias: document.getElementById("tareaRecurrenteChk").checked
          ? Number(document.getElementById("tareaRecurrenteDias").value)
          : null,
        descripcion: document.getElementById("tareaDescripcion").value.trim(),
        proyecto_id: proyectoActivo
      };

      if (id) {
        await updateDoc(doc(db,"tareas",id), payload);
      } else {
        await addDoc(collTareas, payload);
      }

      tareaDialog.close();
      cargarTareas();
    };

    document.getElementById("btnBorrarTarea").onclick = async () => {
      const id = document.getElementById("tareaId").value;
      if (!id) return;
      await deleteDoc(doc(db,"tareas",id));
      tareaDialog.close();
      cargarTareas();
    };

    cargarProyectos();
    cargarTareas();

  </script>

</body>
</html>
