<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tareas · CRM 2N</title>
  <link rel="stylesheet" href="style.css" />

  <!-- ESTILO EXCLUSIVO PARA ESTA PÁGINA (NO TOCA style.css) -->
  <style>
    .kanban-column-body {
      min-height: 260px;
      padding: 6px;
      border-radius: 12px;
      transition: 0.2s;
    }

    .kanban-column-body:hover {
      background: #F8FAFC;
    }

    .pipeline-card {
      background: white;
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 8px;
      border: 1px solid #E5E7EB;
      cursor: grab;
      transition: 0.15s;
    }

    .pipeline-card:hover {
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      transform: translateY(-1px);
    }

    .pipeline-card:active {
      cursor: grabbing;
    }

    .kanban-column-body.drag-over {
      background: #EEF2FF !important;
      border: 1px dashed #4C6EF5;
    }
  </style>
</head>

<body>
  <div class="topnav">
    <div class="logo">CRM 2N</div>

    <div class="nav-tabs">
      <div class="nav-item" onclick="location.href='index.html'">Dashboard</div>
      <div class="nav-item" onclick="location.href='proyectos.html'">Proyectos</div>
      <div class="nav-item" onclick="location.href='buscar.html'">Buscar</div>
      <div class="nav-item" onclick="location.href='pipeline.html'">Pipeline</div>
      <div class="nav-item" onclick="location.href='clientes.html'">Clientes</div>
      <div class="nav-item active" onclick="location.href='tareas.html'">Tareas</div>
      <div class="nav-item" onclick="location.href='reportes.html'">Reportes</div>
    </div>

    <input type="text" class="search-box" id="buscadorTareas" placeholder="Buscar tarea o proyecto..." />
  </div>

  <main class="content">

    <h2 style="margin-top:0;margin-bottom:4px;color:#16325C;">Tareas y seguimientos</h2>

    <div class="kpi-row" style="margin-bottom:14px;">
      <div class="kpi-card">
        <div class="kpi-label">Tareas totales</div>
        <div id="kpiTareasTotal" class="kpi-value">–</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Para hoy</div>
        <div id="kpiTareasHoy" class="kpi-value">–</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Urgentes</div>
        <div id="kpiTareasUrgentes" class="kpi-value">–</div>
      </div>
    </div>

    <div class="columns" style="align-items:flex-start;">

      <section class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <div>
            <div class="panel-title">Kanban tareas</div>
            <div class="panel-subtitle">Organiza seguimientos, recurrentes y notas rápidas.</div>
          </div>

          <div style="display:flex;gap:8px;">
            <select id="filtroTipo" class="select-input" style="max-width:140px;">
              <option value="">Tipo: todos</option>
              <option value="seguimiento">Seguimiento</option>
              <option value="recurrente">Recurrente</option>
              <option value="nota">Nota rápida</option>
            </select>

            <button class="btn-primary" id="btnNuevaTarea">+ Nueva tarea</button>
          </div>
        </div>

        <div class="pipeline-board" id="kanbanBoard">

          <div class="pipeline-column" data-estado="pendiente">
            <div class="pipeline-column-header">
              <span class="pipeline-column-title">Pendiente</span>
              <span class="pipeline-column-count" id="countPendiente">0</span>
            </div>
            <div class="kanban-column-body" data-estado="pendiente"></div>
          </div>

          <div class="pipeline-column" data-estado="proceso">
            <div class="pipeline-column-header">
              <span class="pipeline-column-title">En proceso</span>
              <span class="pipeline-column-count" id="countProceso">0</span>
            </div>
            <div class="kanban-column-body" data-estado="proceso"></div>
          </div>

          <div class="pipeline-column" data-estado="hecho">
            <div class="pipeline-column-header">
              <span class="pipeline-column-title">Hecho</span>
              <span class="pipeline-column-count" id="countHecho">0</span>
            </div>
            <div class="kanban-column-body" data-estado="hecho"></div>
          </div>

        </div>
      </section>

      <aside class="panel">
        <div class="panel-title">Notas rápidas</div>
        <div class="panel-subtitle">Ideas y recordatorios inmediatos.</div>

        <div style="display:flex;gap:8px;margin-bottom:10px;">
          <input id="notaRapidaTexto" type="text" class="search-input" placeholder="Escribe una nota..." />
          <button class="btn-primary" id="btnCrearNotaRapida">+</button>
        </div>

        <div id="listaNotasRapidas" class="activity-list"></div>
      </aside>

    </div>
  </main>

  <dialog id="tareaDialog">
    <div class="modal-header">Tarea</div>

    <form id="tareaForm" method="dialog">
      <input type="hidden" id="tareaId" />

      <div class="form-grid">
        <div class="form-group">
          <label>Título</label>
          <input id="tareaTitulo" type="text" required />
        </div>

        <div class="form-group">
          <label>Proyecto</label>
          <input id="tareaProyecto" type="text" list="listaProyectos" placeholder="Escribe o selecciona..." />
          <datalist id="listaProyectos"></datalist>
        </div>

        <div class="form-group">
          <label>Fecha</label>
          <input id="tareaFechaUnica" type="date" />
        </div>

        <div class="form-group">
          <label>Estado</label>
          <select id="tareaEstado">
            <option value="pendiente">Pendiente</option>
            <option value="proceso">En proceso</option>
            <option value="hecho">Hecho</option>
          </select>
        </div>

        <div class="form-group">
          <label>Prioridad</label>
          <select id="tareaPrioridad">
            <option value="media">Media</option>
            <option value="alta">Alta</option>
            <option value="baja">Baja</option>
          </select>
        </div>

        <div class="form-group">
          <label>Tipo</label>
          <select id="tareaTipo">
            <option value="seguimiento">Seguimiento</option>
            <option value="recurrente">Recurrente</option>
            <option value="nota">Nota rápida</option>
          </select>
        </div>

        <div class="form-group">
          <label>
            <input id="tareaRecurrenteChk" type="checkbox" />
            Es recurrente
          </label>
        </div>

        <div class="form-group">
          <label>Repetir cada (días)</label>
          <input id="tareaRecurrenteDias" type="number" min="1" value="7" />
        </div>
      </div>

      <div class="form-group">
        <label>Descripción</label>
        <textarea id="tareaDescripcion" rows="3"></textarea>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" id="btnBorrarTarea" style="margin-right:auto;">
          Borrar
        </button>

        <button type="button" class="btn-secondary" onclick="tareaDialog.close()">Cancelar</button>
        <button type="submit" class="btn-primary">Guardar</button>
      </div>
    </form>
  </dialog>

  <script type="module">
    import { db } from "./firebase.js";
    import {
      collection,
      getDocs,
      addDoc,
      updateDoc,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    let tareas = [];
    let proyectos = [];

    const collTareas = collection(db, "tareas");
    const collProyectos = collection(db, "proyectos");

    const listaProyectosHTML = document.getElementById("listaProyectos");

    const filtroTipo = document.getElementById("filtroTipo");
    const buscadorTareas = document.getElementById("buscadorTareas");

    const btnNuevaTarea = document.getElementById("btnNuevaTarea");
    const btnCrearNotaRapida = document.getElementById("btnCrearNotaRapida");

    const tareaDialog = document.getElementById("tareaDialog");
    const tareaForm = document.getElementById("tareaForm");

    const tareaId = document.getElementById("tareaId");
    const tareaTitulo = document.getElementById("tareaTitulo");
    const tareaProyecto = document.getElementById("tareaProyecto");
    const tareaFechaUnica = document.getElementById("tareaFechaUnica");
    const tareaEstado = document.getElementById("tareaEstado");
    const tareaPrioridad = document.getElementById("tareaPrioridad");
    const tareaTipo = document.getElementById("tareaTipo");
    const tareaRecurrenteChk = document.getElementById("tareaRecurrenteChk");
    const tareaRecurrenteDias = document.getElementById("tareaRecurrenteDias");
    const tareaDescripcion = document.getElementById("tareaDescripcion");
    const btnBorrarTarea = document.getElementById("btnBorrarTarea");

    async function cargarProyectos() {
      const snap = await getDocs(collProyectos);
      proyectos = [];
      listaProyectosHTML.innerHTML = "";

      snap.forEach(d => {
        const data = d.data();
        const nombre = data.nombre_display || data.nombre || "";
        if (nombre) {
          proyectos.push(nombre);
          const op = document.createElement("option");
          op.value = nombre;
          listaProyectosHTML.appendChild(op);
        }
      });
    }

    async function cargarTareas() {
      const snap = await getDocs(collTareas);
      tareas = [];
      snap.forEach(d => tareas.push({ id: d.id, ...d.data() }));
      renderTodo();
    }

    function renderTodo() {
      renderKpis();
      renderKanban();
      renderNotas();
    }

    function renderKpis() {
      const hoy = new Date().toISOString().slice(0, 10);
      document.getElementById("kpiTareasTotal").textContent = tareas.length;
      document.getElementById("kpiTareasHoy").textContent = tareas.filter(t => t.fecha === hoy).length;
      document.getElementById("kpiTareasUrgentes").textContent = tareas.filter(t => t.prioridad === "alta").length;
    }

    function filtrar() {
      const t = filtroTipo.value;
      const q = buscadorTareas.value.toLowerCase();

      return tareas.filter(x => {
        if (t && x.tipo !== t) return false;
        const blob = (x.titulo || "") + " " + (x.proyecto || "") + " " + (x.descripcion || "");
        return blob.toLowerCase().includes(q);
      });
    }

    function renderKanban() {
      const est = { pendiente: [], proceso: [], hecho: [] };

      filtrar().forEach(t => est[t.estado || "pendiente"].push(t));

      document.getElementById("countPendiente").textContent = est.pendiente.length;
      document.getElementById("countProceso").textContent = est.proceso.length;
      document.getElementById("countHecho").textContent = est.hecho.length;

      ["pendiente", "proceso", "hecho"].forEach(e => {
        const cont = document.querySelector(`.kanban-column-body[data-estado="${e}"]`);
        cont.innerHTML = "";
        est[e].forEach(t => cont.appendChild(card(t)));
      });

      activarDrag();
    }

    function card(t) {
      const d = document.createElement("div");
      d.className = "pipeline-card";
      d.draggable = true;
      d.dataset.id = t.id;

      const badge =
        t.prioridad === "alta"
          ? "background:#FEE2E2;color:#B91C1C;"
          : t.prioridad === "baja"
          ? "background:#E0F2FE;color:#0369A1;"
          : "background:#E5E7EB;color:#374151;";

      d.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
          <button class="link-button" data-id="${t.id}" style="font-weight:600;">
            ${t.titulo}
          </button>
          <span style="font-size:10px;padding:2px 6px;border-radius:999px;${badge}">
            ${t.prioridad.toUpperCase()}
          </span>
        </div>

        <div style="font-size:11px;color:#6B7280;margin-top:3px;">${t.proyecto || ""}</div>

        <div style="font-size:11px;color:#4B5563;margin-top:4px;">
          ${(t.descripcion || "").slice(0,120)}
        </div>

        <div style="font-size:10px;color:#6B7280;margin-top:6px;display:flex;justify-content:space-between;">
          <span>${t.fecha || ""}</span>
          <span>${t.tipo}</span>
        </div>
      `;

      d.querySelector("button").onclick = () => abrir(t.id);

      return d;
    }

    function activarDrag() {
      const cards = document.querySelectorAll(".pipeline-card");
      const cols = document.querySelectorAll(".kanban-column-body");

      cards.forEach(c => {
        c.addEventListener("dragstart", e => {
          e.dataTransfer.setData("id", c.dataset.id);
          c.style.opacity = "0.5";
        });
        c.addEventListener("dragend", () => (c.style.opacity = "1"));
      });

      cols.forEach(col => {
        col.addEventListener("dragover", e => {
          e.preventDefault();
          col.classList.add("drag-over");
        });
        col.addEventListener("dragleave", () => col.classList.remove("drag-over"));
        col.addEventListener("drop", e => {
          col.classList.remove("drag-over");
          const id = e.dataTransfer.getData("id");
          mover(id, col.dataset.estado);
        });
      });
    }

    async function mover(id, nuevoEstado) {
      const t = tareas.find(x => x.id === id);
      if (!t) return;

      if (nuevoEstado === "hecho" && t.es_recurrente && t.recurrente_dias) {
        const d = new Date(t.fecha || new Date());
        d.setDate(d.getDate() + Number(t.recurrente_dias));
        const nueva = d.toISOString().slice(0, 10);

        t.estado = "pendiente";
        t.fecha = nueva;

        await updateDoc(doc(db, "tareas", id), {
          estado: "pendiente",
          fecha: nueva
        });
      } else {
        t.estado = nuevoEstado;
        await updateDoc(doc(db, "tareas", id), { estado: nuevoEstado });
      }

      renderTodo();
    }

    function abrir(id) {
      if (!id) {
        tareaId.value = "";
        tareaTitulo.value = "";
        tareaProyecto.value = "";
        tareaFechaUnica.value = "";
        tareaEstado.value = "pendiente";
        tareaPrioridad.value = "media";
        tareaTipo.value = "seguimiento";
        tareaRecurrenteChk.checked = false;
        tareaRecurrenteDias.value = 7;
        tareaDescripcion.value = "";
        btnBorrarTarea.style.display = "none";
      } else {
        const t = tareas.find(x => x.id === id);
        if (!t) return;

        tareaId.value = t.id;
        tareaTitulo.value = t.titulo;
        tareaProyecto.value = t.proyecto || "";
        tareaFechaUnica.value = t.fecha || "";
        tareaEstado.value = t.estado;
        tareaPrioridad.value = t.prioridad;
        tareaTipo.value = t.tipo;
        tareaRecurrenteChk.checked = !!t.es_recurrente;
        tareaRecurrenteDias.value = t.recurrente_dias || 7;
        tareaDescripcion.value = t.descripcion || "";
        btnBorrarTarea.style.display = "inline-block";
      }
      tareaDialog.showModal();
    }

    btnNuevaTarea.onclick = () => abrir(null);

    tareaForm.onsubmit = async e => {
      e.preventDefault();

      const data = {
        titulo: tareaTitulo.value.trim(),
        proyecto: tareaProyecto.value.trim(),
        fecha: tareaFechaUnica.value || null,
        estado: tareaEstado.value,
        prioridad: tareaPrioridad.value,
        tipo: tareaTipo.value,
        es_recurrente: tareaRecurrenteChk.checked,
        recurrente_dias: tareaRecurrenteChk.checked
          ? Number(tareaRecurrenteDias.value)
          : null,
        descripcion: tareaDescripcion.value.trim()
      };

      const id = tareaId.value;

      if (id) {
        await updateDoc(doc(db, "tareas", id), data);
      } else {
        await addDoc(collTareas, data);
      }

      tareaDialog.close();
      cargarTareas();
    };

    btnBorrarTarea.onclick = async () => {
      const id = tareaId.value;
      if (!id) return;
      await deleteDoc(doc(db, "tareas", id));
      tareaDialog.close();
      cargarTareas();
    };

    btnCrearNotaRapida.onclick = async () => {
      const texto = document.getElementById("notaRapidaTexto").value.trim();
      if (!texto) return;

      const hoy = new Date().toISOString().slice(0, 10);

      await addDoc(collTareas, {
        titulo: texto,
        proyecto: "",
        fecha: hoy,
        estado: "pendiente",
        prioridad: "baja",
        tipo: "nota",
        es_recurrente: false,
        recurrente_dias: null,
        descripcion: texto   /* CORREGIDO → no duplicar */
      });

      document.getElementById("notaRapidaTexto").value = "";
      cargarTareas();
    };

    function renderNotas() {
      const lista = document.getElementById("listaNotasRapidas");
      lista.innerHTML = "";

      const notas = tareas
        .filter(t => t.tipo === "nota")
        .sort((a, b) => (b.fecha || "").localeCompare(a.fecha || ""));

      if (!notas.length) {
        const e = document.createElement("div");
        e.className = "empty-state";
        e.textContent = "Sin notas rápidas.";
        lista.appendChild(e);
        return;
      }

      notas.forEach(n => {
        const li = document.createElement("div");
        li.className = "activity-item";

        li.innerHTML = `
          <div class="activity-title">${n.titulo}</div>
          <div class="activity-sub">${(n.descripcion || "").slice(0,130)}</div>
          <div class="activity-meta">${n.fecha}</div>
        `;

        li.onclick = () => abrir(n.id);
        lista.appendChild(li);
      });
    }

    filtroTipo.onchange = renderTodo;
    buscadorTareas.oninput = renderTodo;

    cargarProyectos();
    cargarTareas();
  </script>
</body>
</html>
