<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM 2N ‚Äì Clientes</title>
  <link rel="stylesheet" href="style.css" />

  <!-- Librer√≠a para leer Excel en el navegador -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
  <!-- NAV SUPERIOR -->
  <div class="topnav">
    <div class="logo">CRM 2N</div>

    <div class="nav-tabs">
      <div class="nav-item" onclick="location.href='index.html'">Dashboard</div>
      <div class="nav-item" onclick="location.href='proyectos.html'">Proyectos</div>
      <div class="nav-item" onclick="location.href='buscar.html'">Buscar</div>
      <div class="nav-item" onclick="location.href='pipeline.html'">Pipeline</div>
      <div class="nav-item active" onclick="location.href='clientes.html'">Clientes</div>
      <div class="nav-item" onclick="location.href='tareas.html'">Tareas</div>
      <div class="nav-item" onclick="location.href='reportes.html'">Reportes</div>
    </div>

    <input type="text" class="search-box" placeholder="(Solo UI) Buscar..." />
  </div>

  <main class="content">
    <h2 style="margin-top:0;margin-bottom:4px;color:#16325C;">Clientes</h2>
    <div style="font-size:12px;color:#5A6872;margin-bottom:10px;">
      Promotoras, arquitecturas, ingenier√≠as, fondos, integradores, etc. vinculados a tus obras.
    </div>

    <!-- FILTROS Y ACCIONES -->
    <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px;">

      <!-- Filtro zona -->
      <select id="fZonaCliente" class="select-input" style="max-width:180px;">
        <option value="Todas">Zonas: todas</option>
      </select>

      <!-- Filtro tipo -->
      <select id="fTipoCliente" class="select-input" style="max-width:180px;">
        <option value="Todos">Tipo: todos</option>
        <option value="Promotora">Promotora</option>
        <option value="Arquitectura">Arquitectura</option>
        <option value="Ingenier√≠a">Ingenier√≠a</option>
        <option value="Fondo / SOCIMI">Fondo / SOCIMI</option>
        <option value="Integrador / Instalador">Integrador / Instalador</option>
        <option value="Property / Gestor">Property / Gestor</option>
        <option value="Otro">Otro</option>
      </select>

      <!-- Filtro segmento -->
      <select id="fSegmentoCliente" class="select-input" style="max-width:200px;">
        <option value="Todos">Segmento: todos</option>
        <option value="Residencial">Residencial</option>
        <option value="Terciario">Terciario</option>
        <option value="Seguridad / CCTV">Seguridad / CCTV</option>
        <option value="Telecom / IT">Telecom / IT</option>
        <option value="Mixto">Mixto</option>
      </select>

      <!-- Filtro texto -->
      <input id="fTextoCliente" class="search-input" style="max-width:240px;" placeholder="Buscar por nombre / ciudad..." />

      <div style="flex:1;"></div>

      <!-- BOT√ìN scouting -->
      <button id="btnOpenScoutingClientes" class="btn-icon" title="Scouting / b√∫squeda avanzada de clientes">
        üîé
      </button>

      <!-- BOT√ìN importar -->
      <button id="btnImportarClientes" class="btn-secondary" type="button" style="font-size:11px;padding:4px 10px;">
        üì• Importar clientes
      </button>
      <input type="file" id="inputImportClientes" accept=".csv, .xlsx" style="display:none;" />

      <!-- BOT√ìN eliminar selecci√≥n -->
      <button id="btnEliminarClientes" class="btn-secondary" type="button" style="font-size:11px;padding:4px 10px;">
        üóë Eliminar seleccionados
      </button>

      <!-- Bot√≥n nuevo -->
      <button id="btnNuevoCliente" class="btn-secondary" type="button" style="font-size:11px;padding:4px 10px;">
        + Nuevo cliente
      </button>
    </div>

    <!-- TABLA + GRAFICO -->
    <div style="display:grid;grid-template-columns:minmax(0,1.5fr) minmax(0,1fr);gap:12px;margin-bottom:12px;">

      <!-- TABLA -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
          <div style="font-size:12px;font-weight:600;color:#111827;">Clientes y obras vinculadas</div>
        </div>
        <div id="clientesTableWrapper"></div>
        <div id="clientesEmpty" class="empty-state" style="display:none;">
          No hay clientes con los filtros seleccionados.
        </div>
      </div>

      <!-- GRAFICO -->
      <div class="card">
        <div style="font-size:12px;font-weight:600;margin-bottom:6px;">TOP clientes por n¬∫ de obras</div>
        <div id="graficoClientes" style="font-size:11px;color:#4B5563;"></div>
      </div>
    </div>
  </main>

  <!-- DIALOG: NUEVO / EDITAR CLIENTE -->
  <dialog id="clienteDialog">
    <div class="modal-header">Cliente</div>
    <form id="clienteForm" method="dialog">
      <div class="form-grid">
        <div class="form-group">
          <label for="cliNombre">Nombre</label>
          <input id="cliNombre" required />
        </div>

        <div class="form-group">
          <label for="cliTipo">Tipo</label>
          <select id="cliTipo">
            <option>Promotora</option>
            <option>Arquitectura</option>
            <option>Ingenier√≠a</option>
            <option>Fondo / SOCIMI</option>
            <option>Integrador / Instalador</option>
            <option>Property / Gestor</option>
            <option>Otro</option>
          </select>
        </div>

        <div class="form-group">
          <label for="cliSegmento">Segmento</label>
          <select id="cliSegmento">
            <option>Residencial</option>
            <option>Terciario</option>
            <option>Seguridad / CCTV</option>
            <option>Telecom / IT</option>
            <option>Mixto</option>
          </select>
        </div>

        <div class="form-group">
          <label for="cliCiudad">Ciudad</label>
          <input id="cliCiudad" />
        </div>

        <div class="form-group">
          <label for="cliProvincia">Provincia</label>
          <input id="cliProvincia" />
        </div>

        <div class="form-group">
          <label for="cliTelefono">Tel√©fono</label>
          <input id="cliTelefono" />
        </div>

        <div class="form-group">
          <label for="cliWeb">Web</label>
          <input id="cliWeb" placeholder="https://..." />
        </div>
      </div>

      <!-- OBRAS VINCULADAS -->
      <div id="clienteObrasContainer" style="margin-top:12px;">
        <div style="font-size:11px;font-weight:600;color:#111827;margin-bottom:4px;">
          Obras vinculadas
        </div>
        <div id="clienteObrasLista"
          style="max-height:160px;overflow:auto;font-size:11px;color:#4B5563;border:1px solid #E5E7EB;border-radius:6px;padding:6px;">
          <span style="color:#9CA3AF;">Sin obras vinculadas todav√≠a.</span>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="document.getElementById('clienteDialog').close()">Cancelar</button>
        <button class="btn-primary" type="submit">Guardar</button>
      </div>
    </form>
  </dialog>

  <!-- DIALOG SCOUTING -->
  <dialog id="scoutingClientesDialog" style="max-width:900px;width:95%;">
    <div class="modal-header" style="display:flex;justify-content:space-between;">
      <span>üõ∞Ô∏è Scouting ¬∑ Buscar clientes</span>
      <button type="button" class="btn-icon" onclick="document.getElementById('scoutingClientesDialog').close()">‚úñ</button>
    </div>

    <div class="card" style="margin-top:4px;box-shadow:none;border:none;padding:0;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div>
          <div style="font-size:12px;font-weight:600;color:#111827;">Generador de prompt</div>
          <div style="font-size:10.5px;color:#6B7280;">
            Genera un prompt profundo para identificar clientes clave para 2N.
          </div>
        </div>
        <button id="btnCopiarPromptClientes" class="btn-secondary" style="font-size:11px;padding:4px 10px;">
          Copiar prompt
        </button>
      </div>

      <div style="display:grid;grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);gap:12px;margin-bottom:10px;">
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div class="form-group">
            <label>üìç Zonas objetivo</label>
            <input id="cliZonas" placeholder="Ej: Madrid, M√°laga, Barcelona, Lisboa" />
          </div>

          <div class="form-group">
            <label>üè¢ Tipo de cliente</label>
            <div style="display:flex;flex-wrap:wrap;gap:6px;font-size:11px;">
              <label class="chip"><input type="checkbox" class="chk-cli-tipo" value="promotoras"> Promotoras</label>
              <label class="chip"><input type="checkbox" class="chk-cli-tipo" value="arquitecturas"> Arquitecturas</label>
              <label class="chip"><input type="checkbox" class="chk-cli-tipo" value="ingenierias"> Ingenier√≠as</label>
              <label class="chip"><input type="checkbox" class="chk-cli-tipo" value="fondos"> Fondos / SOCIMIs</label>
              <label class="chip"><input type="checkbox" class="chk-cli-tipo" value="integradores"> Integradores</label>
              <label class="chip"><input type="checkbox" class="chk-cli-tipo" value="property"> Property</label>
            </div>
          </div>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px;">
          <div class="form-group">
            <label>üí∂ Perfil / ticket</label>
            <input id="cliTicket" placeholder="Ej: proyectos > 3M‚Ç¨" />
          </div>

          <div class="form-group">
            <label>üîç Notas adicionales</label>
            <textarea id="cliNotas" rows="4"></textarea>
          </div>
        </div>
      </div>

      <textarea id="promptClientes" rows="15"
        style="width:100%;border-radius:8px;border:1px solid #D1D5DB;padding:8px;font-family:monospace;font-size:12px;"></textarea>
    </div>
  </dialog>

  <!-- SCRIPT PRINCIPAL -->
  <script type="module">
    import { db } from "./firebase.js";
    import {
      collection,
      getDocs,
      addDoc,
      doc,
      updateDoc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // ESTADO
    let clientes = [];
    let proyectos = [];
    let clientesView = [];
    let clienteEditandoId = null;

    const fZonaCliente = document.getElementById("fZonaCliente");
    const fTipoCliente = document.getElementById("fTipoCliente");
    const fSegmentoCliente = document.getElementById("fSegmentoCliente");
    const fTextoCliente = document.getElementById("fTextoCliente");

    const clientesTableWrapper = document.getElementById("clientesTableWrapper");
    const clientesEmpty = document.getElementById("clientesEmpty");
    const graficoClientes = document.getElementById("graficoClientes");

    const clienteDialog = document.getElementById("clienteDialog");
    const clienteForm = document.getElementById("clienteForm");
    const btnNuevoCliente = document.getElementById("btnNuevoCliente");
    const btnEliminarClientes = document.getElementById("btnEliminarClientes");

    const scoutingDialog = document.getElementById("scoutingClientesDialog");
    const btnOpenScoutingClientes = document.getElementById("btnOpenScoutingClientes");

    const cliZonas = document.getElementById("cliZonas");
    const cliTicket = document.getElementById("cliTicket");
    const cliNotas = document.getElementById("cliNotas");
    const promptClientes = document.getElementById("promptClientes");
    const chkCliTipo = document.querySelectorAll(".chk-cli-tipo");
    const chkCliSeg = document.querySelectorAll(".chk-cli-seg");
    const btnCopiarPromptClientes = document.getElementById("btnCopiarPromptClientes");

    const inputImportClientes = document.getElementById("inputImportClientes");
    const btnImportarClientes = document.getElementById("btnImportarClientes");

    // CARGA (1 sola lectura clientes + 1 sola lectura proyectos)
    async function cargarClientesYProyectos() {
      const [cliSnap, proySnap] = await Promise.all([
        getDocs(collection(db, "clientes")),
        getDocs(collection(db, "proyectos"))
      ]);

      clientes = cliSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      proyectos = proySnap.docs.map(d => ({ id: d.id, ...d.data() }));

      recalcularVinculaciones();
      inicializarFiltroZonasClientes();
      aplicarFiltrosClientes();
    }

    function normalizar(txt) {
      return (txt || "").toString().trim().toLowerCase();
    }

    function contarObrasCliente(nombreCliente) {
      const target = normalizar(nombreCliente);
      if (!target) return 0;

      let contador = 0;
      proyectos.forEach(p => {
        if (
          normalizar(p.cliente_principal) === target ||
          normalizar(p.promotora) === target ||
          normalizar(p.constructora) === target ||
          normalizar(p.arquitectura) === target ||
          normalizar(p.ingenieria) === target
        ) {
          contador++;
        }
      });
      return contador;
    }

    function recalcularVinculaciones() {
      clientesView = clientes.map(c => {
        const nombre = c.nombre || c.nombre_cliente || "";
        return {
          ...c,
          nombre_display: nombre,
          num_obras: contarObrasCliente(nombre)
        };
      });
    }

    function inicializarFiltroZonasClientes() {
      const zonasSet = new Set();
      clientesView.forEach(c => {
        if (c.ciudad) zonasSet.add(c.ciudad);
        if (c.provincia) zonasSet.add(c.provincia);
      });
      const zonas = [...zonasSet].sort((a, b) => a.localeCompare(b, "es"));

      fZonaCliente.innerHTML =
        '<option value="Todas">Zonas: todas</option>' +
        zonas.map(z => `<option value="${z}">${z}</option>`).join("");
    }

    // FILTROS
    function aplicarFiltrosClientes() {
      const zona = fZonaCliente.value;
      const tipo = fTipoCliente.value;
      const seg = fSegmentoCliente.value;
      const txt = normalizar(fTextoCliente.value);

      let lista = clientesView.slice();

      lista = lista.filter(c => {
        let ok = true;
        if (zona !== "Todas") {
          ok = ok && (c.ciudad === zona || c.provincia === zona);
        }
        if (tipo !== "Todos") ok = ok && (c.tipo === tipo);
        if (seg !== "Todos") ok = ok && (c.segmento === seg);

        if (txt) {
          const blob = [
            c.nombre_display,
            c.ciudad,
            c.provincia,
            c.tipo,
            c.segmento
          ].join(" ").toLowerCase();
          ok = ok && blob.includes(txt);
        }
        return ok;
      });

      lista.sort((a, b) => (b.num_obras || 0) - (a.num_obras || 0));
      renderTablaClientes(lista);
      renderGraficoClientes(lista);
    }

    function renderWeb(url) {
      if (!url) return "";
      const href = url.startsWith("http") ? url : "https://" + url;
      return `<a href="${href}" target="_blank">üîó</a>`;
    }

    function renderTablaClientes(lista) {
      if (!lista.length) {
        clientesTableWrapper.innerHTML = "";
        clientesEmpty.style.display = "block";
        return;
      }
      clientesEmpty.style.display = "none";

      let html = `
        <table>
          <thead>
            <tr>
              <th><input type="checkbox" id="chkClientesAll" /></th>
              <th>Cliente</th>
              <th>Tipo</th>
              <th>Segmento</th>
              <th>Ciudad</th>
              <th>Provincia</th>
              <th>Tel√©fono</th>
              <th>Web</th>
              <th>Obras</th>
            </tr>
          </thead>
          <tbody>
      `;

      lista.forEach(c => {
        html += `
          <tr>
            <td><input type="checkbox" class="chk-cliente-row" data-id="${c.id}" /></td>
            <td>
              <button class="link-button cliente-nombre-link" data-id="${c.id}">
                ${c.nombre_display || ""}
              </button>
            </td>
            <td>${c.tipo || ""}</td>
            <td>${c.segmento || ""}</td>
            <td>${c.ciudad || ""}</td>
            <td>${c.provincia || ""}</td>
            <td>${c.telefono || ""}</td>
            <td>${renderWeb(c.web)}</td>
            <td>${c.num_obras || 0}</td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      clientesTableWrapper.innerHTML = html;

      // Eventos tabla
      const chkAll = document.getElementById("chkClientesAll");
      if (chkAll) {
        chkAll.addEventListener("change", () => {
          document.querySelectorAll(".chk-cliente-row").forEach(ch => {
            ch.checked = chkAll.checked;
          });
        });
      }

      document.querySelectorAll(".cliente-nombre-link").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.id;
          abrirDialogEdicionCliente(id);
        });
      });
    }

    function renderGraficoClientes(lista) {
      if (!lista.length) {
        graficoClientes.innerHTML = "<div style='font-size:11px;color:#9CA3AF;'>Sin datos.</div>";
      } else {
        const top = lista.slice(0, 8);
        const max = Math.max(...top.map(c => c.num_obras || 0)) || 1;
        graficoClientes.innerHTML = top.map(c => {
          const pct = ((c.num_obras || 0) / max) * 100;
          return `
            <div>
              <div style="display:flex;justify-content:space-between;font-size:10.5px;margin-bottom:2px;">
                <span style="max-width:70%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                  ${c.nombre_display || ""}
                </span>
                <span style="color:#4B5563;">${c.num_obras || 0} obras</span>
              </div>
              <div style="width:100%;background:#E5E7EB;border-radius:999px;overflow:hidden;height:8px;">
                <div style="width:${pct}%;height:100%;background:linear-gradient(90deg,#4F46E5,#22C55E);"></div>
              </div>
            </div>
          `;
        }).join("");
      }
    }

    function renderObrasCliente(nombreCliente) {
      const cont = document.getElementById("clienteObrasLista");
      if (!cont) return;

      const target = normalizar(nombreCliente);
      const lista = [];

      proyectos.forEach(p => {
        const roles = [];
        if (normalizar(p.cliente_principal) === target) roles.push("Cliente principal");
        if (normalizar(p.promotora) === target) roles.push("Promotora");
        if (normalizar(p.constructora) === target) roles.push("Constructora");
        if (normalizar(p.arquitectura) === target) roles.push("Arquitectura");
        if (normalizar(p.ingenieria) === target) roles.push("Ingenier√≠a");
        if (roles.length) {
          lista.push({
            nombre: p.nombre_obra || p.nombre || "(Proyecto sin nombre)",
            roles
          });
        }
      });

      if (!lista.length) {
        cont.innerHTML = "<span style='color:#9CA3AF;'>Sin obras vinculadas todav√≠a.</span>";
        return;
      }

      cont.innerHTML = lista
        .map(
          item =>
            `<div style="margin-bottom:4px;">
              <div style="font-weight:500;">${item.nombre}</div>
              <div style="font-size:10px;color:#6B7280;">${item.roles.join(", ")}</div>
            </div>`
        )
        .join("");
    }

    // NUEVO / EDITAR CLIENTE
    btnNuevoCliente.addEventListener("click", () => {
      clienteEditandoId = null;
      clienteForm.reset();
      document.getElementById("clienteObrasLista").innerHTML =
        "<span style='color:#9CA3AF;'>Sin obras vinculadas todav√≠a.</span>";
      clienteDialog.showModal();
    });

    function abrirDialogEdicionCliente(id) {
      const c = clientes.find(cl => cl.id === id);
      if (!c) return;

      clienteEditandoId = id;

      document.getElementById("cliNombre").value = c.nombre || c.nombre_cliente || "";
      document.getElementById("cliTipo").value = c.tipo || "Promotora";
      document.getElementById("cliSegmento").value = c.segmento || "Residencial";
      document.getElementById("cliCiudad").value = c.ciudad || "";
      document.getElementById("cliProvincia").value = c.provincia || "";
      document.getElementById("cliTelefono").value = c.telefono || "";
      document.getElementById("cliWeb").value = c.web || "";

      renderObrasCliente(c.nombre || c.nombre_cliente || "");
      clienteDialog.showModal();
    }

    clienteForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const payload = {
        nombre: document.getElementById("cliNombre").value.trim(),
        tipo: document.getElementById("cliTipo").value,
        segmento: document.getElementById("cliSegmento").value,
        ciudad: document.getElementById("cliCiudad").value.trim(),
        provincia: document.getElementById("cliProvincia").value.trim(),
        telefono: document.getElementById("cliTelefono").value.trim(),
        web: document.getElementById("cliWeb").value.trim(),
      };

      if (clienteEditandoId) {
        await updateDoc(doc(db, "clientes", clienteEditandoId), payload);
        const idx = clientes.findIndex(c => c.id === clienteEditandoId);
        if (idx !== -1) clientes[idx] = { ...clientes[idx], ...payload };
      } else {
        const ref = await addDoc(collection(db, "clientes"), { ...payload, fuente: "manual" });
        clientes.push({ id: ref.id, ...payload, fuente: "manual" });
      }

      recalcularVinculaciones();
      inicializarFiltroZonasClientes();
      aplicarFiltrosClientes();

      clienteDialog.close();
    });

    // ELIMINAR SELECCIONADOS
    btnEliminarClientes.addEventListener("click", async () => {
      const marcados = Array.from(document.querySelectorAll(".chk-cliente-row:checked"));
      if (!marcados.length) {
        alert("Selecciona al menos un cliente.");
        return;
      }
      if (!confirm(`Vas a eliminar ${marcados.length} clientes. ¬øSeguro?`)) return;

      const ids = marcados.map(ch => ch.dataset.id);
      for (const id of ids) {
        await deleteDoc(doc(db, "clientes", id));
      }
      clientes = clientes.filter(c => !ids.includes(c.id));
      recalcularVinculaciones();
      inicializarFiltroZonasClientes();
      aplicarFiltrosClientes();
    });

    // SCOUTING: PROMPT
    function getCheckedValues(nodeList) {
      return Array.from(nodeList).filter(el => el.checked).map(el => el.value);
    }

    function generarPromptClientes() {
      const zonas = cliZonas.value.trim();
      const tipos = getCheckedValues(chkCliTipo);
      const segmentos = getCheckedValues(chkCliSeg);
      const ticket = cliTicket.value.trim();
      const notas = cliNotas.value.trim();

      const partes = [];

      partes.push(
        "Act√∫a como un analista s√©nior de mercado inmobiliario y de inversi√≥n, " +
        "especializado en identificar CLIENTES CLAVE para soluciones de control de accesos y videoportero IP de 2N."
      );
      partes.push(
        "Trabaja en MODO INVESTIGACI√ìN PROFUNDA: webs corporativas, notas de prensa, registros, LinkedIn, portales de obras, etc."
      );

      if (zonas) partes.push(`Zonas objetivo: ${zonas}.`);
      if (tipos.length) partes.push(`Tipos de cliente prioritarios: ${tipos.join(", ")}.`);
      if (segmentos.length) partes.push(`Segmentos de actividad prioritarios: ${segmentos.join(", ")}.`);
      if (ticket) partes.push(`Perfil de proyectos / ticket t√≠pico: ${ticket}.`);
      if (notas) partes.push(`Notas adicionales: ${notas}.`);

      partes.push(
        "Para cada empresa, eval√∫a el ENCAJE POTENCIAL con 2N (n¬∫ y tipo de proyectos, complejidad de accesos, integraci√≥n, etc.) " +
        "y clasifica encaje_2n_cliente en ALTO, MEDIO o BAJO con motivo_encaje_2n."
      );

      partes.push(
        "SALIDA DE DATOS: genera un Excel (.xlsx) llamado 'clientes_2n.xlsx' con hoja 'Clientes' " +
        "o, si no es posible, un CSV. Usa EXACTAMENTE estas columnas en este orden:"
      );
      partes.push(
        "nombre_cliente, tipo_cliente, segmento_principal, telefono, email, persona_contacto, cargo_contacto, " +
        "telefono_contacto, email_contacto, web, direccion, ciudad, provincia, pais, linkedin_empresa, linkedin_contacto, " +
        "proyectos_relevantes_resumen, volumen_estimado_proyectos, encaje_2n_cliente, motivo_encaje_2n, fuente_principal"
      );
      partes.push(
        "Si devuelves CSV, usa ';' como separador y NO a√±adas texto fuera del bloque CSV."
      );

      promptClientes.value = partes.join("\n\n");
    }

    generarPromptClientes();

    [cliZonas, cliTicket, cliNotas].forEach(el =>
      el.addEventListener("input", generarPromptClientes)
    );
    [...chkCliTipo, ...chkCliSeg].forEach(ch =>
      ch.addEventListener("change", generarPromptClientes)
    );

    btnOpenScoutingClientes.addEventListener("click", () => {
      scoutingDialog.showModal();
    });

    btnCopiarPromptClientes.addEventListener("click", async () => {
      await navigator.clipboard.writeText(promptClientes.value || "");
      btnCopiarPromptClientes.textContent = "Copiado ‚úî";
      setTimeout(() => (btnCopiarPromptClientes.textContent = "Copiar prompt"), 1200);
    });

    // IMPORTAR CLIENTES (CSV / XLSX) ‚Äì con mensaje SIEMPRE
    btnImportarClientes.addEventListener("click", () => inputImportClientes.click());

    function buildClienteKey(obj) {
      const nombre = normalizar(obj.nombre_cliente || obj.nombre || "");
      const web = normalizar(obj.web || "");
      return `${nombre}|${web}`;
    }

    function buildClientesKeySet() {
      const set = new Set();
      clientes.forEach(c => set.add(buildClienteKey(c)));
      return set;
    }

    inputImportClientes.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const ext = file.name.split(".").pop().toLowerCase();
      const existingKeys = buildClientesKeySet();
      let added = 0;
      let skipped = 0;

      try {
        if (ext === "csv") {
          const res = await importarCSVClientes(file, existingKeys);
          added = res.a; skipped = res.s;
        } else if (ext === "xlsx") {
          const res = await importarXLSXClientes(file, existingKeys);
          added = res.a; skipped = res.s;
        } else {
          alert("Formato no v√°lido. Usa CSV o XLSX.");
          inputImportClientes.value = "";
          return;
        }

        recalcularVinculaciones();
        inicializarFiltroZonasClientes();
        aplicarFiltrosClientes();

        alert(`Importaci√≥n completada.\nA√±adidos: ${added}\nDuplicados ignorados: ${skipped}`);
      } catch (err) {
        console.error("Error importando clientes:", err);
        alert("Ha ocurrido un error durante la importaci√≥n. Revisa que el archivo tenga las columnas correctas.");
      } finally {
        inputImportClientes.value = "";
      }
    });

    async function importarCSVClientes(file, existingKeys) {
      const text = await file.text();
      const lines = text.split("\n").map(l => l.trim()).filter(l => l);
      if (!lines.length) return { a: 0, s: 0 };

      const headers = lines[0].split(";");
      let added = 0, skipped = 0;

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(";");
        const row = {};
        headers.forEach((h, idx) => row[h] = values[idx] || "");

        const key = buildClienteKey(row);
        if (existingKeys.has(key)) {
          skipped++;
          continue;
        }

        const payload = mapRowToClientePayload(row, "scouting_csv");
        const ref = await addDoc(collection(db, "clientes"), payload);
        clientes.push({ id: ref.id, ...payload });
        existingKeys.add(key);
        added++;
      }

      return { a: added, s: skipped };
    }

    async function importarXLSXClientes(file, existingKeys) {
      if (typeof XLSX === "undefined") {
        throw new Error("Librer√≠a XLSX no cargada");
      }

      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data);
      const sheet = workbook.Sheets["Clientes"] || workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });

      let added = 0, skipped = 0;

      for (const row of json) {
        const key = buildClienteKey(row);
        if (existingKeys.has(key)) {
          skipped++;
          continue;
        }

        const payload = mapRowToClientePayload(row, "scouting_excel");
        const ref = await addDoc(collection(db, "clientes"), payload);
        clientes.push({ id: ref.id, ...payload });
        existingKeys.add(key);
        added++;
      }

      return { a: added, s: skipped };
    }

    function mapRowToClientePayload(row, fuentePorDefecto) {
      return {
        nombre: row.nombre_cliente || row.nombre || "",
        tipo: row.tipo_cliente || "",
        segmento: row.segmento_principal || "",
        telefono: row.telefono || "",
        email: row.email || "",
        persona_contacto: row.persona_contacto || "",
        cargo_contacto: row.cargo_contacto || "",
        telefono_contacto: row.telefono_contacto || "",
        email_contacto: row.email_contacto || "",
        web: row.web || "",
        direccion: row.direccion || "",
        ciudad: row.ciudad || "",
        provincia: row.provincia || "",
        pais: row.pais || "",
        linkedin_empresa: row.linkedin_empresa || "",
        linkedin_contacto: row.linkedin_contacto || "",
        proyectos_relevantes_resumen: row.proyectos_relevantes_resumen || "",
        volumen_estimado_proyectos: row.volumen_estimado_proyectos || "",
        encaje_2n_cliente: row.encaje_2n_cliente || "",
        motivo_encaje_2n: row.motivo_encaje_2n || "",
        fuente: row.fuente_principal || fuentePorDefecto
      };
    }

    // EVENTOS FILTROS
    fZonaCliente.addEventListener("change", aplicarFiltrosClientes);
    fTipoCliente.addEventListener("change", aplicarFiltrosClientes);
    fSegmentoCliente.addEventListener("change", aplicarFiltrosClientes);
    fTextoCliente.addEventListener("input", aplicarFiltrosClientes);

    // ARRANQUE
    cargarClientesYProyectos();
  </script>
</body>
</html>
