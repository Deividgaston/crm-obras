<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM 2N ‚Äì Clientes</title>
  <link rel="stylesheet" href="style.css" />

  <!-- XLSX para importaci√≥n Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
  <!-- NAV SUPERIOR -->
  <div class="topnav">
    <div class="logo">CRM 2N</div>

    <div class="nav-tabs">
      <div class="nav-item" onclick="location.href='index.html'">Dashboard</div>
      <div class="nav-item" onclick="location.href='proyectos.html'">Proyectos</div>
      <div class="nav-item" onclick="location.href='buscar.html'">Buscar</div>
      <div class="nav-item" onclick="location.href='pipeline.html'">Pipeline</div>
      <div class="nav-item active" onclick="location.href='clientes.html'">Clientes</div>
      <div class="nav-item" onclick="location.href='tareas.html'">Tareas</div>
      <div class="nav-item" onclick="location.href='reportes.html'">Reportes</div>
    </div>

    <div style="display:flex;align-items:center;gap:8px;">
      <input
        type="text"
        class="search-box"
        placeholder="Buscar cliente (solo UI)‚Ä¶"
        id="fTextoCliente"
      />
      <button
        id="btnLogout"
        type="button"
        style="
          font-size: 11px;
          padding: 6px 10px;
          border-radius: 999px;
          border: 1px solid #E5E7EB;
          background: #FFFFFF;
          color: #111827;
          cursor: pointer;
          white-space: nowrap;
        "
      >
        Cerrar sesi√≥n
      </button>
    </div>
  </div>

  <main class="content">
    <h2 style="margin-top: 0; margin-bottom: 4px; color: #16325C;">Clientes</h2>
    <div style="font-size: 12px; color: #5A6872; margin-bottom: 16px;">
      Gesti√≥n de clientes clave para 2N (promotoras, arquitecturas, ingenier√≠as, fondos, integradores, etc.).
    </div>

    <!-- FILA SUPERIOR: FILTROS + IMPORTACI√ìN -->
    <div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:12px;align-items:flex-end;">

      <div style="display:flex;flex-wrap:wrap;gap:8px;">
        <select id="fZonaCliente" class="filter-select">
          <option value="Todas">Zona: todas</option>
        </select>

        <select id="fTipoCliente" class="filter-select">
          <option value="Todos">Tipo: todos</option>
        </select>

        <select id="fSegmentoCliente" class="filter-select">
          <option value="Todos">Segmento: todos</option>
        </select>
      </div>

      <div style="flex:1 1 auto;"></div>

      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
        <div style="font-size:11px;color:#6B7280;">
          Importar clientes desde Excel / CSV
        </div>
        <div style="display:flex;gap:6px;align-items:center;">
          <input
            type="file"
            id="fileImportClientes"
            accept=".csv,.xlsx,.xls"
            style="font-size:11px;"
          />
          <button
            id="btnImportClientes"
            class="btn-secondary"
            style="font-size:11px;padding:6px 10px;"
          >
            Importar
          </button>
        </div>
        <div style="font-size:10px;color:#9CA3AF;">
          Espera columnas est√°ndar (nombre, tipo, segmento, zona, web, tel, etc.).
        </div>
      </div>
    </div>

    <!-- KPI RESUMEN -->
    <div class="kpi-row" style="margin-bottom:12px;">
      <div class="kpi-card">
        <div class="kpi-label">Clientes totales</div>
        <div id="kpiClientesTotal" class="kpi-value">‚Äì</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Clientes filtrados</div>
        <div id="kpiClientesFiltrados" class="kpi-value">‚Äì</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Clientes con obras activas</div>
        <div id="kpiClientesConObras" class="kpi-value">‚Äì</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Clientes con 2N</div>
        <div id="kpiClientes2N" class="kpi-value">‚Äì</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:minmax(0,1.4fr) minmax(0,0.8fr);gap:16px;align-items:flex-start;">

      <!-- TABLA PRINCIPAL -->
      <div class="card" style="overflow:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <div>
            <div style="font-size:12px;font-weight:600;color:#111827;">Listado de clientes</div>
            <div style="font-size:10.5px;color:#6B7280;">
              Vista agrupada, con filtro por zona, tipo y segmento.
            </div>
          </div>
        </div>

        <table class="table" style="min-width: 100%;">
          <thead>
            <tr>
              <th style="width: 24px;"></th>
              <th>Cliente</th>
              <th>Ciudad</th>
              <th>Provincia</th>
              <th>Tel√©fono</th>
              <th>Web</th>
              <th>2N</th>
              <th>Obras</th>
            </tr>
          </thead>
          <tbody id="clientesTableBody"></tbody>
        </table>
      </div>

      <!-- PANEL LATERAL: TOP CLIENTES -->
      <div class="card">
        <div style="font-size:12px;font-weight:600;color:#111827;margin-bottom:4px;">
          TOP clientes por n¬∫ de obras
        </div>
        <div style="font-size:10.5px;color:#6B7280;margin-bottom:8px;">
          Ranking de clientes seg√∫n n√∫mero de obras vinculadas en Proyectos.
        </div>
        <div id="topClientesLista" style="display:flex;flex-direction:column;gap:4px;"></div>
      </div>

    </div>
  </main>

  <!-- MODAL DETALLE CLIENTE -->
  <dialog id="clienteDialog">
    <div class="modal-header">Detalle de cliente</div>
    <form method="dialog" id="clienteForm">
      <div class="form-group">
        <label style="font-size:12px;font-weight:600;color:#111827;">Nombre</label>
        <div id="cliNombre" style="font-size:12px;color:#374151;padding:6px 8px;border-radius:6px;background:#F9FAFB;border:1px solid #E5E7EB;"></div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label style="font-size:11.5px;font-weight:600;color:#111827;">Tipo</label>
          <div id="cliTipo" style="font-size:12px;color:#374151;padding:6px 8px;border-radius:6px;background:#F9FAFB;border:1px solid #E5E7EB;"></div>
        </div>
        <div class="form-group">
          <label style="font-size:11.5px;font-weight:600;color:#111827;">Segmento</label>
          <div id="cliSegmento" style="font-size:12px;color:#374151;padding:6px 8px;border-radius:6px;background:#F9FAFB;border:1px solid #E5E7EB;"></div>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label style="font-size:11.5px;font-weight:600;color:#111827;">Ciudad</label>
          <div id="cliCiudad" style="font-size:12px;color:#374151;padding:6px 8px;border-radius:6px;background:#F9FAFB;border:1px solid #E5E7EB;"></div>
        </div>
        <div class="form-group">
          <label style="font-size:11.5px;font-weight:600;color:#111827;">Provincia</label>
          <div id="cliProvincia" style="font-size:12px;color:#374151;padding:6px 8px;border-radius:6px;background:#F9FAFB;border:1px solid #E5E7EB;"></div>
        </div>
      </div>

      <div class="form-group">
        <label style="font-size:11.5px;font-weight:600;color:#111827;">Contacto principal</label>
        <div id="cliContacto" style="font-size:12px;color:#374151;padding:6px 8px;border-radius:6px;background:#F9FAFB;border:1px solid #E5E7EB;"></div>
      </div>

      <div class="form-group">
        <label style="font-size:11.5px;font-weight:600;color:#111827;">Web</label>
        <div id="cliWeb" style="font-size:12px;color:#2563EB;padding:6px 8px;border-radius:6px;background:#EFF6FF;border:1px solid #BFDBFE;word-break:break-all;"></div>
      </div>

      <div class="form-group">
        <label style="font-size:11.5px;font-weight:600;color:#111827;">Notas</label>
        <div id="cliNotas" style="font-size:12px;color:#374151;padding:6px 8px;border-radius:6px;background:#F9FAFB;border:1px solid #E5E7EB;min-height:60px;"></div>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn-primary">Cerrar</button>
      </div>
    </form>
  </dialog>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import {
      collection,
      getDocs,
      addDoc,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { onAuthStateChanged }
      from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const clientesTableBody = document.getElementById("clientesTableBody");
    const topClientesLista = document.getElementById("topClientesLista");

    const fZonaCliente = document.getElementById("fZonaCliente");
    const fTipoCliente = document.getElementById("fTipoCliente");
    const fSegmentoCliente = document.getElementById("fSegmentoCliente");
    const fTextoCliente = document.getElementById("fTextoCliente");

    const kpiClientesTotal = document.getElementById("kpiClientesTotal");
    const kpiClientesFiltrados = document.getElementById("kpiClientesFiltrados");
    const kpiClientesConObras = document.getElementById("kpiClientesConObras");
    const kpiClientes2N = document.getElementById("kpiClientes2N");

    const fileImportClientes = document.getElementById("fileImportClientes");
    const btnImportClientes = document.getElementById("btnImportClientes");

    const clienteDialog = document.getElementById("clienteDialog");
    const cliNombre = document.getElementById("cliNombre");
    const cliTipo = document.getElementById("cliTipo");
    const cliSegmento = document.getElementById("cliSegmento");
    const cliCiudad = document.getElementById("cliCiudad");
    const cliProvincia = document.getElementById("cliProvincia");
    const cliContacto = document.getElementById("cliContacto");
    const cliWeb = document.getElementById("cliWeb");
    const cliNotas = document.getElementById("cliNotas");

    let clientes = [];
    let proyectos = [];

    function norm(str) {
      return (str || "")
        .toString()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .trim();
    }

    function buildClienteKey(c) {
      return `${norm(c.nombre || "")}__${norm(c.ciudad || "")}__${norm(c.provincia || "")}__${norm(c.tipo || "")}`;
    }

    function mapRowClientes(row, origen = "scouting_excel") {
      const nombre =
        row["Cliente"] ||
        row["Nombre cliente"] ||
        row["Nombre"] ||
        row["nombre"] ||
        "";

      if (!nombre) return null;

      const ciudad = row["Ciudad"] || row["city"] || row["Localidad"] || "";
      const provincia = row["Provincia"] || row["provincia"] || "";
      const telefono =
        row["Tel√©fono"] || row["Telefono"] || row["telefono"] || "";
      const web = row["Web"] || row["web"] || "";
      const tipo =
        row["Tipo"] ||
        row["Tipo cliente"] ||
        row["tipo"] ||
        row["tipo_cliente"] ||
        "";
      const segmento =
        row["Segmento"] ||
        row["Segmento principal"] ||
        row["segmento"] ||
        "";
      const notas =
        row["Notas"] ||
        row["Observaciones"] ||
        row["Comentario"] ||
        row["comentarios"] ||
        "";

      const trabaja2n =
        row["2N"] === "SI" ||
        row["2N"] === "S√≠" ||
        row["2N"] === "si" ||
        row["2N"] === "s√≠" ||
        row["2n"] === "si";

      return {
        nombre: nombre.trim(),
        ciudad: ciudad || "",
        provincia: provincia || "",
        telefono: telefono || "",
        web: web || "",
        tipo: tipo || "",
        segmento: segmento || "",
        notas: notas || "",
        trabaja_con_2n: trabaja2n || false,
        origen: origen || "scouting_excel",
        created_at: new Date().toISOString()
      };
    }

    async function cargarClientesYProyectos() {
      try {
        const [snapClientes, snapProyectos] = await Promise.all([
          getDocs(collection(db, "clientes")),
          getDocs(collection(db, "proyectos"))
        ]);

        clientes = snapClientes.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        proyectos = snapProyectos.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        actualizarFiltrosClientes();
        aplicarFiltrosClientes();
        renderTopClientes();
      } catch (err) {
        console.error("Error cargando clientes/proyectos:", err);
        alert("Error cargando datos de clientes o proyectos.");
      }
    }

    function actualizarFiltrosClientes() {
      const zonas = new Set();
      const tipos = new Set();
      const segmentos = new Set();

      clientes.forEach(c => {
        if (c.provincia) zonas.add(c.provincia);
        if (c.tipo) tipos.add(c.tipo);
        if (c.segmento) segmentos.add(c.segmento);
      });

      fZonaCliente.innerHTML = '<option value="Todas">Zona: todas</option>' +
        [...zonas].sort((a, b) => a.localeCompare(b, "es"))
          .map(z => `<option value="${z}">${z}</option>`).join("");

      fTipoCliente.innerHTML = '<option value="Todos">Tipo: todos</option>' +
        [...tipos].sort((a, b) => a.localeCompare(b, "es"))
          .map(t => `<option value="${t}">${t}</option>`).join("");

      fSegmentoCliente.innerHTML = '<option value="Todos">Segmento: todos</option>' +
        [...segmentos].sort((a, b) => a.localeCompare(b, "es"))
          .map(s => `<option value="${s}">${s}</option>`).join("");
    }

    function aplicarFiltrosClientes() {
      const zonaSel = fZonaCliente.value;
      const tipoSel = fTipoCliente.value;
      const segSel = fSegmentoCliente.value;
      const texto = norm(fTextoCliente.value || "");

      let lista = [...clientes];

      if (zonaSel !== "Todas") {
        lista = lista.filter(c => c.provincia === zonaSel);
      }
      if (tipoSel !== "Todos") {
        lista = lista.filter(c => c.tipo === tipoSel);
      }
      if (segSel !== "Todos") {
        lista = lista.filter(c => c.segmento === segSel);
      }
      if (texto) {
        lista = lista.filter(c =>
          norm(
            `${c.nombre || ""} ${c.ciudad || ""} ${c.provincia || ""} ${c.tipo || ""} ${c.segmento || ""}`
          ).includes(texto)
        );
      }

      lista.sort((a, b) => (a.nombre || "").localeCompare(b.nombre || "", "es"));

      renderTablaClientes(lista);
      actualizarKPIsClientes(lista);
    }

    function actualizarKPIsClientes(listaFiltrada) {
      const total = clientes.length;
      const filtrados = listaFiltrada.length;
      const conObras = new Set(
        proyectos
          .filter(p => p.cliente_principal)
          .map(p => norm(p.cliente_principal))
      );
      const clientesConObras = clientes.filter(c => conObras.has(norm(c.nombre))).length;
      const clientes2N = clientes.filter(c => c.trabaja_con_2n === true).length;

      kpiClientesTotal.textContent = total;
      kpiClientesFiltrados.textContent = filtrados;
      kpiClientesConObras.textContent = clientesConObras;
      kpiClientes2N.textContent = clientes2N;
    }

    function renderTablaClientes(lista) {
      clientesTableBody.innerHTML = "";

      if (!lista.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="8" style="text-align:center;font-size:11px;color:#6B7280;padding:12px;">No hay clientes con estos filtros.</td>`;
        clientesTableBody.appendChild(tr);
        return;
      }

      const mapaObras = {};
      proyectos.forEach(p => {
        const key = norm(p.cliente_principal || "");
        if (!key) return;
        mapaObras[key] = (mapaObras[key] || 0) + 1;
      });

      lista.forEach(c => {
        const obras = mapaObras[norm(c.nombre)] || 0;
        const trabaja2n = c.trabaja_con_2n === true;

        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>
            <button
              type="button"
              class="btn-icon"
              data-cli-id="${c.id}"
              title="Ver detalle"
            >
              üëÅÔ∏è
            </button>
          </td>
          <td>${c.nombre || ""}</td>
          <td>${c.ciudad || ""}</td>
          <td>${c.provincia || ""}</td>
          <td>${c.telefono || ""}</td>
          <td>
            ${
              c.web
                ? `<a href="${c.web.startsWith("http") ? c.web : "https://" + c.web}"
                       target="_blank"
                       rel="noopener noreferrer"
                       style="font-size:11px;color:#2563EB;text-decoration:underline;">
                     Web
                   </a>`
                : "‚Äî"
            }
          </td>
          <td>
            ${
              trabaja2n
                ? '<span class="badge badge-success">2N</span>'
                : '‚Äî'
            }
          </td>
          <td>${obras}</td>
        `;

        tr.querySelector(".btn-icon").addEventListener("click", () => {
          abrirDetalleCliente(c);
        });

        clientesTableBody.appendChild(tr);
      });
    }

    function abrirDetalleCliente(c) {
      cliNombre.textContent = c.nombre || "";
      cliTipo.textContent = c.tipo || "";
      cliSegmento.textContent = c.segmento || "";
      cliCiudad.textContent = c.ciudad || "";
      cliProvincia.textContent = c.provincia || "";
      cliContacto.textContent = c.contacto || c.telefono || "";
      cliWeb.innerHTML = c.web
        ? `<a href="${c.web.startsWith("http") ? c.web : "https://" + c.web}"
                 target="_blank"
                 rel="noopener noreferrer"
                 style="color:#2563EB;text-decoration:underline;">${c.web}</a>`
        : "‚Äî";
      cliNotas.textContent = c.notas || "";

      clienteDialog.showModal();
    }

    function renderTopClientes() {
      topClientesLista.innerHTML = "";

      const mapaObras = {};
      proyectos.forEach(p => {
        const key = norm(p.cliente_principal || "");
        if (!key) return;
        mapaObras[key] = (mapaObras[key] || 0) + 1;
      });

      const listaConObras = clientes
        .map(c => ({
          ...c,
          obras: mapaObras[norm(c.nombre)] || 0
        }))
        .filter(c => c.obras > 0)
        .sort((a, b) => b.obras - a.obras)
        .slice(0, 15);

      if (!listaConObras.length) {
        const div = document.createElement("div");
        div.className = "empty-state";
        div.textContent = "A√∫n no hay obras vinculadas a clientes.";
        topClientesLista.appendChild(div);
        return;
      }

      const maxObras = listaConObras[0].obras || 1;

      listaConObras.forEach(c => {
        const pct = Math.round((c.obras * 100) / maxObras);

        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.flexDirection = "column";
        row.style.gap = "2px";

        row.innerHTML = `
          <div style="display:flex;justify-content:space-between;font-size:11px;">
            <span>${c.nombre}</span>
            <span>${c.obras} obras</span>
          </div>
          <div style="width:100%;height:6px;border-radius:999px;background:#E5E7EB;overflow:hidden;">
            <div style="width:${pct}%;height:100%;background:#4F46E5;"></div>
          </div>
        `;

        topClientesLista.appendChild(row);
      });
    }

    // ========= IMPORTACI√ìN CSV/XLSX =========

    async function importarCSVClientes(file, existingKeys) {
      const text = await file.text();
      const rows = text
        .split(/\r?\n/)
        .map(r => r.trim())
        .filter(Boolean);

      if (!rows.length) return { a: 0, s: 0 };

      const headers = rows[0].split(";").map(h => h.trim());
      const idxNombre =
        headers.findIndex(h => h.toLowerCase().includes("cliente")) >= 0
          ? headers.findIndex(h => h.toLowerCase().includes("cliente"))
          : headers.findIndex(h => h.toLowerCase().includes("nombre"));

      if (idxNombre === -1) {
        alert("No se ha encontrado ninguna columna de 'Cliente' o 'Nombre' en el CSV.");
        return { a: 0, s: 0 };
      }

      let added = 0, skipped = 0;
      const ownerId = auth.currentUser ? auth.currentUser.uid : null;

      for (let i = 1; i < rows.length; i++) {
        const cols = rows[i].split(";");

        const rowObj = {};
        headers.forEach((h, idx) => {
          rowObj[h] = cols[idx] || "";
        });

        const payload = mapRowClientes(rowObj, "scouting_csv");
        if (!payload) continue;

        const key = buildClienteKey(payload);
        if (existingKeys.has(key)) {
          skipped++;
          continue;
        }

        const ref = await addDoc(collection(db, "clientes"), {
          ...payload,
          ownerId: ownerId || ""
        });
        clientes.push({ id: ref.id, ...payload, ownerId: ownerId || "" });
        existingKeys.add(key);
        added++;
      }

      return { a: added, s: skipped };
    }

    /*  ======= FUNCI√ìN MODIFICADA: IMPORTAR XLSX CLIENTES =======  */
    async function importarXLSXClientes(file, existingKeys) {
      if (typeof XLSX === "undefined") {
        alert("La librer√≠a de Excel (XLSX) no se ha cargado. Exporta como CSV e imp√≥rtalo.");
        return { a: 0, s: 0 };
      }

      const data = await file.arrayBuffer();

      // Leer el Excel de forma segura
      const workbook = XLSX.read(data, { type: "array" });

      if (!workbook || !workbook.SheetNames || !workbook.SheetNames.length) {
        alert("El Excel no contiene hojas v√°lidas. Revisa el archivo.");
        return { a: 0, s: 0 };
      }

      // Buscar primero una hoja que contenga 'cliente' en el nombre, si no la primera
      const sheetName =
        workbook.SheetNames.find((n) => n.toLowerCase().includes("cliente")) ||
        workbook.SheetNames[0];

      const sheet = workbook.Sheets[sheetName];
      if (!sheet) {
        alert("No se ha encontrado una hoja v√°lida (por ejemplo 'Clientes').");
        return { a: 0, s: 0 };
      }

      const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });

      let added = 0,
        skipped = 0;
      const ownerId = auth.currentUser ? auth.currentUser.uid : null;

      for (const row of json) {
        const payload = mapRowClientes(row, "scouting_excel");
        if (!payload) continue;

        const key = buildClienteKey(payload);
        if (existingKeys.has(key)) {
          skipped++;
          continue;
        }

        const ref = await addDoc(collection(db, "clientes"), {
          ...payload,
          ownerId: ownerId || "",
        });
        clientes.push({ id: ref.id, ...payload, ownerId: ownerId || "" });
        existingKeys.add(key);
        added++;
      }

      return { a: added, s: skipped };
    }

    // ======= EVENTOS FILTROS =======
    fZonaCliente.addEventListener("change", aplicarFiltrosClientes);
    fTipoCliente.addEventListener("change", aplicarFiltrosClientes);
    fSegmentoCliente.addEventListener("change", aplicarFiltrosClientes);
    fTextoCliente.addEventListener("input", aplicarFiltrosClientes);

    // IMPORTACI√ìN
    btnImportClientes.addEventListener("click", async () => {
      const file = fileImportClientes.files[0];
      if (!file) {
        alert("Selecciona un archivo CSV o XLSX para importar.");
        return;
      }

      const existingKeys = new Set(clientes.map(c => buildClienteKey(c)));

      try {
        let result = { a: 0, s: 0 };

        if (file.name.toLowerCase().endsWith(".csv")) {
          result = await importarCSVClientes(file, existingKeys);
        } else {
          result = await importarXLSXClientes(file, existingKeys);
        }

        alert(`Importaci√≥n finalizada. A√±adidos: ${result.a}, duplicados omitidos: ${result.s}.`);
        actualizarFiltrosClientes();
        aplicarFiltrosClientes();
        renderTopClientes();
      } catch (err) {
        console.error("Error durante la importaci√≥n:", err);
        alert("Error durante la importaci√≥n: " + err.message);
      }
    });

    // ARRANQUE (se hace despu√©s de login en auth.js)
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        location.href = "login.html";
        return;
      }
      cargarClientesYProyectos();
    });
  </script>

  <!-- Guardia de autenticaci√≥n -->
  <script type="module" src="auth.js"></script>
</body>
</html>
