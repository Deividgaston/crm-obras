<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM 2N ‚Äì Clientes</title>
  <link rel="stylesheet" href="style.css" />
  
  <!-- Librer√≠a para importar Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
  <!-- NAV SUPERIOR -->
  <div class="topnav">
    <div class="logo">CRM 2N</div>

    <div class="nav-tabs">
      <div class="nav-item" onclick="location.href='index.html'">Dashboard</div>
      <div class="nav-item" onclick="location.href='proyectos.html'">Proyectos</div>
      <div class="nav-item" onclick="location.href='buscar.html'">Buscar</div>
      <div class="nav-item" onclick="location.href='pipeline.html'">Pipeline</div>
      <div class="nav-item active" onclick="location.href='clientes.html'">Clientes</div>
      <div class="nav-item" onclick="location.href='tareas.html'">Tareas</div>
      <div class="nav-item" onclick="location.href='reportes.html'">Reportes</div>
    </div>

    <input type="text" class="search-box" placeholder="(Solo UI) Buscar..." />
  </div>

  <main class="content">
    <h2 style="margin-top:0;margin-bottom:4px;color:#16325C;">Clientes</h2>
    <div style="font-size:12px;color:#5A6872;margin-bottom:10px;">
      Mapa de promotoras, arquitecturas, ingenier√≠as, fondos, integradores, etc. vinculados a tus obras.
    </div>

    <!-- FILTROS Y ACCIONES -->
    <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px;">

      <!-- Filtro zona -->
      <select id="fZonaCliente" class="select-input" style="max-width:180px;">
        <option value="Todas">Zonas: todas</option>
      </select>

      <!-- Filtro tipo -->
      <select id="fTipoCliente" class="select-input" style="max-width:180px;">
        <option value="Todos">Tipo: todos</option>
        <option value="Promotora">Promotora</option>
        <option value="Arquitectura">Arquitectura</option>
        <option value="Ingenier√≠a">Ingenier√≠a</option>
        <option value="Fondo / SOCIMI">Fondo / SOCIMI</option>
        <option value="Integrador / Instalador">Integrador / Instalador</option>
        <option value="Property / Gestor">Property / Gestor</option>
        <option value="Otro">Otro</option>
      </select>

      <!-- Filtro segmento -->
      <select id="fSegmentoCliente" class="select-input" style="max-width:200px;">
        <option value="Todos">Segmento: todos</option>
        <option value="Residencial">Residencial</option>
        <option value="Terciario">Terciario</option>
        <option value="Seguridad / CCTV">Seguridad / CCTV</option>
        <option value="Telecom / IT">Telecom / IT</option>
        <option value="Mixto">Mixto</option>
      </select>

      <!-- Filtro texto -->
      <input id="fTextoCliente" class="search-input" style="max-width:240px;" placeholder="Buscar por nombre / ciudad..." />

      <div style="flex:1;"></div>

      <!-- BOT√ìN scouting -->
      <button id="btnOpenScoutingClientes" class="btn-icon" title="Scouting / b√∫squeda avanzada de clientes">
        üîé
      </button>

      <!-- BOT√ìN importar -->
      <button id="btnImportarClientes" class="btn-secondary" type="button" style="font-size:11px;padding:4px 10px;">
        üì• Importar clientes
      </button>
      <input type="file" id="inputImportClientes" accept=".csv, .xlsx" style="display:none;" />

      <!-- Bot√≥n nuevo -->
      <button id="btnNuevoCliente" class="btn-secondary" type="button" style="font-size:11px;padding:4px 10px;">
        + Nuevo cliente
      </button>

    </div>

    <!-- TABLA + GRAFICO -->
    <div style="display:grid;grid-template-columns:minmax(0,1.5fr) minmax(0,1fr);gap:12px;margin-bottom:12px;">

      <!-- TABLA -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
          <div style="font-size:12px;font-weight:600;color:#111827;">Clientes y obras vinculadas</div>
        </div>
        <div id="clientesTableWrapper"></div>
        <div id="clientesEmpty" class="empty-state" style="display:none;">
          No hay clientes con los filtros seleccionados.
        </div>
      </div>

      <!-- GRAFICO -->
      <div class="card">
        <div style="font-size:12px;font-weight:600;margin-bottom:6px;">TOP clientes por n¬∫ de obras</div>
        <div id="graficoClientes"></div>
      </div>
    </div>
  </main>

  <!-- DIALOG: NUEVO CLIENTE -->
  <dialog id="clienteDialog">
    <div class="modal-header">Nuevo cliente r√°pido</div>
    <form id="clienteForm" method="dialog">
      <div class="form-grid">

        <div class="form-group">
          <label for="cliNombre">Nombre</label>
          <input id="cliNombre" required />
        </div>

        <div class="form-group">
          <label for="cliTipo">Tipo</label>
          <select id="cliTipo">
            <option>Promotora</option>
            <option>Arquitectura</option>
            <option>Ingenier√≠a</option>
            <option>Fondo / SOCIMI</option>
            <option>Integrador / Instalador</option>
            <option>Property / Gestor</option>
            <option>Otro</option>
          </select>
        </div>

        <div class="form-group">
          <label for="cliSegmento">Segmento</label>
          <select id="cliSegmento">
            <option>Residencial</option>
            <option>Terciario</option>
            <option>Seguridad / CCTV</option>
            <option>Telecom / IT</option>
            <option>Mixto</option>
          </select>
        </div>

        <div class="form-group">
          <label for="cliCiudad">Ciudad</label>
          <input id="cliCiudad" />
        </div>

        <div class="form-group">
          <label for="cliProvincia">Provincia</label>
          <input id="cliProvincia" />
        </div>

        <div class="form-group">
          <label for="cliTelefono">Tel√©fono</label>
          <input id="cliTelefono" />
        </div>

        <div class="form-group">
          <label for="cliWeb">Web</label>
          <input id="cliWeb" placeholder="https://..." />
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="clienteDialog.close()">Cancelar</button>
        <button class="btn-primary" type="submit">Guardar</button>
      </div>
    </form>
  </dialog>

  <!-- DIALOG SCOUTING -->
  <dialog id="scoutingClientesDialog" style="max-width:900px;width:95%;">
    <div class="modal-header" style="display:flex;justify-content:space-between;">
      <span>üõ∞Ô∏è Scouting ¬∑ Buscar clientes</span>
      <button type="button" class="btn-icon" onclick="scoutingClientesDialog.close()">‚úñ</button>
    </div>

    <!-- BLOQUE scouting entero -->
    <div class="card" style="margin-top:4px;box-shadow:none;border:none;padding:0;">
      <div style="display:flex;justify-content:space-between;align-items-center;margin-bottom:8px;">
        <div>
          <div style="font-size:12px;font-weight:600;color:#111827;">Generador de prompt</div>
          <div style="font-size:10.5px;color:#6B7280;">
            Genera un prompt profundo para identificar clientes clave para 2N.
          </div>
        </div>
        <button id="btnCopiarPromptClientes" class="btn-secondary" style="font-size:11px;padding:4px 10px;">
          Copiar prompt
        </button>
      </div>

      <!-- Configuraci√≥n -->
      <div style="display:grid;grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);gap:12px;margin-bottom:10px;">
        <div style="display:flex;flex-direction:column;gap:8px;">

          <div class="form-group">
            <label>üìç Zonas objetivo</label>
            <input id="cliZonas" placeholder="Ej: Madrid, M√°laga, Barcelona, Lisboa" />
          </div>

          <div class="form-group">
            <label>üè¢ Tipo de cliente</label>
            <div style="display:flex;flex-wrap:wrap;gap:6px;font-size:11px;">
              <label class="chip"><input type="checkbox" class="chk-cli-tipo" value="promotoras"> Promotoras</label>
              <label class="chip"><input type="checkbox" class="chk-cli-tipo" value="arquitecturas"> Arquitecturas</label>
              <label class="chip"><input type="checkbox" class="chk-cli-tipo" value="ingenierias"> Ingenier√≠as</label>
              <label class="chip"><input type="checkbox" class="chk-cli-tipo" value="fondos"> Fondos / SOCIMIs</label>
              <label class="chip"><input type="checkbox" class="chk-cli-tipo" value="integradores"> Integradores</label>
              <label class="chip"><input type="checkbox" class="chk-cli-tipo" value="property"> Property</label>
            </div>
          </div>

          <div class="form-group">
            <label>üèóÔ∏è Segmento</label>
            <div style="display:flex;flex-wrap:wrap;gap:6px;font-size:11px;">
              <label class="chip"><input type="checkbox" class="chk-cli-seg" value="Residencial"> Residencial</label>
              <label class="chip"><input type="checkbox" class="chk-cli-seg" value="Terciario"> Terciario</label>
              <label class="chip"><input type="checkbox" class="chk-cli-seg" value="Seguridad / CCTV"> Seguridad</label>
              <label class="chip"><input type="checkbox" class="chk-cli-seg" value="Telecom / IT"> Telecom</label>
              <label class="chip"><input type="checkbox" class="chk-cli-seg" value="Mixto"> Mixto</label>
            </div>
          </div>

        </div>

        <div style="display:flex;flex-direction:column;gap:8px;">
          <div class="form-group">
            <label>üí∂ Perfil / ticket</label>
            <input id="cliTicket" placeholder="Ej: proyectos > 3M‚Ç¨" />
          </div>

          <div class="form-group">
            <label>üîç Notas adicionales</label>
            <textarea id="cliNotas" rows="4"></textarea>
          </div>
        </div>
      </div>

      <textarea id="promptClientes" rows="15"
        style="width:100%;border-radius:8px;border:1px solid #D1D5DB;padding:8px;font-family:monospace;font-size:12px;"></textarea>
    </div>
  </dialog>

  <!-- ====================== -->
  <!-- SCRIPT PRINCIPAL -->
  <!-- ====================== -->
  <script type="module">
    import { db } from "./firebase.js";
    import { collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";


    /* ====================================================
           ESTADO
    ==================================================== */
    let clientes = [];
    let proyectos = [];
    let clientesView = [];

    const fZonaCliente = document.getElementById("fZonaCliente");
    const fTipoCliente = document.getElementById("fTipoCliente");
    const fSegmentoCliente = document.getElementById("fSegmentoCliente");
    const fTextoCliente = document.getElementById("fTextoCliente");

    const clientesTableWrapper = document.getElementById("clientesTableWrapper");
    const clientesEmpty = document.getElementById("clientesEmpty");
    const graficoClientes = document.getElementById("graficoClientes");

    const scoutingDialog = document.getElementById("scoutingClientesDialog");
    document.getElementById("btnOpenScoutingClientes").onclick = () => scoutingDialog.showModal();



    /* ====================================================
           CARGAR CLIENTES Y PROYECTOS (1 sola lectura)
    ==================================================== */
    async function cargarClientesYProyectos() {
      const [cliSnap, proySnap] = await Promise.all([
        getDocs(collection(db, "clientes")),
        getDocs(collection(db, "proyectos"))
      ]);

      clientes = cliSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      proyectos = proySnap.docs.map(d => ({ id: d.id, ...d.data() }));

      recalcularVinculaciones();
      inicializarFiltroZonasClientes();
      aplicarFiltrosClientes();
    }


    /* ====================================================
           RELACIONAR CLIENTES ‚Üî PROYECTOS
    ==================================================== */
    function normalizar(txt) {
      return (txt || "").trim().toLowerCase();
    }

    function contarObras(cliente) {
      const target = normalizar(cliente);
      return proyectos.filter(p => (
        normalizar(p.cliente_principal) === target ||
        normalizar(p.promotora) === target ||
        normalizar(p.constructora) === target ||
        normalizar(p.arquitectura) === target ||
        normalizar(p.ingenieria) === target
      )).length;
    }

    function recalcularVinculaciones() {
      clientesView = clientes.map(c => ({
        ...c,
        nombre_display: c.nombre || c.nombre_cliente,
        num_obras: contarObras(c.nombre || c.nombre_cliente)
      }));
    }

    function inicializarFiltroZonasClientes() {
      const zonas = new Set();

      clientesView.forEach(c => {
        if (c.ciudad) zonas.add(c.ciudad);
        if (c.provincia) zonas.add(c.provincia);
      });

      fZonaCliente.innerHTML = `<option value="Todas">Zonas: todas</option>` +
        [...zonas].sort().map(z => `<option>${z}</option>`).join("");
    }


    /* ====================================================
           FILTROS
    ==================================================== */
    function aplicarFiltrosClientes() {
      const zona = fZonaCliente.value;
      const tipo = fTipoCliente.value;
      const seg = fSegmentoCliente.value;
      const txt = normalizar(fTextoCliente.value);

      let lista = clientesView.filter(c => {
        let ok = true;

        if (zona !== "Todas")
          ok = ok && (c.ciudad === zona || c.provincia === zona);

        if (tipo !== "Todos")
          ok = ok && (c.tipo === tipo);

        if (seg !== "Todos")
          ok = ok && (c.segmento === seg);

        if (txt)
          ok = ok && (
            normalizar(c.nombre_display).includes(txt) ||
            normalizar(c.ciudad).includes(txt) ||
            normalizar(c.provincia).includes(txt)
          );

        return ok;
      });

      lista.sort((a,b) => b.num_obras - a.num_obras);
      renderTabla(lista);
      renderGrafico(lista);
    }


    /* ====================================================
           TABLA CLIENTES
    ==================================================== */
    function renderWeb(url) {
      if (!url) return "";
      const href = url.startsWith("http") ? url : `https://${url}`;
      return `<a href="${href}" target="_blank">üîó</a>`;
    }

    function renderTabla(lista) {
      if (!lista.length) {
        clientesTableWrapper.innerHTML = "";
        clientesEmpty.style.display = "block";
        return;
      }
      clientesEmpty.style.display = "none";

      let html = `
      <table>
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Tipo</th>
            <th>Segmento</th>
            <th>Ciudad</th>
            <th>Provincia</th>
            <th>Tel√©fono</th>
            <th>Web</th>
            <th>Obras</th>
          </tr>
        </thead>
        <tbody>
      `;

      lista.forEach(c => {
        html += `
        <tr>
          <td>${c.nombre_display}</td>
          <td>${c.tipo || ""}</td>
          <td>${c.segmento || ""}</td>
          <td>${c.ciudad || ""}</td>
          <td>${c.provincia || ""}</td>
          <td>${c.telefono || ""}</td>
          <td>${renderWeb(c.web)}</td>
          <td>${c.num_obras}</td>
        </tr>`;
      });

      html += "</tbody></table>";
      clientesTableWrapper.innerHTML = html;
    }


    /* ====================================================
           GRAFICO CLIENTES
    ==================================================== */
    function renderGrafico(lista) {
      if (!lista.length) {
        graficoClientes.innerHTML = "<small>Sin datos</small>";
        return;
      }

      const top = lista.slice(0, 8);
      const max = Math.max(...top.map(c => c.num_obras));

      graficoClientes.innerHTML = top.map(c => {
        const pct = (c.num_obras / max) * 100;
        return `
          <div>
            <div style="display:flex;justify-content:space-between;font-size:11px;">
              <span>${c.nombre_display}</span>
              <span>${c.num_obras}</span>
            </div>
            <div style="background:#E5E7EB;width:100%;height:8px;border-radius:999px;overflow:hidden;">
              <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,#4F46E5,#22C55E);"></div>
            </div>
          </div>
        `;
      }).join("");
    }


    /* ====================================================
           NUEVO CLIENTE (DIALOG)
    ==================================================== */
    const clienteDialog = document.getElementById("clienteDialog");
    document.getElementById("btnNuevoCliente").onclick = () => clienteDialog.showModal();

    clienteForm.onsubmit = async (e) => {
      e.preventDefault();

      const payload = {
        nombre: cliNombre.value.trim(),
        tipo: cliTipo.value,
        segmento: cliSegmento.value,
        ciudad: cliCiudad.value.trim(),
        provincia: cliProvincia.value.trim(),
        telefono: cliTelefono.value.trim(),
        web: cliWeb.value.trim(),
        fuente: "manual"
      };

      await addDoc(collection(db, "clientes"), payload);
      clienteDialog.close();
      cargarClientesYProyectos();
    };


    /* ====================================================
           SCOUTING: GENERADOR DE PROMPT
    ==================================================== */
    const cliZonas = document.getElementById("cliZonas");
    const cliTicket = document.getElementById("cliTicket");
    const cliNotas = document.getElementById("cliNotas");
    const promptClientes = document.getElementById("promptClientes");

    const chkCliTipo = document.querySelectorAll(".chk-cli-tipo");
    const chkCliSeg = document.querySelectorAll(".chk-cli-seg");

    function getChecked(nl) {
      return [...nl].filter(x => x.checked).map(x => x.value);
    }

    function generarPromptClientes() {
      const zonas = cliZonas.value.trim();
      const tipos = getChecked(chkCliTipo);
      const segs = getChecked(chkCliSeg);
      const ticket = cliTicket.value.trim();
      const notas = cliNotas.value.trim();

      const p = [];

      p.push("Act√∫a como un analista s√©nior para identificar CLIENTES CLAVE para soluciones 2N.");
      p.push("Usa modo INVESTIGACI√ìN PROFUNDA y busca en webs, notas de prensa, LinkedIn, bases profesionales, etc.");

      if (zonas)
        p.push(`Zonas objetivo: ${zonas}`);

      if (tipos.length)
        p.push(`Tipos de cliente: ${tipos.join(", ")}`);

      if (segs.length)
        p.push(`Segmentos: ${segs.join(", ")}`);

      if (ticket)
        p.push(`Perfil de ticket/proyectos t√≠pico del cliente: ${ticket}`);

      if (notas)
        p.push(`Notas adicionales: ${notas}`);

      p.push("Genera EXCEL 'clientes_2n.xlsx' o CSV si no es posible.");
      p.push("Columnas EXACTAS:");
      p.push("nombre_cliente, tipo_cliente, segmento_principal, telefono, email, persona_contacto, cargo_contacto, telefono_contacto, email_contacto, web, direccion, ciudad, provincia, pais, linkedin_empresa, linkedin_contacto, proyectos_relevantes_resumen, volumen_estimado_proyectos, encaje_2n_cliente, motivo_encaje_2n, fuente_principal");

      promptClientes.value = p.join("\n\n");
    }

    generarPromptClientes();

    [cliZonas, cliTicket, cliNotas].forEach(el =>
      el.addEventListener("input", generarPromptClientes)
    );

    [...chkCliTipo, ...chkCliSeg].forEach(ch =>
      ch.addEventListener("change", generarPromptClientes)
    );

    document.getElementById("btnCopiarPromptClientes").onclick = async () => {
      await navigator.clipboard.writeText(promptClientes.value);
      alert("Prompt copiado");
    };


    /* ====================================================
           IMPORTAR CLIENTES (CSV / XLSX)
    ==================================================== */
    const inputImportClientes = document.getElementById("inputImportClientes");
    const btnImportarClientes = document.getElementById("btnImportarClientes");

    btnImportarClientes.addEventListener("click", () => inputImportClientes.click());

    inputImportClientes.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const ext = file.name.split(".").pop().toLowerCase();

      if (ext === "csv") await importarCSVClientes(file);
      else if (ext === "xlsx") await importarXLSXClientes(file);
      else return alert("Formato no v√°lido. Usa CSV o XLSX.");

      await cargarClientesYProyectos();
      alert("Clientes importados correctamente.");
    });


    async function importarCSVClientes(file) {
      const text = await file.text();
      const lines = text.split("\n").map(l => l.trim()).filter(l => l);

      const headers = lines[0].split(";");

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(";");
        const doc = {};

        headers.forEach((h, idx) => doc[h] = values[idx] || "");
        doc["fuente"] = "scouting_csv";

        await addDoc(collection(db, "clientes"), doc);
      }
    }

    async function importarXLSXClientes(file) {
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data);
      const sheet = workbook.Sheets["Clientes"] || workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });

      for (const row of json) {
        const doc = { ...row, fuente: "scouting_excel" };
        await addDoc(collection(db, "clientes"), doc);
      }
    }


    /* ====================================================
           EVENTOS FILTRO
    ==================================================== */
    fZonaCliente.onchange = aplicarFiltrosClientes;
    fTipoCliente.onchange = aplicarFiltrosClientes;
    fSegmentoCliente.onchange = aplicarFiltrosClientes;
    fTextoCliente.oninput = aplicarFiltrosClientes;


    /* ====================================================
           ARRANQUE
    ==================================================== */
    cargarClientesYProyectos();

  </script>
</body>
</html>
