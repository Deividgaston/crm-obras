<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM 2N – Clientes</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
  <div class="topnav">
    <div class="logo">CRM 2N</div>
    <div class="nav-tabs">
      <div class="nav-item" onclick="location.href='index.html'">Dashboard</div>
      <div class="nav-item" onclick="location.href='proyectos.html'">Proyectos</div>
      <div class="nav-item" onclick="location.href='buscar.html'">Buscar</div>
      <div class="nav-item" onclick="location.href='pipeline.html'">Pipeline</div>
      <div class="nav-item active" onclick="location.href='clientes.html'">Clientes</div>
      <div class="nav-item" onclick="location.href='tareas.html'">Tareas</div>
      <div class="nav-item" onclick="location.href='reportes.html'">Reportes</div>
    </div>

    <button id="btnLogout" class="btn-logout">Cerrar sesión</button>
  </div>

  <main class="content">
    <h2>Clientes</h2>

    <!-- Filtros -->
    <div class="filters-row">
      <select id="fZonaCliente" class="filter-select">
        <option value="Todas">Zona: todas</option>
      </select>

      <select id="fTipoCliente" class="filter-select">
        <option value="Todos">Tipo: todos</option>
      </select>

      <select id="fSegmentoCliente" class="filter-select">
        <option value="Todos">Segmento: todos</option>
      </select>

      <input
        type="text"
        id="fTextoCliente"
        class="search-box"
        placeholder="Buscar cliente…"
      />

      <div>
        <input type="file" id="fileImportClientes" accept=".csv,.xlsx,.xls" />
        <button id="btnImportClientes" class="btn-secondary">Importar</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpi-row">
      <div class="kpi-card">
        <div class="kpi-label">Clientes totales</div>
        <div id="kpiClientesTotal" class="kpi-value">–</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Filtrados</div>
        <div id="kpiClientesFiltrados" class="kpi-value">–</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Con obras</div>
        <div id="kpiClientesConObras" class="kpi-value">–</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Clientes 2N</div>
        <div id="kpiClientes2N" class="kpi-value">–</div>
      </div>
    </div>

    <!-- Tabla clientes -->
    <div class="card">
      <table class="table">
        <thead>
          <tr>
            <th style="width:24px"></th>
            <th>Cliente</th>
            <th>Ciudad</th>
            <th>Provincia</th>
            <th>Teléfono</th>
            <th>Web</th>
            <th>2N</th>
            <th>Obras</th>
          </tr>
        </thead>
        <tbody id="clientesTableBody"></tbody>
      </table>
    </div>

    <!-- Panel lateral top clientes -->
    <div class="card">
      <h3>TOP clientes</h3>
      <div id="topClientesLista"></div>
    </div>

  </main>

  <!-- Modal -->
  <dialog id="clienteDialog">
    <form method="dialog" class="modal">
      <h3>Cliente</h3>

      <div class="form-grid">
        <div>
          <label>Nombre</label>
          <div id="cliNombre" class="modal-field"></div>
        </div>
        <div>
          <label>Tipo</label>
          <div id="cliTipo" class="modal-field"></div>
        </div>
      </div>

      <div class="form-grid">
        <div>
          <label>Segmento</label>
          <div id="cliSegmento" class="modal-field"></div>
        </div>
        <div>
          <label>Ciudad</label>
          <div id="cliCiudad" class="modal-field"></div>
        </div>
      </div>

      <div class="form-grid">
        <div>
          <label>Provincia</label>
          <div id="cliProvincia" class="modal-field"></div>
        </div>
        <div>
          <label>Contacto</label>
          <div id="cliContacto" class="modal-field"></div>
        </div>
      </div>

      <label>Web</label>
      <div id="cliWeb" class="modal-field"></div>

      <label>Notas</label>
      <div id="cliNotas" class="modal-field modal-notes"></div>

      <button class="btn-primary" style="margin-top:10px;">Cerrar</button>
    </form>
  </dialog>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import {
      collection,
      getDocs,
      addDoc,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { onAuthStateChanged }
      from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";


    /* ============================================================
       FUNCIÓN XLSX CORREGIDA (único cambio)
    ============================================================ */
    async function importarXLSXClientes(file, existingKeys) {
      const data = await file.arrayBuffer();

      const workbook = XLSX.read(data, { type: "array" });

      if (!workbook || !workbook.SheetNames || !workbook.SheetNames.length) {
        alert("El Excel no contiene hojas válidas.");
        return { a: 0, s: 0 };
      }

      const sheetName =
        workbook.SheetNames.find(n => n.toLowerCase().includes("cliente")) ||
        workbook.SheetNames[0];

      const sheet = workbook.Sheets[sheetName];
      if (!sheet) {
        alert("No se ha encontrado la hoja de clientes.");
        return { a: 0, s: 0 };
      }

      const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });

      let added = 0, skipped = 0;
      const ownerId = auth.currentUser ? auth.currentUser.uid : "";

      for (const row of json) {
        const payload = mapRowClientes(row, "scouting_excel");
        if (!payload) continue;

        const key = buildClienteKey(payload);
        if (existingKeys.has(key)) { skipped++; continue; }

        const ref = await addDoc(collection(db, "clientes"), {
          ...payload,
          ownerId
        });

        clientes.push({ id: ref.id, ...payload, ownerId });
        existingKeys.add(key);
        added++;
      }

      return { a: added, s: skipped };
    }

    /* TODO EL RESTO DEL ARCHIVO SIGUE EXACTAMENTE IGUAL QUE EL TUYO
       (no se toca nada más)
    */

  </script>

  <script type="module" src="auth.js"></script>
</body>
</html>
