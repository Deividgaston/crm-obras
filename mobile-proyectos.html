<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM 2N ‚Äì Proyectos (M√≥vil)</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="mobile.css" />
</head>

<body>
  <div class="topnav">
    <div class="logo">CRM 2N ¬∑ Proyectos (M√≥vil)</div>
    <div style="display:flex;align-items:center;gap:6px;">
      <span id="mobileUserEmail" style="font-size:11px;color:#475569;"></span>
      <button id="btnLogout"
        style="font-size:11px;padding:4px 8px;border-radius:999px;
               border:1px solid #E5E7EB;background:#FFFFFF;color:#111827;">
        Salir
      </button>
    </div>
  </div>

  <main class="content">
    <div class="mobile-shell">
      <div class="mobile-title">Proyectos</div>
      <div class="mobile-subtitle">
        Vista de solo lectura para consultar obras, estados y encaje 2N.
      </div>

      <input
        id="searchMobileProyectos"
        type="text"
        class="search-input-mobile"
        placeholder="Buscar por obra, cliente, ciudad..."
      />

      <div class="mobile-filters-row">
        <select id="fEstadoMobile" class="mobile-select">
          <option value="Todos">Estado: todos</option>
        </select>
        <select id="fProvinciaMobile" class="mobile-select">
          <option value="Todas">Provincia: todas</option>
        </select>
        <select id="fEncajeMobile" class="mobile-select">
          <option value="Todos">Encaje 2N: todos</option>
          <option value="ALTO">ALTO</option>
          <option value="MEDIO">MEDIO</option>
          <option value="BAJO">BAJO</option>
          <option value="SIN">Sin dato</option>
        </select>
      </div>

      <div class="mobile-kpis">
        <div class="mobile-kpi">
          <div class="mobile-kpi-label">Proyectos filtrados</div>
          <div id="kpiProyFiltrados" class="mobile-kpi-value">‚Äì</div>
          <div class="mobile-kpi-footnote">Seg√∫n filtros y b√∫squeda.</div>
        </div>
        <div class="mobile-kpi">
          <div class="mobile-kpi-label">Encaje ALTO / MEDIO</div>
          <div id="kpiProyEncaje" class="mobile-kpi-value">‚Äì</div>
          <div class="mobile-kpi-footnote">Obras donde 2N encaja bien.</div>
        </div>
      </div>

      <section class="mobile-section">
        <div class="mobile-section-title">Listado de proyectos</div>
        <div class="mobile-section-sub" id="textoResumenProyectos">
          Cargando proyectos...
        </div>
        <div id="listaProyectosMobile" class="mobile-list"></div>
      </section>
    </div>
  </main>

  <div class="mobile-bottombar">
    <div class="mobile-nav-item" onclick="location.href='mobile-index.html'">
      <span>üè†</span>Inicio
    </div>
    <div class="mobile-nav-item active" onclick="location.href='mobile-proyectos.html'">
      <span>üèóÔ∏è</span>Proyectos
    </div>
    <div class="mobile-nav-item" onclick="location.href='mobile-tareas.html'">
      <span>‚úÖ</span>Tareas
    </div>
    <div class="mobile-nav-item" onclick="location.href='mobile-clientes.html'">
      <span>üë•</span>Clientes
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import { collection, getDocs }
      from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { onAuthStateChanged }
      from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const userEmailSpan   = document.getElementById("mobileUserEmail");
    const searchInput     = document.getElementById("searchMobileProyectos");
    const selectEstado    = document.getElementById("fEstadoMobile");
    const selectProvincia = document.getElementById("fProvinciaMobile");
    const selectEncaje    = document.getElementById("fEncajeMobile");

    const kpiProyFiltrados = document.getElementById("kpiProyFiltrados");
    const kpiProyEncaje    = document.getElementById("kpiProyEncaje");
    const listaProyectos   = document.getElementById("listaProyectosMobile");
    const textoResumen     = document.getElementById("textoResumenProyectos");

    let proyectos = [];
    let filtroTexto = "";

    function norm(t){
      return (t||"").toString().normalize("NFD")
        .replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();
    }
    function ms(v){
      if(!v) return 0;
      try{ return v.toMillis ? v.toMillis() : new Date(v).getTime(); }
      catch{ return 0; }
    }

    async function cargarProyectos(){
      try{
        const snap = await getDocs(collection(db,"proyectos"));
        proyectos = snap.docs.map(d=>({id:d.id,...d.data()}));
        inicializarFiltros();
        aplicarFiltrosYRender();
      }catch(e){
        console.error(e);
        textoResumen.textContent = "Error cargando proyectos.";
      }
    }

    function inicializarFiltros(){
      const estados   = new Set();
      const provincias= new Set();
      proyectos.forEach(p=>{
        if(p.estado) estados.add(p.estado);
        if(p.provincia) provincias.add(p.provincia);
      });

      selectEstado.innerHTML =
        '<option value="Todos">Estado: todos</option>' +
        [...estados].sort((a,b)=>a.localeCompare(b,"es"))
          .map(e=>`<option value="${e}">${e}</option>`).join("");

      selectProvincia.innerHTML =
        '<option value="Todas">Provincia: todas</option>' +
        [...provincias].sort((a,b)=>a.localeCompare(b,"es"))
          .map(p=>`<option value="${p}">${p}</option>`).join("");
    }

    function aplicarFiltros(){
      let lista = [...proyectos];
      const estadoSel    = selectEstado.value;
      const provinciaSel = selectProvincia.value;
      const encajeSel    = selectEncaje.value;

      if(estadoSel!=="Todos"){
        lista = lista.filter(p=>(p.estado||"")===estadoSel);
      }
      if(provinciaSel!=="Todas"){
        lista = lista.filter(p=>(p.provincia||"")===provinciaSel);
      }
      if(encajeSel!=="Todos"){
        lista = lista.filter(p=>{
          const e=(p.encaje_2n||"").toString().toUpperCase().trim();
          if(encajeSel==="SIN") return !["ALTO","MEDIO","BAJO"].includes(e);
          return e===encajeSel;
        });
      }
      if(filtroTexto){
        const txt=filtroTexto;
        lista=lista.filter(p=>{
          const blob=[
            p.nombre_obra,p.nombre,p.cliente_principal,
            p.promotora,p.constructora,p.ciudad,p.provincia
          ].join(" ");
          return norm(blob).includes(txt);
        });
      }
      return lista;
    }

    function aplicarFiltrosYRender(){
      const lista = aplicarFiltros();
      renderKPIs(lista);
      renderLista(lista);
    }

    function renderKPIs(lista){
      const totalFilt = lista.length;
      const encajeAM = lista.filter(p=>{
        const e=(p.encaje_2n||"").toString().toUpperCase().trim();
        return e==="ALTO"||e==="MEDIO";
      }).length;

      kpiProyFiltrados.textContent = totalFilt||0;
      kpiProyEncaje.textContent    = encajeAM||0;

      if(!proyectos.length){
        textoResumen.textContent="No hay proyectos.";
        return;
      }
      textoResumen.textContent =
        `Total: ${proyectos.length} ¬∑ Filtrados: ${totalFilt}`;
    }

    function renderLista(lista){
      listaProyectos.innerHTML="";
      if(!lista.length){
        listaProyectos.innerHTML =
          '<div style="font-size:10px;color:#6b7280;">No hay proyectos con estos filtros.</div>';
        return;
      }
      lista.sort((a,b)=>ms(b.fecha_actualizacion||b.fecha)-ms(a.fecha_actualizacion||a.fecha));
      lista.forEach(p=>{
        const nombre   = p.nombre_obra||p.nombre||"Proyecto sin nombre";
        const provincia= p.provincia||p.ciudad||"";
        const estado   = p.estado||"Sin estado";
        const encaje   = (p.encaje_2n||"").toString().toUpperCase().trim()||"SIN";
        const seg      = p.segmento||p.tipo||"";
        const cliente  = p.cliente_principal||p.promotora||"";
        const fRef     = p.fecha_actualizacion||p.fecha||null;
        const fTxt     = fRef ? new Date(ms(fRef)).toLocaleDateString("es-ES"):"-";

        let claseEncaje="mobile-chip";
        if(encaje==="ALTO") claseEncaje+=" chip-prio-baja";    // verde
        else if(encaje==="MEDIO") claseEncaje+=" chip-prio-media";
        else if(encaje==="BAJO") claseEncaje+=" chip-prio-alta";

        const card=document.createElement("div");
        card.className="mobile-card";
        card.innerHTML=`
          <div class="mobile-card-header">
            <div class="mobile-card-title">${nombre}</div>
            <div class="mobile-chip">${estado}</div>
          </div>
          <div class="mobile-card-body">
            ${provincia?`<div><strong>Zona:</strong> ${provincia}</div>`:""}
            <div class="mobile-pill-row">
              <span class="${claseEncaje}">Encaje: ${encaje}</span>
              ${seg?`<span class="mobile-pill">${seg}</span>`:""}
              ${cliente?`<span class="mobile-pill">Cliente: ${cliente}</span>`:""}
            </div>
            <div class="mobile-meta">√öltima actividad: ${fTxt}</div>
          </div>`;
        listaProyectos.appendChild(card);
      });
    }

    searchInput.addEventListener("input",()=>{
      filtroTexto = norm(searchInput.value||"");
      aplicarFiltrosYRender();
    });
    selectEstado.addEventListener("change",aplicarFiltrosYRender);
    selectProvincia.addEventListener("change",aplicarFiltrosYRender);
    selectEncaje.addEventListener("change",aplicarFiltrosYRender);

    onAuthStateChanged(auth,(u)=>{
      if(!u) return location.replace("login.html");
      userEmailSpan.textContent = u.email;
      cargarProyectos();
    });
  </script>

  <script type="module" src="auth.js"></script>
</body>
</html>
