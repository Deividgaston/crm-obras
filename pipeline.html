<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM 2N – Pipeline</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <!-- NAV SUPERIOR -->
  <div class="topnav">
    <div class="logo">CRM 2N</div>

    <div class="nav-tabs">
      <div class="nav-item" onclick="location.href='index.html'">Dashboard</div>
      <div class="nav-item" onclick="location.href='proyectos.html'">Proyectos</div>
      <div class="nav-item" onclick="location.href='buscar.html'">Buscar</div>
      <div class="nav-item active" onclick="location.href='pipeline.html'">Pipeline</div>
      <div class="nav-item" onclick="location.href='clientes.html'">Clientes</div>
      <div class="nav-item" onclick="location.href='tareas.html'">Tareas</div>
      <div class="nav-item" onclick="location.href='reportes.html'">Reportes</div>
    </div>

    <input type="text" class="search-box" placeholder="(Solo UI) Buscar..." />
  </div>

  <main class="content">
    <h2 style="margin-top:0;margin-bottom:4px;color:#16325C;">Pipeline de proyectos</h2>
    <div style="font-size:12px;color:#5A6872;margin-bottom:10px;">
      Todos los proyectos empiezan en <b>Detectado</b>. Arrastra las obras entre columnas para cambiar el estado
      (Detectado → Prescripción → Oferta → Negociación → Ganado / Perdido / Paralizado).
      En la columna <b>Seguimiento</b> puedes editar las fechas y comentarios de seguimiento/tarea.
    </div>

    <!-- FILTRO RÁPIDO ARRIBA -->
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap;">
      <select id="fZona" class="select-input" style="max-width:180px;">
        <option value="Todas">Zonas: todas</option>
      </select>
      <select id="fEncaje2N" class="select-input" style="max-width:160px;">
        <option value="Todos">Encaje 2N: todos</option>
        <option value="ALTO">Encaje 2N: ALTO</option>
        <option value="MEDIO">Encaje 2N: MEDIO</option>
        <option value="BAJO">Encaje 2N: BAJO</option>
        <option value="SIN">Encaje 2N: sin dato</option>
      </select>
      <select id="fPrioridad" class="select-input" style="max-width:150px;">
        <option value="Todas">Prioridad: todas</option>
        <option value="Alta">Prioridad: Alta</option>
        <option value="Media">Prioridad: Media</option>
        <option value="Baja">Prioridad: Baja</option>
      </select>
      <input id="fTexto" class="search-input" style="max-width:220px;" placeholder="Buscar por nombre / cliente..." />
    </div>

    <!-- COLUMNS KANBAN (7 estados + columna Seguimiento) -->
    <div id="kanbanBoard" style="
        display:grid;
        grid-template-columns:repeat(8,minmax(0,1fr));
        gap:8px;
        align-items:flex-start;
        overflow-x:auto;
      ">
      <!-- Se rellena vía JS -->
    </div>
  </main>

  <!-- DIALOGO EDICIÓN SEGUIMIENTO / TAREA -->
  <dialog id="seguimientoDialog">
    <div class="modal-header">Editar seguimiento / tarea</div>
    <form id="seguimientoForm" method="dialog">
      <input type="hidden" id="segProjId" />

      <div class="form-group">
        <label style="font-size:12px;font-weight:600;color:#111827;">Proyecto</label>
        <div id="segNombreObra" style="font-size:12px;color:#374151;padding:6px 8px;border-radius:6px;background:#F9FAFB;border:1px solid #E5E7EB;"></div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label for="segFecha" style="font-size:11.5px;font-weight:600;color:#111827;">Fecha seguimiento</label>
          <input id="segFecha" type="date" />
        </div>
        <div class="form-group">
          <label for="tareaFecha" style="font-size:11.5px;font-weight:600;color:#111827;">Fecha tarea</label>
          <input id="tareaFecha" type="date" />
        </div>
      </div>

      <div class="form-group">
        <label for="segComentario" style="font-size:11.5px;font-weight:600;color:#111827;">Comentario seguimiento</label>
        <textarea id="segComentario" rows="3"></textarea>
      </div>

      <div class="form-group">
        <label for="tareaComentario" style="font-size:11.5px;font-weight:600;color:#111827;">Descripción tarea</label>
        <textarea id="tareaComentario" rows="3"></textarea>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="window.closeSegDialog()">Cancelar</button>
        <button type="submit" class="btn-primary">Guardar</button>
      </div>
    </form>
  </dialog>

  <script type="module">
    import { db } from "./firebase.js";
    import {
      collection,
      getDocs,
      updateDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const ESTADOS = [
      "Detectado",
      "En Prescripción",
      "Oferta Enviada",
      "Negociación",
      "Ganado",
      "Perdido",
      "Paralizado"
    ];
    const COLUMNAS = [...ESTADOS, "Seguimiento"];

    const zonaFilter   = document.getElementById("fZona");
    const encajeFilter = document.getElementById("fEncaje2N");
    const prioridadFilter = document.getElementById("fPrioridad");
    const textoFilter  = document.getElementById("fTexto");
    const kanbanBoard  = document.getElementById("kanbanBoard");

    // Diálogo seguimiento
    const segDialog        = document.getElementById("seguimientoDialog");
    const segForm          = document.getElementById("seguimientoForm");
    const segProjId        = document.getElementById("segProjId");
    const segNombreObra    = document.getElementById("segNombreObra");
    const segFecha         = document.getElementById("segFecha");
    const tareaFecha       = document.getElementById("tareaFecha");
    const segComentario    = document.getElementById("segComentario");
    const tareaComentario  = document.getElementById("tareaComentario");

    let proyectos = [];
    let proyectosFiltrados = [];
    let dragId = null;

    function estadoNormalizado(p) {
      const raw = (p.estado || "").toString().trim();
      if (!raw) return "Detectado";
      if (ESTADOS.includes(raw)) return raw;
      return "Detectado";
    }

    async function cargarProyectos() {
      try {
        const snap = await getDocs(collection(db, "proyectos"));
        proyectos = [];
        snap.forEach(d => proyectos.push({ id: d.id, ...d.data() }));

        inicializarFiltroZona();
        aplicarFiltros();
      } catch (err) {
        console.error("❌ Error obteniendo proyectos:", err);
        kanbanBoard.innerHTML =
          "<div style='font-size:13px;color:#B91C1C;'>Error cargando proyectos. Revisa la consola.</div>";
      }
    }

    function inicializarFiltroZona() {
      const zonas = [...new Set(
        proyectos.map(p => p.provincia).filter(Boolean)
      )].sort((a,b) => a.localeCompare(b, "es"));

      zonaFilter.innerHTML =
        '<option value="Todas">Zonas: todas</option>' +
        zonas.map(z => `<option value="${z}">${z}</option>`).join("");
    }

    function aplicarFiltros() {
      const zona = zonaFilter.value;
      const enc  = encajeFilter.value;
      const prio = prioridadFilter.value;
      const texto = (textoFilter.value || "").toLowerCase();

      proyectosFiltrados = proyectos.filter(p => {
        let ok = true;

        if (zona !== "Todas") {
          ok = ok && p.provincia === zona;
        }

        const encaje = (p.encaje_2n || "").toString().toUpperCase().trim();
        if (enc !== "Todos") {
          if (enc === "SIN") ok = ok && !encaje;
          else ok = ok && encaje === enc;
        }

        if (prio !== "Todas") {
          ok = ok && (p.prioridad || "") === prio;
        }

        if (texto) {
          const blob = [
            p.nombre_obra,
            p.cliente_principal,
            p.ciudad,
            p.provincia
          ]
            .join(" ")
            .toLowerCase();
          ok = ok && blob.includes(texto);
        }

        return ok;
      });

      pintarKanban();
    }

    function badgeEstado(estado) {
      if (!estado) return "badge detectado";
      const e = estado.toLowerCase();
      if (e === "detectado") return "badge detectado";
      if (e.includes("prescripción") || e.includes("prescripcion")) return "badge prescripcion";
      if (e.includes("oferta")) return "badge oferta";
      if (e.includes("negociación") || e.includes("negociacion")) return "badge negociacion";
      if (e === "ganado") return "badge ganado";
      if (e === "perdido") return "badge perdido";
      if (e === "paralizado") return "badge paralizado";
      return "badge detectado";
    }

    function badgeEncaje(encaje) {
      const e = (encaje || "").toString().toUpperCase().trim();
      if (e === "ALTO") return '<span class="badge ganado">ALTO</span>';
      if (e === "MEDIO") return '<span class="badge oferta">MEDIO</span>';
      if (e === "BAJO") return '<span class="badge perdido">BAJO</span>';
      return '<span class="badge detectado">SIN</span>';
    }

    function pillPrioridad(p) {
      const pr = (p.prioridad || "").toLowerCase();
      let color = "#E5E7EB";
      let text = p.prioridad || "–";
      if (pr === "alta") color = "#FCA5A5";
      else if (pr === "media") color = "#FCD34D";
      else if (pr === "baja") color = "#BBF7D0";

      return `<span style="
          display:inline-block;
          padding:1px 6px;
          border-radius:999px;
          font-size:10px;
          background:${color};
          color:#111827;
        ">${text}</span>`;
    }

    function pintarKanban() {
      kanbanBoard.innerHTML = "";

      COLUMNAS.forEach(colName => {
        const isSeguimientoCol = colName === "Seguimiento";

        const colProyectos = isSeguimientoCol
          ? proyectosFiltrados.filter(p => p.seguimiento_fecha)
          : proyectosFiltrados.filter(p => estadoNormalizado(p) === colName);

        const col = document.createElement("div");
        col.className = "kanban-column";
        col.dataset.estado = colName;
        col.style.background = "#F9FAFB";
        col.style.border = "1px solid #E5E7EB";
        col.style.borderRadius = "10px";
        col.style.padding = "6px";
        col.style.minHeight = "260px";
        col.style.display = "flex";
        col.style.flexDirection = "column";
        col.style.gap = "6px";

        col.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
            <div style="font-size:11px;font-weight:600;color:#111827;">
              ${colName}
            </div>
            <div style="font-size:10px;color:#6B7280;">
              ${colProyectos.length}
            </div>
          </div>
        `;

        const dropZone = document.createElement("div");
        dropZone.className = "kanban-dropzone";
        dropZone.style.flex = "1";
        dropZone.style.display = "flex";
        dropZone.style.flexDirection = "column";
        dropZone.style.gap = "6px";

        if (!isSeguimientoCol) {
          dropZone.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropZone.style.background = "#EFF6FF";
          });

          dropZone.addEventListener("dragleave", () => {
            dropZone.style.background = "transparent";
          });

          dropZone.addEventListener("drop", async (e) => {
            e.preventDefault();
            dropZone.style.background = "transparent";
            if (!dragId) return;

            const newEstado = col.dataset.estado;
            const proyecto = proyectos.find(p => p.id === dragId);
            if (!proyecto) return;

            const estadoActualNormalizado = estadoNormalizado(proyecto);
            if (estadoActualNormalizado === newEstado) {
              dragId = null;
              return;
            }

            try {
              await updateDoc(doc(db, "proyectos", dragId), { estado: newEstado });
              proyecto.estado = newEstado;
              aplicarFiltros();
            } catch (err) {
              console.error("❌ Error cambiando estado:", err);
              alert("Error actualizando el estado del proyecto.");
            } finally {
              dragId = null;
            }
          });
        }

        colProyectos.forEach(p => {
          const card = document.createElement("div");
          card.className = "kanban-card";
          card.dataset.id = p.id;
          card.style.borderRadius = "8px";
          card.style.border = "1px solid #E5E7EB";
          card.style.background = "#FFFFFF";
          card.style.padding = "6px 7px";
          card.style.fontSize = "11px";
          card.style.boxShadow = "0 1px 1px rgba(15,23,42,0.04)";

          const loc = [p.ciudad, p.provincia].filter(Boolean).join(" · ");
          const estNorm = estadoNormalizado(p);

          if (!isSeguimientoCol) {
            card.draggable = true;
            card.style.cursor = "grab";
          } else {
            card.draggable = false;
            card.style.cursor = "pointer";
          }

          const titleClass = isSeguimientoCol ? "seg-title" : "kanban-title";

          card.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:6px;">
              <button class="${titleClass}" data-id="${p.id}" style="
                  border:none;
                  background:none;
                  padding:0;
                  margin:0;
                  text-align:left;
                  cursor:pointer;
                  font-size:11.5px;
                  font-weight:600;
                  color:#111827;
                  flex:1;
                ">
                ${p.nombre_obra || "(Sin nombre)"}
              </button>
              ${pillPrioridad(p)}
            </div>
            <div style="font-size:10px;color:#6B7280;margin-top:2px;">
              ${p.cliente_principal || ""}${loc ? " · " + loc : ""}
            </div>
            <div style="margin-top:4px;display:flex;justify-content:space-between;align-items:center;">
              <span class="${badgeEstado(estNorm)}" style="font-size:9.5px;">${estNorm}</span>
              ${badgeEncaje(p.encaje_2n)}
            </div>
          `;

          if (!isSeguimientoCol) {
            card.addEventListener("dragstart", () => {
              dragId = p.id;
              card.style.opacity = "0.6";
            });
            card.addEventListener("dragend", () => {
              card.style.opacity = "1";
            });
          }

          dropZone.appendChild(card);
        });

        col.appendChild(dropZone);
        kanbanBoard.appendChild(col);
      });

      // Títulos columnas normales → a Proyectos (tabla)
      kanbanBoard.querySelectorAll(".kanban-title").forEach(btn => {
        btn.addEventListener("click", () => {
          window.location.href = "proyectos.html";
        });
      });

      // Títulos columna Seguimiento → modal
      kanbanBoard.querySelectorAll(".seg-title").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          openSegDialog(id);
        });
      });
    }

    function openSegDialog(id) {
      const p = proyectos.find(x => x.id === id);
      if (!p) return;

      segProjId.value = p.id;
      segNombreObra.textContent = p.nombre_obra || "";
      segFecha.value = p.seguimiento_fecha || "";
      tareaFecha.value = p.tarea_fecha || "";
      segComentario.value = p.seguimiento_comentario || "";
      tareaComentario.value = p.tarea_comentario || "";

      segDialog.showModal();
    }

    window.closeSegDialog = function () {
      segDialog.close();
    };

    segForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = segProjId.value;
      if (!id) {
        segDialog.close();
        return;
      }

      const payload = {
        seguimiento_fecha: segFecha.value || null,
        seguimiento_comentario: segComentario.value.trim(),
        tarea_fecha: tareaFecha.value || null,
        tarea_comentario: tareaComentario.value.trim()
      };

      try {
        await updateDoc(doc(db, "proyectos", id), payload);
        segDialog.close();
        await cargarProyectos();
      } catch (err) {
        console.error("❌ Error guardando seguimiento:", err);
        alert("Error guardando el seguimiento/tarea.");
      }
    });

    zonaFilter.addEventListener("change", aplicarFiltros);
    encajeFilter.addEventListener("change", aplicarFiltros);
    prioridadFilter.addEventListener("change", aplicarFiltros);
    textoFilter.addEventListener("input", aplicarFiltros);

    cargarProyectos();
  </script>
</body>
</html>
